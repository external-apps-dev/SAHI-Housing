<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>LabourNet Housing - Onboarding Tracker</title>
  <meta name="description" content="Modern, responsive dashboard to track property onboarding TAT, approvals, payments, and move-in readiness." />
  <meta name="theme-color" content="#e56344" />
  <link rel="manifest" href="assets/manifest.json" />
  <!-- Prefer SAHI PNG favicon if present; fall back to existing PNG and SVG -->
  <link rel="icon" href="assets/sahi-logo.png" type="image/png" />
  <link rel="icon" href="assets/logo-192.png" type="image/png" sizes="192x192" />
  <link rel="icon" href="assets/logo.svg" type="image/svg+xml" />
  <link rel="apple-touch-icon" href="assets/logo-192.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
  --brand-orange: #e56344; /* LabourNet orange */
  --brand-purple: #2f2633; /* LabourNet purple */
  --brand-orange-600: #d9563b;
  --brand-orange-700: #c94a30;
  --brand-purple-700: #231c25;
  /* Light theme */
  --bg: #f7f8fc;
  --panel: #ffffff;
  --panel-2: #f9fafb;
  --text: #192132;
  --muted: #6b7280;
  --border: #e6e8ef;
  --ok: #19a974;
  --warn: #f59e0b;
  --danger: #ef4444;
  --info: #2563eb;
  --shadow: 0 10px 30px rgba(14, 25, 45, 0.08);
  --shadow-lg: 0 20px 40px rgba(14, 25, 45, 0.12);
  --radius: 14px;
  --radius-sm: 10px;
  --radius-xs: 8px;
  --ring: 0 0 0 3px rgba(229, 99, 68, 0.18);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background:
        radial-gradient(1200px 600px at -10% -10%, rgba(229, 99, 68, 0.06), transparent 40%),
        radial-gradient(900px 500px at 110% -10%, rgba(47, 38, 51, 0.06), transparent 40%),
        var(--bg);
      color: var(--text);
    }

    /* Top bar */
    .topbar {
      position: sticky;
      top: 0;
      z-index: 50;
      display: grid;
      grid-template-columns: auto 1fr; /* brand | content */
      grid-template-rows: auto auto;   /* filters on top, actions beneath */
      grid-template-areas:
        "brand filters"
        "brand actions";
      gap: 10px 16px;
      align-items: center;
      padding: 12px 16px;
      background: linear-gradient(180deg, #111827, #0b1220);
      color: #e5e7eb;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      box-shadow: 0 8px 24px rgba(0,0,0,0.35);
    }

    .brand {
      grid-area: brand;
      display: flex;
      align-items: center;
      gap: 14px;
      min-width: 0; flex-wrap: wrap;
    }
    .brand .logo {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 36px;
    }
    .brand .logo svg, .brand .logo img { height: 32px; display: block; }
  .brand .divider { width: 1px; height: 34px; background: rgba(255,255,255,0.12); }
  .brand .title { font-weight: 700; letter-spacing: 0.2px; color: #e5e7eb; }
    .brand .byline {
      margin-left: 12px;
      padding-left: 12px;
      border-left: 1px solid rgba(255,255,255,0.12);
      font-family: 'Poppins', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, Helvetica, sans-serif;
      font-weight: 700; font-size: 12px; letter-spacing: .2px;
      background: linear-gradient(90deg, #ffd6c6, #ff9f6e, #b9d8ff);
      -webkit-background-clip: text; background-clip: text; color: transparent;
  white-space: nowrap; opacity: .9;
    }

  .filters { grid-area: filters; }
    .actions {
      grid-area: actions;
      display: flex; gap: 10px; align-items: center; flex-wrap: wrap;
    }

    .btn {
      appearance: none; border: 1px solid var(--border);
      background: linear-gradient(180deg, #ffffff 0%, #f7f8fc 100%);
      color: var(--text);
      border-radius: 10px;
      padding: 9px 13px; cursor: pointer; font-weight: 700;
      transition: transform .08s ease, box-shadow .2s ease, border-color .2s ease, background .2s ease;
    }
    .btn:hover { transform: translateY(-1px); box-shadow: var(--shadow); border-color: #d7dae4; }
    .btn:active { transform: translateY(0); }
    .btn.primary { border-color: transparent; background: linear-gradient(180deg, var(--brand-orange) 0%, var(--brand-orange-600) 100%); color: white; box-shadow: 0 10px 20px rgba(229, 99, 68, 0.25); }
    .btn.ghost { background: transparent; }
    .btn.success { background: linear-gradient(180deg, #22c55e, #16a34a); border-color: transparent; color: white; box-shadow: 0 10px 20px rgba(34,197,94,.18); }
    .btn.warn { background: linear-gradient(180deg, #fbbf24, #f59e0b); border-color: transparent; color: #1f2937; box-shadow: 0 10px 20px rgba(245,158,11,.18); }
    .btn.danger { background: linear-gradient(180deg, #ef4444, #dc2626); border-color: transparent; color: white; box-shadow: 0 10px 20px rgba(239,68,68,.18); }

    /* Layout */
    .container {
      padding: 18px; max-width: 1440px; margin: 0 auto;
    }

    /* Summary cards */
    .cards {
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-top: 12px;
    }
    @media (max-width: 1100px) { .cards { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 640px) { .cards { grid-template-columns: 1fr; } }
    @media (max-width: 420px) { .cards { grid-template-columns: 1fr; gap: 12px; } .card { padding: 14px; min-height: 96px; } }
    .card {
      background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
      min-height: 110px;
      animation: rise-in 0.32s ease both;
      transition: transform .18s ease, box-shadow .22s ease, border-color .22s ease;
    }
    .card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); border-color: #d7dae4; }
    .card h3 { margin: 0; font-size: 14px; color: var(--muted); font-weight: 600; }
    .card .value { font-size: 28px; font-weight: 800; margin-top: 8px; letter-spacing: 0.3px; }
    .sub { color: var(--muted); font-size: 12px; }
    .sparkline { position: absolute; right: 8px; bottom: 6px; opacity: 0.18; }

    /* Filters */
  .filters { display: grid; grid-template-columns: 1fr auto auto auto auto auto auto; gap: 10px; margin: 6px 0 6px; align-items: center; background: linear-gradient(180deg, #121a2b, #0f172a); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 10px; box-shadow: 0 10px 26px rgba(0,0,0,0.22); position: relative; color: #e5e7eb; }
  @media (max-width: 1100px) { .filters { grid-template-columns: 1fr 1fr 1fr; } }
  @media (max-width: 820px) {
    .topbar { grid-template-columns: 1fr; grid-template-areas: "brand" "filters" "actions"; align-items: start; }
    .brand { align-items: flex-start; gap: 10px; }
    .filters { grid-template-columns: 1fr 1fr; gap: 8px; }
    .actions { padding-top: 0; }
  }
  @media (max-width: 640px) {
    .filters { grid-template-columns: 1fr; }
    .actions > div { width: 100%; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .actions > div > .btn.sync-cta { grid-column: span 2; }
    .actions #fbStatus, .actions #fbLastSynced { grid-column: span 2; }
  }
  /* removed accent/label for minimalist look */
  .input, select, input[type="date"], input[type="time"], input[type="datetime-local"] { width: 100%; border-radius: var(--radius-xs); border: 1px solid var(--border); background: #ffffff; color: var(--text); padding: 10px 12px; transition: box-shadow .15s ease, border-color .15s ease, background .2s ease; }
    .input:focus, select:focus, input[type="date"]:focus, input[type="time"]:focus, input[type="datetime-local"]:focus { outline: none; border-color: rgba(229,99,68,0.6); box-shadow: var(--ring); }
    /* Ensure readonly inputs render text with full contrast across browsers */
    .input[readonly] {
      color: var(--text);
      -webkit-text-fill-color: var(--text);
      opacity: 1;
    }
    .filters select { min-width: 160px; }
  select option { background: #fff; color: var(--text); }
    .filters .btn.active { background: linear-gradient(180deg, #2f8cff, #1e6ed8); border-color: transparent; color: #fff; }
    .legend { display: flex; gap: 8px; align-items: center; color: var(--muted); font-size: 12px; }
  .legend .pill { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); }
  .pill.overdue { background: #fee2e2; color: #991b1b; }
  .pill.soon { background: #fef9c3; color: #854d0e; }
  .pill.count { background: #f1f5f9; color: #192132; }
    .input::placeholder { color: #8d93a0; }

    /* Table */
  .table-wrap { background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%); border: 1px solid var(--border); border-radius: var(--radius); overflow: auto; box-shadow: var(--shadow); }
  /* Action shelf */
    .actions { background: linear-gradient(180deg, #121a2b, #0f172a); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 10px; box-shadow: 0 10px 26px rgba(0,0,0,0.22); position: relative; margin-top: 6px; color: #e5e7eb; }
    /* Topbar dark inputs/selects */
    .topbar .filters .input,
    .topbar .filters select,
    .topbar .filters input[type="date"],
    .topbar .filters input[type="time"],
    .topbar .filters input[type="datetime-local"] {
      background: #0b1220;
      color: #e5e7eb;
      border-color: rgba(255,255,255,0.16);
    }
    .topbar .filters .input::placeholder,
    .topbar .filters input::placeholder { color: rgba(229,231,235,0.6); }
    .topbar select option { background: #111827; color: #e5e7eb; }
    .topbar .legend { color: rgba(229,231,235,0.8); }
    /* Buttons on dark shelves */
    .topbar .actions .btn,
    .topbar .filters .btn {
      background: linear-gradient(180deg, #151f33, #0f172a);
      color: #e5e7eb;
      border-color: rgba(255,255,255,0.16);
    }
    .topbar .actions > div { flex-wrap: wrap; }
    .topbar .actions #fbStatus, .topbar .actions #fbLastSynced { display: inline-flex; align-items: center; margin-top: 6px; }
    .topbar .actions .btn.ghost,
    .topbar .filters .btn.ghost { background: transparent; border-color: rgba(255,255,255,0.16); color: #e5e7eb; }
    .topbar .actions .btn.primary { background: linear-gradient(180deg, var(--brand-orange), var(--brand-orange-600)); color:#fff; border-color: transparent; box-shadow: 0 14px 26px rgba(229,99,68,0.25); }
    .topbar .actions .btn.danger { background: linear-gradient(180deg, #ef4444, #dc2626); color:#fff; border-color: transparent; box-shadow: 0 14px 26px rgba(239,68,68,0.22); }
    .topbar .actions .btn:hover, .topbar .filters .btn:hover { border-color: rgba(255,255,255,0.28); }
  /* Firebase status badge styles */
  .topbar .badge { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; border:1px solid transparent; font-weight:800; font-size:12px; letter-spacing:.02em; }
  .topbar .badge.ok { background: rgba(34,197,94,.25); color:#dcfce7; border-color: rgba(34,197,94,.45); }
  .topbar .badge.err { background: rgba(239,68,68,.25); color:#fecaca; border-color: rgba(239,68,68,.45); }
  .topbar .badge.neutral { background: rgba(245,158,11,.25); color:#fde68a; border-color: rgba(245,158,11,.45); }
  /* Emphasized Sync button */
  .topbar .btn.sync-cta { background: linear-gradient(180deg, #22c55e, #16a34a); border-color: transparent; color:#fff; box-shadow: 0 14px 26px rgba(34,197,94,.28); }
  .topbar .btn.sync-cta:hover { box-shadow: 0 18px 32px rgba(34,197,94,.34); }
  .topbar .btn.sync-cta:disabled { opacity: .6; filter: grayscale(.2); cursor: not-allowed; box-shadow: none; }
  /* Inputs and selects: subtle hover */
  .input:hover, select:hover, input[type="date"]:hover, input[type="time"]:hover, input[type="datetime-local"]:hover { border-color: #d1d5db; }
  @media (max-width: 480px) {
    .topbar { overflow-x: hidden; }
    .topbar .filters { overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 12px; }
    .brand .title { font-size: 15px; }
    .topbar .actions .btn { padding: 10px 12px; }
  }
  /* Button focus and hover accents */
  .btn:focus { outline: none; box-shadow: var(--ring); border-color: rgba(229,99,68,0.6); }
  .btn.primary:hover { box-shadow: 0 12px 26px rgba(229, 99, 68, 0.28); }
    table { width: 100%; border-collapse: collapse; }
  thead th { position: sticky; top: 0; background: #f3f4f6; border-bottom: 1px solid var(--border); color: #1f2937; text-align: left; font-size: 12px; font-weight: 800; padding: 12px; letter-spacing: .04em; text-transform: uppercase; }
  tbody td { padding: 12px; border-bottom: 1px solid #eef0f5; vertical-align: top; color: #374151; }
  tbody tr:hover { background: #fafbff; }
  .chip { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px; font-weight: 800; font-size: 11px; letter-spacing: .02em; border: 1px solid var(--border); }
  .chip.ok { background: rgba(34, 197, 94, .10); color: #166534; border-color: rgba(34, 197, 94, .25); }
  .chip.warn { background: rgba(245, 158, 11, .10); color: #92400e; border-color: rgba(245, 158, 11, .25); }
  .chip.danger { background: rgba(239, 68, 68, .10); color: #991b1b; border-color: rgba(239, 68, 68, .25); }
  .chip.info { background: rgba(37, 99, 235, .10); color: #1e3a8a; border-color: rgba(37, 99, 235, .25); }
    .chip.overdue { background: rgba(255, 107, 107, .15); color: #ffb0b0; border-color: rgba(255, 107, 107, .4); }
    .chip.soon { background: rgba(241, 196, 15, .15); color: #ffe9a6; border-color: rgba(241, 196, 15, .4); }
    .muted { color: var(--muted); }

    .progress {
      width: 100%; height: 8px; background: #eef2ff; border-radius: 999px; overflow: hidden; border: 1px solid var(--border);
    }
    .progress > span { display: block; height: 100%; background: linear-gradient(90deg, var(--brand-orange) 0%, #ff9a66 100%); transition: width .4s cubic-bezier(.2,.8,.2,1); }

    .row-actions { display: inline-flex; gap: 8px; align-items: center; white-space: nowrap; }
    .tat-cell.overdue { color: #ff9a9a; font-weight: 800; }
    .tat-cell.soon { color: #ffd666; font-weight: 700; }
  .link-id { background: none; border: none; color: #2563eb; cursor: pointer; font-weight: 800; padding: 0; }
    .link-id:hover { text-decoration: underline; }

  /* Proofs */
  .proofs-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; }
  .proof-card { border: 1px solid var(--border); border-radius: 8px; padding: 8px; background:#ffffff; display:flex; flex-direction:column; gap:6px; box-shadow: var(--shadow); }
  .proof-thumb { width: 100%; height: 120px; object-fit: cover; border-radius: 6px; background:#f3f4f6; display:block; }
  .proof-meta { font-size: 12px; color:#6b7280; line-height:1.2; word-break: break-all; }
  .proof-actions { display:flex; gap:6px; }
  .proof-actions .btn { padding:4px 8px; font-size:12px; }

    /* Drawer */
    .drawer {
      position: fixed; top: 0; right: 0; width: min(880px, 100%); height: 100%; background: linear-gradient(180deg, var(--panel) 0%, #ffffff 120%);
      border-left: 1px solid var(--border);
      box-shadow: -20px 0 60px rgba(16,24,40,0.10);
      transform: translateX(100%); transition: transform .28s ease; z-index: 80; display: grid; grid-template-rows: auto 1fr auto;
    }
    .drawer.open { transform: translateX(0); }
  .drawer header { display: flex; align-items: center; justify-content: space-between; padding: 16px; border-bottom: 1px solid var(--border); background: #ffffff; position: sticky; top: 0; z-index: 1; }
    .drawer main { overflow: auto; padding: 16px; }
  .drawer footer { padding: 12px 16px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: space-between; align-items: center; background: #ffffff; }
  .grid-2 { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px; }
  .grid-3 { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 12px; }
    @media (max-width: 820px) { .grid-2, .grid-3 { grid-template-columns: 1fr; } }
    .field { display: grid; gap: 8px; }
    .field label { font-size: 12px; color: var(--muted); }
    textarea.input { min-height: 80px; resize: vertical; }

  /* Request form emphasis: darker + bolder text for fields and sections */
  #requestForm { color: #0f172a; }
  #requestForm .field label { color: #0b1220; font-weight: 700; }
  #requestForm .input,
  #requestForm select,
  #requestForm input[type="date"],
  #requestForm input[type="time"],
  #requestForm input[type="datetime-local"],
  #requestForm textarea { color: #0f172a; font-weight: 600; }
  #requestForm .input::placeholder,
  #requestForm textarea::placeholder { color: #475569; font-weight: 500; }
  /* Keep readonly values strong and dark as well */
  #requestForm .input[readonly],
  #requestForm input[readonly],
  #requestForm textarea[readonly] { color: #0f172a !important; -webkit-text-fill-color: #0f172a !important; opacity: 1; }
  /* Section headings inside the drawer */
  #requestForm h3, #requestForm h4 { color: #0b1220 !important; font-weight: 800; }

  /* Approvals section emphasis */
  #approvalsSection { color: #0f172a; }
  #approvalsSection .card h3 { color: #0b1220 !important; font-weight: 800; }
  #approvalsSection .field label { color: #0b1220; font-weight: 700; }
  #approvalsSection .input,
  #approvalsSection select,
  #approvalsSection input[type="date"],
  #approvalsSection input[type="time"],
  #approvalsSection input[type="datetime-local"],
  #approvalsSection textarea { color: #0f172a; font-weight: 600; }
  #approvalsSection .input::placeholder,
  #approvalsSection textarea::placeholder { color: #475569; font-weight: 500; }
  #approvalsSection .input[readonly],
  #approvalsSection input[readonly],
  #approvalsSection textarea[readonly] { color: #0f172a !important; -webkit-text-fill-color: #0f172a !important; opacity: 1; }

    /* Stepper */
    .stepper { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin: 6px 0 12px; }
    .step {
      background: #f9fafb; border: 1px dashed #e6e8ef; border-radius: 10px; padding: 8px; display: grid; gap: 6px; position: relative;
    }
    .step.done { border-style: solid; border-color: rgba(34, 197, 94, .35); background: linear-gradient(180deg, rgba(34, 197, 94, .10), rgba(34, 197, 94, .05)); }
    .step.active { border-color: rgba(37,99,235,.45); box-shadow: inset 0 0 0 1px rgba(37,99,235,.25); }
    .step h4 { margin: 0; font-size: 12px; color: #1f2937; }
    .step .small { font-size: 11px; color: var(--muted); }

    /* Toast */
  .toast { position: fixed; left: 50%; transform: translateX(-50%); bottom: 24px; background: #ffffff; border: 1px solid var(--border); color: #111827; padding: 12px 16px; border-radius: 12px; box-shadow: var(--shadow); opacity: 0; pointer-events: none; transition: opacity .25s ease, transform .25s ease; z-index: 120; }
    .toast.show { opacity: 1; pointer-events: auto; transform: translateX(-50%) translateY(-6px); }

  /* Pin Modal */
  .modal { position: fixed; inset: 0; background: rgba(0,0,0,.45); display: none; align-items: center; justify-content: center; z-index: 130; }
  .modal.open { display: flex; }
  .modal .panel { width: min(420px, 92vw); background: linear-gradient(180deg, #ffffff, #fbfbfe); border: 1px solid var(--border); border-radius: 12px; box-shadow: var(--shadow-lg); overflow: hidden; }
  .modal .panel header, .modal .panel main, .modal .panel footer { padding: 14px 16px; }
  .modal .panel header { border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
  .modal .panel footer { border-top: 1px solid var(--border); display:flex; gap:10px; justify-content: flex-end; }

    /* Empty */
    .empty { text-align: center; padding: 30px; color: var(--muted); }

  .kbd { border: 1px solid var(--border); border-bottom-width: 2px; padding: 0 6px; border-radius: 6px; background: #f8fafc; color: #192132; font-weight: 700; font-size: 11px; }

  /* Simple spinner for connecting state */
  @keyframes spin { to { transform: rotate(360deg); } }
  .spinner { display:inline-block; width:14px; height:14px; border:2px solid rgba(229,231,235,0.4); border-top-color: var(--brand-orange); border-radius:50%; margin-left:8px; vertical-align:-2px; animation: spin .8s linear infinite; }

    /* Modal Timeline */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,.6); display: grid; place-items: center; opacity: 0; pointer-events: none; transition: opacity .2s ease; z-index: 140; }
    .modal.open { opacity: 1; pointer-events: auto; }
  .modal .panel { width: min(820px, 96vw); max-height: 86vh; overflow: auto; background: linear-gradient(180deg, #ffffff, #fbfbfe); border: 1px solid var(--border); border-radius: 14px; box-shadow: var(--shadow-lg); }
  .modal header { display: flex; justify-content: space-between; align-items: center; padding: 12px 14px; border-bottom: 1px solid var(--border); position: sticky; top: 0; background: #ffffff; z-index: 2; }
    .modal main { padding: 14px; display: grid; gap: 14px; }
    .v-timeline { position: relative; margin-left: 8px; padding-left: 18px; }
  .v-timeline::before { content: ""; position: absolute; left: 10px; top: 0; bottom: 0; width: 2px; background: var(--border); }
  .v-item { position: relative; margin: 14px 0; padding: 10px 12px; background: #ffffff; border: 1px solid var(--border); border-radius: 10px; }
    .v-item::before { content: ""; position: absolute; left: -2px; top: 16px; width: 12px; height: 12px; border-radius: 50%; background: var(--brand-orange); box-shadow: 0 0 0 3px rgba(229,99,68,.25); }
    .v-item.done::before { background: #2ecc71; box-shadow: 0 0 0 3px rgba(46,204,113,.25); }
    .v-item.pending::before { background: #f1c40f; box-shadow: 0 0 0 3px rgba(241,196,15,.25); }
    .v-item .row { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .v-item .label { font-weight: 800; color: #e1e5ee; }
  .v-item .date { font-weight: 700; color: #192132; background: #f9fafb; border: 1px solid var(--border); padding: 4px 8px; border-radius: 8px; }
    .v-item .dur { color: #9cc8ff; font-weight: 700; }
    .v-item .to-next { color: #ffc97a; font-weight: 800; }
    .v-item .step-link { color: #b9d8ff; cursor: pointer; text-decoration: underline; }
  .btn.email-accent { background:#1d4ed8; color:#fff; border:1px solid #1e40af; }
  .btn.email-accent:hover { background:#1e40af; }
  .btn.email-accent:active { background:#1e3a8a; }
    .grid-2-eq { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 720px) { .grid-2-eq { grid-template-columns: 1fr; } }
    /* Responsive top bar stacking to prevent overlaps */
    @media (max-width: 1100px) {
      .topbar { grid-template-columns: 1fr; align-items: start; }
      .filters { width: 100%; }
    }
    @media (max-width: 720px) {
      .brand .byline { display: none; }
    }
    /* Prevent input/text overlap in grids */
    .field, .input, select, input[type="date"], input[type="time"], input[type="datetime-local"] { min-width: 0; }

    /* Ensure datetime/time fields show full time without horizontal scrolling */
    input[type="datetime-local"],
    input[type="time"] {
      min-width: min(24ch, 100%); /* avoid overflow in narrow columns */
      max-width: 100%;
      font-variant-numeric: tabular-nums;
    }
    tbody td { word-break: break-word; }

    /* Mobile responsiveness: enable horizontal scroll and simplify columns */
    @media (max-width: 900px) {
      .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; overscroll-behavior: contain; }
    }
    @media (max-width: 720px) {
      /* Hide less-critical columns on very small screens: Stage(6), TAT→Next(8), Age(9), Progress(10) */
      thead th:nth-child(6), thead th:nth-child(8), thead th:nth-child(9), thead th:nth-child(10) { display: none; }
      tbody td:nth-child(6), tbody td:nth-child(8), tbody td:nth-child(9), tbody td:nth-child(10) { display: none; }
    }
    @media (max-width: 560px) {
      /* Further condense: hide Request Date(4) and Beds(5) */
      thead th:nth-child(4), thead th:nth-child(5) { display: none; }
      tbody td:nth-child(4), tbody td:nth-child(5) { display: none; }
    }
    @media (max-width: 440px) {
      /* Ultra-compact: optionally hide Client(3) to keep ID, Requestor, Status, Actions visible */
      thead th:nth-child(3) { display: none; }
      tbody td:nth-child(3) { display: none; }
    }

    /* Improve tap targets and spacing on phones */
    @media (max-width: 640px), (pointer: coarse) {
      .btn { padding: 12px 14px; }
      .filters { gap: 8px; }
      .brand .title { font-size: 16px; }
      /* Avoid iOS zoom-on-focus by ensuring inputs are >=16px */
      .input, select, input[type="date"], input[type="time"], input[type="datetime-local"] { font-size: 16px; }
    }

    /* Respect device safe areas (iOS notches) */
    @supports (padding: max(0px)) {
      .topbar { padding-top: max(12px, calc(12px + env(safe-area-inset-top))); padding-bottom: max(12px, calc(12px + env(safe-area-inset-bottom))); }
      body { padding-left: env(safe-area-inset-left); padding-right: env(safe-area-inset-right); }
    }

    /* Error banner inside drawer */
  .error-banner { display: none; margin: 12px 16px 0; padding: 10px 12px; border-radius: 10px; border: 1px solid #fca5a5; background: #fff1f1; color: #991b1b; font-weight: 700; }
    .error-banner.show { display: block; }

  /* Info banner inside drawer */
  .info-banner { display: none; margin: 12px 16px 0; padding: 10px 12px; border-radius: 10px; border: 1px solid #93c5fd; background: #eff6ff; color: #1e3a8a; font-weight: 600; }
    .info-banner.show { display: block; }

    /* Settings modal */
    .settings-form .field { margin-bottom: 8px; }
    .settings-form small { color: var(--muted); }

  /* Lock overlay for sections gated by Finance Head approval */
  .lock-wrap { position: relative; }
  .lock-wrap.locked { filter: grayscale(0.2) opacity(0.8); }
  .lock-wrap .lock-overlay { display: none; position: absolute; inset: 0; background: rgba(255,255,255,0.72); z-index: 5; color: #111827; font-weight: 800; text-align: center; padding: 16px; pointer-events: none; }
  .lock-wrap .lock-overlay .msg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #ffffff; border: 1px solid var(--border); border-radius: 12px; padding: 12px 16px; box-shadow: var(--shadow); }
  .lock-wrap.locked .lock-overlay { display: block; }

    /* Print styles: print timeline only when printing while modal open */
    @media print {
      body * { visibility: hidden !important; }
      #timelineModal, #timelineModal * { visibility: visible !important; }
      #timelineModal { position: fixed; inset: 0; }
    }

    /* Intro Overlay */
    #introOverlay {
      position: fixed; inset: 0; z-index: 9999; display: grid; place-items: center; overflow: hidden;
      background: radial-gradient(1200px 600px at -10% -10%, rgba(229, 99, 68, 0.10), transparent 40%),
                  radial-gradient(900px 500px at 110% -10%, rgba(47, 38, 51, 0.10), transparent 40%),
                  linear-gradient(180deg, #0b1220, #0a0f1c 30%, #080c16);
      color: #e5e7eb;
      transition: opacity .6s ease, transform .6s ease;
    }
    #introOverlay.out { opacity: 0; transform: translateY(-12px); pointer-events: none; }
    #introOverlay .intro-bg { position: absolute; inset: -20%; filter: blur(18px) saturate(1.15); opacity: 0.9; }
    #introOverlay .orb { position: absolute; width: 42vmax; height: 42vmax; border-radius: 40% 60% 55% 45% / 40% 40% 60% 60%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.18), transparent 55%),
                  radial-gradient(circle at 70% 70%, rgba(255,255,255,.08), transparent 55%),
                  linear-gradient(135deg, rgba(229,99,68,.55), rgba(47,38,51,.55));
      mix-blend-mode: screen; animation: orbFloat 18s ease-in-out infinite alternate, orbMorph 22s ease-in-out infinite alternate;
    }
    #introOverlay .orb.orb-a { left: -8%; top: -6%; animation-delay: 0s, -4s; }
    #introOverlay .orb.orb-b { right: -12%; bottom: -10%; animation-delay: -2s, -8s; }
    #introOverlay .orb.orb-c { left: 35%; top: 40%; width: 28vmax; height: 28vmax; animation-delay: -6s, -12s; }
    @keyframes orbFloat { 0% { transform: translate3d(0,0,0) rotate(0deg) scale(1); } 100% { transform: translate3d(6%, -5%, 0) rotate(15deg) scale(1.06); } }
    @keyframes orbMorph { 0% { border-radius: 40% 60% 55% 45% / 40% 40% 60% 60%; } 100% { border-radius: 60% 40% 45% 55% / 55% 45% 55% 45%; } }

    #introOverlay .rings { position: absolute; inset: 0; pointer-events: none; opacity: .35; }
    #introOverlay .rings::before, #introOverlay .rings::after {
      content: ""; position: absolute; left: 50%; top: 50%; width: 140vmax; height: 140vmax; transform: translate(-50%, -50%);
      border: 1px solid rgba(255,255,255,0.08); border-radius: 50%; animation: ringPulse 6s ease-in-out infinite;
    }
    #introOverlay .rings::after { width: 90vmax; height: 90vmax; animation-delay: 1.2s; }
    @keyframes ringPulse { 0%,100% { transform: translate(-50%, -50%) scale(1); opacity: .35; } 50% { transform: translate(-50%, -50%) scale(1.035); opacity: .15; } }

    #introOverlay .intro-content { position: relative; text-align: center; padding: 24px 18px; z-index: 2; }
    #introOverlay .intro-content::before { content: ""; position: absolute; inset: -18% -12%; z-index: -1; border-radius: 24px;
      background:
        radial-gradient(600px 240px at 50% 18%, rgba(8,12,22,0.85), transparent 60%),
        radial-gradient(420px 180px at 50% 65%, rgba(11,18,32,0.75), transparent 60%),
        radial-gradient(300px 140px at 50% 52%, rgba(19,28,48,0.55), transparent 60%);
      filter: blur(18px);
    }
    #introOverlay .intro-logo { width: 84px; height: 84px; object-fit: contain; border-radius: 0; background: transparent; padding: 0;
      opacity: 0; transform: translateY(10px) scale(.96);
      animation: fadeUp .8s cubic-bezier(.2,.8,.2,1) .05s forwards; }
    @keyframes fadeUp { to { opacity: 1; transform: translateY(0) scale(1); } }

    #introOverlay .intro-title { margin: 10px 0 4px; font-family: 'Poppins', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, Helvetica, sans-serif;
      font-weight: 800; line-height: 1.05; letter-spacing: .3px; font-size: clamp(22px, 4.2vw, 46px);
      background: linear-gradient(90deg, #ffffff, #ffd6c6, #ff9f6e, #ffffff); -webkit-background-clip: text; background-clip: text; color: transparent;
      background-size: 200% 100%; animation: shine 2.8s ease-in-out 1.2s both;
    }
    @keyframes shine { 0% { background-position: 0% 50%; filter: drop-shadow(0 0 0 rgba(255,255,255,0)); }
      40% { background-position: 100% 50%; filter: drop-shadow(0 8px 26px rgba(255,159,110,.18)); }
      100% { background-position: 100% 50%; filter: drop-shadow(0 10px 28px rgba(255,159,110,.22)); } }
    #introOverlay .intro-title .word { display: inline-block; opacity: 0; transform: translateY(12px) scale(.98); }
    #introOverlay.ready .intro-title .word { animation: wordIn .6s cubic-bezier(.2,.8,.2,1) forwards; }
    #introOverlay.ready .intro-title .word:nth-child(1){ animation-delay: .15s; }
    #introOverlay.ready .intro-title .word:nth-child(2){ animation-delay: .22s; }
    #introOverlay.ready .intro-title .word:nth-child(3){ animation-delay: .29s; }
    #introOverlay.ready .intro-title .word:nth-child(4){ animation-delay: .36s; }
    #introOverlay.ready .intro-title .word:nth-child(5){ animation-delay: .43s; }
    #introOverlay.ready .intro-title .word:nth-child(6){ animation-delay: .50s; }
    @keyframes wordIn { to { opacity: 1; transform: translateY(0) scale(1); } }

    #introOverlay .underline { width: 0%; height: 4px; margin: 12px auto 8px; border-radius: 999px;
      background: linear-gradient(90deg, var(--brand-orange), #ff9a66);
      box-shadow: 0 10px 24px rgba(229,99,68,.35);
    }
    #introOverlay.ready .underline { animation: draw 700ms ease-out 650ms forwards; }
    @keyframes draw { to { width: min(560px, 64vw); } }
    #introOverlay .subline { color: rgba(229,231,235,0.85); font-weight: 600; opacity: 0; transform: translateY(8px);
      animation: fadeUp .6s ease 1.1s forwards; }

    #introOverlay .intro-skip { position: absolute; right: 16px; bottom: 16px; appearance: none; cursor: pointer;
      border: 1px solid rgba(255,255,255,0.25); background: linear-gradient(180deg, #151f33, #0f172a);
      color: #e5e7eb; border-radius: 999px; padding: 8px 12px; font-weight: 700; letter-spacing: .2px;
      transition: transform .12s ease, box-shadow .2s ease, border-color .2s ease; backdrop-filter: blur(4px);
      box-shadow: 0 10px 22px rgba(0,0,0,.28);
    }
    #introOverlay .intro-skip:hover { transform: translateY(-1px); border-color: rgba(255,255,255,0.38); box-shadow: 0 16px 28px rgba(0,0,0,.34); }
    #introOverlay .intro-skip:active { transform: translateY(0); }

    /* Reduced motion accessibility */
    @media (prefers-reduced-motion: reduce) {
      #introOverlay, #introOverlay * { animation: none !important; transition: none !important; }
      #introOverlay .orb, #introOverlay .rings { display: none !important; }
      #introOverlay .underline { width: min(560px, 64vw); }
      #introOverlay .intro-logo, #introOverlay .subline, #introOverlay .intro-title .word { opacity: 1; transform: none; }
    }
  </style>
  <!-- ExcelJS for styled .xlsx export -->
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
  <!-- Firebase (Firestore) inline module: initializes app, analytics (if supported), and exposes window.FirebaseSync -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAnalytics, isSupported } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAsJQzyR6-1mmJUXGnMzlVuxp9-Amh0udc",
      authDomain: "ln-housing.firebaseapp.com",
      projectId: "ln-housing",
      storageBucket: "ln-housing.firebasestorage.app",
      messagingSenderId: "283114918616",
      appId: "1:283114918616:web:f2fa37107e1167d4567dad",
      measurementId: "G-H0YYJCLVNS"
    };

    const app = initializeApp(firebaseConfig);
    try { if (await isSupported()) { getAnalytics(app); } } catch {}
    const db = getFirestore(app);
    const dataRef = doc(db, 'ln', 'requests');

    window.FirebaseSync = {
      connected: false,
      async check() {
        try { await getDoc(dataRef); this.connected = true; return true; }
        catch { this.connected = false; return false; }
      },
      async load() {
        const snap = await getDoc(dataRef);
        if (snap.exists()) {
          const d = snap.data();
          return Array.isArray(d?.requests) ? d.requests : [];
        }
        return [];
      },
      async fetch() {
        // Returns both data and a comparable updatedAt in millis for sync logic
        const snap = await getDoc(dataRef);
        let updatedAtMillis = 0;
        let requests = [];
        if (snap.exists()) {
          const d = snap.data();
          requests = Array.isArray(d?.requests) ? d.requests : [];
          const ts = d?.updatedAt;
          if (ts && typeof ts.toMillis === 'function') {
            updatedAtMillis = ts.toMillis();
          } else if (typeof ts === 'number') {
            updatedAtMillis = ts;
          }
        }
        return { requests, updatedAtMillis };
      },
      async save(data) {
        await setDoc(dataRef, { requests: Array.isArray(data) ? data : [], updatedAt: serverTimestamp() }, { merge: true });
        return true;
      }
    };
  </script>
</head>
<body>
  <!-- Opening Intro Overlay -->
  <div id="introOverlay" aria-hidden="true">
    <div class="intro-bg">
      <div class="orb orb-a"></div>
      <div class="orb orb-b"></div>
      <div class="orb orb-c"></div>
    </div>
    <div class="rings"></div>
    <div class="intro-content">
  <!-- Inline logo to avoid missing-asset issues on GitHub Pages -->
  <svg class="intro-logo" width="84" height="84" viewBox="0 0 554 116" role="img" aria-label="labournet logo" xmlns="http://www.w3.org/2000/svg">
    <rect fill="none" width="554" height="116" />
    <g>
      <text x="20" y="84" font-size="110" font-weight="800" font-family="Inter, Segoe UI, Arial, Helvetica, sans-serif" fill="#e56344">labou</text>
      <text x="327" y="84" font-size="110" font-weight="900" font-family="Inter, Segoe UI, Arial, Helvetica, sans-serif" fill="#2f2633">net</text>
      <rect x="530" y="0" width="16" height="16" fill="#e56344" rx="2" ry="2" />
    </g>
  </svg>
      <h1 class="intro-title" aria-label="Welcome to Labournet Housing Req Form">
        <span class="word">Welcome</span>
        <span class="word">to</span>
        <span class="word">Labournet</span>
        <span class="word">Housing</span>
        <span class="word">Req</span>
        <span class="word">Form</span>
      </h1>
      <div class="underline" aria-hidden="true"></div>
  <div class="subline">Connecting to Firebase…</div>
    </div>
    <button class="intro-skip" type="button" aria-label="Skip intro">Skip</button>
  </div>
  <script>
    (function(){
      const overlay = document.getElementById('introOverlay');
      if (!overlay) return;
      const subline = overlay.querySelector('.subline');
      const skipBtn = overlay.querySelector('.intro-skip');
      // Stagger word reveal animation
      requestAnimationFrame(() => overlay.classList.add('ready'));
      // Do not allow skipping; we must connect first
      if (skipBtn) skipBtn.style.display = 'none';
      let dismissed = false;
      const dismissIntro = (immediate = false) => {
        if (dismissed) return; dismissed = true;
        overlay.setAttribute('aria-hidden', 'true');
        if (immediate) { overlay.remove(); return; }
        overlay.classList.add('out');
        setTimeout(() => { overlay.remove(); }, 650);
      };
      // Wait for Firebase to be ready and connected
      async function waitForFirebase(){
        try { overlay.tabIndex = -1; setTimeout(() => { try { overlay.focus(); } catch(_){} }, 40); } catch {}
  if (subline) { subline.textContent = 'Connecting to Firebase…'; const sp = document.createElement('span'); sp.className = 'spinner'; subline.appendChild(sp); }
        // Poll for FirebaseSync and attempt connection
        const sleep = (ms) => new Promise(r => setTimeout(r, ms));
        // Keep trying until success
        while (true) {
          try {
            if (window.FirebaseSync && typeof window.FirebaseSync.check === 'function') {
              const ok = await window.FirebaseSync.check();
              if (ok) break;
            }
          } catch {}
          await sleep(600);
        }
        if (subline) subline.textContent = 'Connected — loading…';
        setTimeout(() => dismissIntro(false), 350);
      }
      waitForFirebase();
    })();
  </script>
  <div class="topbar">
    <div class="brand" title="LabourNet - Housing Onboarding Tracker">
      <div class="logo" aria-label="labournet logo">
        <!-- Inline SVG logo to avoid asset dependency -->
        <svg width="120" height="32" viewBox="0 0 554 116" role="img" aria-label="labournet logo" xmlns="http://www.w3.org/2000/svg" style="display:block; height:32px; width:auto;">
          <rect fill="none" width="554" height="116" />
          <g>
            <text x="20" y="84" font-size="110" font-weight="800" font-family="Inter, Segoe UI, Arial, Helvetica, sans-serif" fill="#e56344">labou</text>
            <text x="327" y="84" font-size="110" font-weight="900" font-family="Inter, Segoe UI, Arial, Helvetica, sans-serif" fill="#2f2633">net</text>
            <rect x="530" y="0" width="16" height="16" fill="#e56344" rx="2" ry="2" />
          </g>
        </svg>
      </div>
      <div class="divider"></div>
      <div class="title">Housing Onboarding Tracker</div>
      <div class="byline">By: Shubham Bathwal</div>
    </div>
  <div class="filters" style="grid-area:filters;">
      <input id="searchInput" class="input" placeholder="Search by requestor, id, vendor, notes... (Ctrl+/)" />
      <select id="statusFilter">
        <option value="all">All statuses</option>
        <option value="awaiting_approvals">Pending approvals</option>
        <option value="finance_pending">Finance pending</option>
  <option value="payment_done">Closure pending</option>
        <option value="movein_ready">Move-in ready</option>
        <option value="completed">Completed</option>
      </select>
      <select id="clientFilter" title="Filter by client">
        <option value="all">All clients</option>
      </select>
      <select id="monthFilter" title="Filter by request month">
        <option value="">All months</option>
        <option value="1">Jan</option>
        <option value="2">Feb</option>
        <option value="3">Mar</option>
        <option value="4">Apr</option>
        <option value="5">May</option>
        <option value="6">Jun</option>
        <option value="7">Jul</option>
        <option value="8">Aug</option>
        <option value="9">Sep</option>
        <option value="10">Oct</option>
        <option value="11">Nov</option>
        <option value="12">Dec</option>
      </select>
      <select id="yearFilter" title="Filter by request year">
        <option value="">All years</option>
      </select>
      <input id="fromDate" type="date" />
      <input id="toDate" type="date" />
      <button class="btn ghost" id="clearFiltersBtn">Clear</button>
      <button class="btn ghost" id="chipOverdue" title="Show overdue">Overdue</button>
      <button class="btn ghost" id="chipSoon" title="Show due soon">Due Soon</button>
      <div class="legend" style="justify-self:end;">
        <span class="pill overdue">Overdue</span>
        <span class="pill soon">Due Soon</span>
      </div>
    </div>
  <div class="actions" style="grid-area:actions;">
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <button class="btn primary" id="newRequestBtn">New Request</button>
        <button class="btn" id="demoDataBtn">Load Demo Data</button>
  <!-- separator removed for cleaner look -->
        <button class="btn ghost" id="exportBtn">Export JSON</button>
        <button class="btn ghost" id="exportCsvBtn">Export CSV</button>
  <button class="btn ghost" id="importBtn" type="button">Import</button>
  <input id="importFile" type="file" accept="application/json,.xlsx,.xlsm,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" style="display:none" />
  <!-- separator removed for cleaner look -->
    <button class="btn danger" id="resetBtn" title="Clears all saved data">Reset</button>
    <button class="btn ghost" id="settingsBtn" title="SLA and preferences">Settings</button>
        <span style="width:1px; background:rgba(255,255,255,0.16); height:28px;"></span>
  <button class="btn sync-cta" id="fbSyncBtn" title="Sync current data with Firebase">Sync Data</button>
  <span id="fbStatus" class="badge neutral">Firebase: connecting…</span>
  <span id="fbLastSynced" style="color:#9ca3af; font-size:12px;">• Last sync: —</span>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="cards" id="summaryCards">
      <div class="card">
        <h3>Total Requests</h3>
        <div class="value" id="totalRequests">0</div>
        <div class="sub">Including active and completed</div>
      </div>
      <div class="card">
        <h3>Pending Approvals</h3>
        <div class="value" id="pendingApprovals">0</div>
        <div class="sub">Awaiting Suhail / Ashish / Housing Partner / Finance</div>
      </div>
      <div class="card">
        <h3>Average TAT</h3>
        <div class="value" id="avgTat">0d</div>
        <div class="sub">From Request to Move-in Ready</div>
      </div>
      <div class="card">
        <h3>Beds: Req / Appr / Final</h3>
        <div class="value" id="bedsSummary">0 / 0 / 0</div>
        <div class="sub">Male + Female breakdowns available in details</div>
      </div>
      <div class="card">
        <h3>Overdue</h3>
        <div class="value" id="overdueCount">0</div>
        <div class="sub">Based on SLA thresholds</div>
      </div>
    </div>

    <div class="table-wrap" style="margin-top:16px;">
      <table id="requestsTable">
        <thead>
          <tr>
            <th data-sort="id">ID ▲▼</th>
            <th data-sort="requestor">Requestor</th>
            <th data-sort="client">Client</th>
            <th data-sort="date">Request Date</th>
            <th>Beds (M/F/T)</th>
            <th>Stage</th>
            <th>Status</th>
            <th data-sort="tatNext">TAT → Next</th>
            <th data-sort="age">Age</th>
            <th>Progress</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr><td colspan="11" class="empty">No requests yet. Click <span class="kbd">New Request</span> or <span class="kbd">Load Demo Data</span>.</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Drawer for Request Details -->
  <section class="drawer" id="drawer" aria-hidden="true" aria-labelledby="drawerTitle">
    <header>
      <div>
        <div id="drawerTitle" style="font-weight:800;">New Request</div>
        <div class="muted" id="drawerSubtitle">Fill in request details and progress through steps</div>
      </div>
      <div>
        <button class="btn ghost" id="duplicateBtn" title="Duplicate request">Duplicate</button>
        <button class="btn" id="closeDrawerBtn">Close</button>
      </div>
    </header>
    <main>
      <div class="stepper" id="stepper">
        <div class="step" data-step="request">
          <h4>1. Request</h4>
          <div class="small" id="s1text">Pending</div>
        </div>
        <div class="step" data-step="bv">
          <h4>2. BV Head (Suhail)</h4>
          <div class="small" id="s2text">Pending</div>
        </div>
        <div class="step" data-step="sahi">
          <h4>3. SAHI Head (Ashish)</h4>
          <div class="small" id="s3text">Pending</div>
        </div>
        <div class="step" data-step="vendor">
          <h4>4. Housing Partner</h4>
          <div class="small" id="s4text">Pending</div>
        </div>
        <div class="step" data-step="finance">
          <h4>5. Finance</h4>
          <div class="small" id="s5text">Pending</div>
        </div>
      </div>

      <form id="requestForm" autocomplete="off">
        <div class="grid-3">
          <div class="field">
            <label>Requestor Name</label>
            <input class="input" id="reqRequestor" value="Girish" required readonly title="Locked to Girish" />
            <div style="margin-top:6px; display:flex; align-items:center; gap:8px;">
              <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                <input type="checkbox" id="reqNotGirish" />
                <span>Not Girish</span>
              </label>
              <small class="muted">Tick to edit name</small>
            </div>
          </div>
          <div class="field">
            <label>Date & Time of Request</label>
            <input class="input" type="datetime-local" id="reqDate" required />
          </div>
          <div class="field">
            <label>Notes</label>
            <input class="input" id="reqNotes" placeholder="Purpose, constraints..." />
          </div>
        </div>
        <div style="margin-top:8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <button type="button" class="btn email-accent" id="emailBVInlineBtn" title="Compose email to BV Head for approval">Email BV Head</button>
          <small class="muted">Opens Outlook draft to BV Head with request details (cc Benefits)</small>
        </div>
        <div class="grid-3" style="margin-top:10px;">
          <div class="field">
            <label>Client (Name - Location)</label>
            <select id="clientSelect"></select>
          </div>
          <div class="field">
            <label>Client (Other)</label>
            <input class="input" id="clientOther" placeholder="Type client name" disabled />
          </div>
          <div class="field">
            <label>Note</label>
            <small class="muted">Client is required. Select from list or choose Other to type.</small>
          </div>
        </div>
        <div class="grid-3" style="margin-top:10px;">
          <div class="field"><label>Associate Deduction / Bed / Month <span class="muted">(min 1500)</span></label><input class="input" id="reqAssocDeduction" type="number" min="1500" step="1" value="1500"></div>
          <div class="field"><label>Processing Fee / Bed <span class="muted">(One-Time Only)</span></label><input class="input" id="reqProcessingFee" type="number" min="0" step="1" value="0"></div>
          <div class="field"><label>Water + Electricity / Bed / Month</label><input class="input" id="reqWaterElec" type="number" min="0" step="1" value="0"></div>
        </div>
        <div class="grid-3" style="margin-top:10px;">
          <div class="field"><label>Total Male (auto)</label><input class="input" type="number" min="0" id="bedsMale" value="0" readonly title="Auto-calculated from weekly entries"></div>
          <div class="field"><label>Total Female (auto)</label><input class="input" type="number" min="0" id="bedsFemale" value="0" readonly title="Auto-calculated from weekly entries"></div>
          <div class="field"><label>Total Beds (auto)</label><input class="input" type="number" min="0" id="bedsTotal" value="0" readonly title="Auto-calculated as Male + Female"></div>
        </div>
        <div class="card" style="margin-top:10px; min-height:auto;">
          <h3>Proof of Requirements (optional)</h3>
          <div class="grid-3" style="margin-top:8px; align-items:end;">
            <div class="field" style="grid-column: span 2;">
              <label>Upload images/PDFs</label>
              <input class="input" id="reqProofsInput" type="file" accept="image/*,.pdf,.xlsx,.xlsm,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" multiple />
              <small class="muted">Max 2 MB per file; images/PDF only. Approvers can view these proofs.</small>
            </div>
            <div class="field">
              <label>&nbsp;</label>
              <button type="button" class="btn ghost" id="clearProofsBtn">Clear All</button>
            </div>
          </div>
          <div id="reqProofsList" class="proofs-grid" style="margin-top:8px;"></div>
        </div>
        <div style="margin-top:10px;">
          <h3 style="margin:6px 0 10px;">Weekly Breakdown (W1–W4)</h3>
          <div class="grid-2" style="margin-top:6px;">
            <div class="field"><label>W1 Male</label><input class="input" type="number" min="0" id="w1Male" value="0"></div>
            <div class="field"><label>W1 Female</label><input class="input" type="number" min="0" id="w1Female" value="0"></div>
          </div>
          <div class="grid-2" style="margin-top:6px;">
            <div class="field"><label>W2 Male</label><input class="input" type="number" min="0" id="w2Male" value="0"></div>
            <div class="field"><label>W2 Female</label><input class="input" type="number" min="0" id="w2Female" value="0"></div>
          </div>
          <div class="grid-2" style="margin-top:6px;">
            <div class="field"><label>W3 Male</label><input class="input" type="number" min="0" id="w3Male" value="0"></div>
            <div class="field"><label>W3 Female</label><input class="input" type="number" min="0" id="w3Female" value="0"></div>
          </div>
          <div class="grid-2" style="margin-top:6px;">
            <div class="field"><label>W4 Male</label><input class="input" type="number" min="0" id="w4Male" value="0"></div>
            <div class="field"><label>W4 Female</label><input class="input" type="number" min="0" id="w4Female" value="0"></div>
          </div>
        </div>
      </form>

      <hr style="border:0;border-top:1px solid var(--border);margin:18px 0;opacity:.6;" />

  <section id="approvalsSection">
        <h3 style="margin:6px 0 10px;">Approvals</h3>
  <div class="grid-2">
          <div class="card" style="min-height:auto;">
            <h3 style="color:#cfd5df">BV Head (Suhail)</h3>
            <div style="margin-top:6px;">
              <button type="button" class="btn email-accent" id="emailSAHIFromBVBtn" title="Compose email to SAHI Head for next approval">Email SAHI Head</button>
            </div>
            <div class="grid-3" style="margin-top:8px;">
              <div class="field"><label>Approved Beds (M)</label><input class="input" id="apprBVM" type="number" min="0" value="0"></div>
              <div class="field"><label>Approved Beds (F)</label><input class="input" id="apprBVF" type="number" min="0" value="0"></div>
              <div class="field"><label>Total (auto)</label><input class="input" id="apprBVTotal" type="number" min="0" value="0" readonly></div>
            </div>
            <div class="grid-3" style="margin-top:8px;">
              <div class="field"><label>Approval Date & Time</label><input class="input" id="apprBVDate" type="datetime-local" readonly title="Auto-set on approval"></div>
              <div class="field"><label>Remarks</label><input class="input" id="apprBVNotes" placeholder="optional"></div>
              <div class="field"><label>Approve</label><div><input type="checkbox" id="apprBVApprove" disabled> <small class="muted">Tick to approve (captures time, PIN required)</small></div></div>
            </div>
            
          </div>
          <div id="sahiSection" class="lock-wrap locked" aria-disabled="true">
            <div class="lock-overlay"><div class="msg">Awaiting BV Head approval</div></div>
            <div class="card" style="min-height:auto;">
            <h3 style="color:#cfd5df">SAHI Head (Ashish)</h3>
            <div style="margin-top:6px;">
              <button type="button" class="btn email-accent" id="emailVendorFromSAHIBtn" title="Compose email to Housing Partner">Email Housing Partner</button>
            </div>
            <div class="grid-3" style="margin-top:8px;">
              <div class="field"><label>Approved Beds (M)</label><input class="input" id="apprSAHIM" type="number" min="0" value="0"></div>
              <div class="field"><label>Approved Beds (F)</label><input class="input" id="apprSAHIF" type="number" min="0" value="0"></div>
              <div class="field"><label>Total (auto)</label><input class="input" id="apprSAHITotal" type="number" min="0" value="0" readonly></div>
            </div>
            <div class="grid-3" style="margin-top:8px;">
              <div class="field"><label>Approval Date & Time</label><input class="input" id="apprSAHIDate" type="datetime-local" readonly title="Auto-set on approval"></div>
              <div class="field"><label>Remarks</label><input class="input" id="apprSAHINotes" placeholder="optional"></div>
              <div class="field"><label>Approve</label><div><input type="checkbox" id="apprSAHIApprove" disabled> <small class="muted">Tick to approve (captures time, PIN required)</small></div></div>
            </div>
            
            </div>
          </div>
        </div>

        <div id="vendorSection" class="lock-wrap locked" aria-disabled="true">
          <div class="lock-overlay"><div class="msg">Awaiting SAHI Head approval</div></div>
          <div class="grid-2" style="margin-top:12px;">
            <div class="card" style="min-height:auto;">
            <h3 style="color:#cfd5df">Housing Partner - Acknowledgement & Tentative Plan</h3>
            <div class="grid-3" style="margin-top:8px;">
              <div class="field"><label>Acknowledge Request</label><div><input type="checkbox" id="vendorAck"> <small class="muted">Tick to acknowledge (PIN)</small></div></div>
              <div class="field"><label>Acknowledged On</label><input class="input" id="vendorAckDate" type="datetime-local" readonly title="Auto-set when acknowledged"></div>
              <div class="field"><label>Partner Name</label><input class="input" id="vendorName" placeholder="Vendor / Property"></div>
            </div>

            <div class="grid-3" style="margin-top:8px;">
              <div class="field"><label>Existing Capacity (M)</label><input class="input" id="vendorTentativeExistM" type="number" min="0" value="0"></div>
              <div class="field"><label>Existing Capacity (F)</label><input class="input" id="vendorTentativeExistF" type="number" min="0" value="0"></div>
              <div class="field"><label>Existing Total (auto)</label><input class="input" id="vendorTentativeExistTotal" type="number" min="0" value="0" readonly></div>
            </div>
            <div class="grid-3" style="margin-top:8px;">
              <div class="field"><label>New Properties (M)</label><input class="input" id="vendorTentativeNewM" type="number" min="0" value="0"></div>
              <div class="field"><label>New Properties (F)</label><input class="input" id="vendorTentativeNewF" type="number" min="0" value="0"></div>
              <div class="field"><label>New Total (Auto)</label><input class="input" id="vendorTentativeTotal" type="number" min="0" value="0" readonly></div>
            </div>

            <!-- (Trimmed: this card captures only Ack, Partner Name, and Tentative split) -->
            <!-- Hidden totals keep backward compatibility; values are driven by Actual Confirmation card below -->
            <input id="apprVendorM" type="number" value="0" style="display:none" readonly />
            <input id="apprVendorF" type="number" value="0" style="display:none" readonly />
            <input id="apprVendorTotal" type="number" value="0" style="display:none" readonly />
            </div>
          </div>
          <div class="card" style="min-height:auto;">
          <h3 style="color:#cfd5df">Housing Partner - Actual Confirmation & Property Details</h3>
          <div style="text-align:right;margin:-6px 0 10px 0; display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap;">
            <button class="btn email-accent" type="button" id="emailFinanceHeadBtn" title="Compose email to Finance Head">Email Finance Head</button>
            <button class="btn" type="button" id="exportFinanceExcelBtn" title="Download Finance-ready Excel">Download Finance Excel</button>
          </div>
          <!-- Compact side checklist -->
          <aside class="vendor-checklists" style="display:block;width:100%;max-width:100%;margin:4px 0 8px 0;border:1px solid var(--border);border-radius:8px;padding:12px 14px;background:var(--panel2);color:var(--text);">
            <div style="font-weight:700;margin-bottom:6px;">Checklists</div>
            <div class="vendor-checklists-grid" style="font-size:12px;line-height:1.25;display:grid;grid-template-columns:repeat(2, minmax(260px, 1fr));gap:12px 16px;align-items:start;">
              <div>
                <div style="font-weight:600;margin-bottom:4px;">Basic Features / Facilities (Must-Have)</div>
                <div style="font-weight:600;margin:6px 0 4px;">Housing Infrastructure</div>
                <label style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><input type="checkbox" id="chkMustWater"> Clean drinking water (RO/filtered)</label>
                <label style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><input type="checkbox" id="chkMustVentilation"> Fan and proper ventilation</label>
                <label style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><input type="checkbox" id="chkMustLighting"> Lighting (tube light/bulb)</label>
                <label style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><input type="checkbox" id="chkMustToilets"> Toilets & bathrooms (1 per 6–8 people)</label>
                <label style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><input type="checkbox" id="chkMustCooking"> Cooking facility or area</label>
                <label style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><input type="checkbox" id="chkMustDustbins"> Dustbins & cleanliness protocols</label>
                <label><input type="checkbox" id="chkMustHousekeeping"> Cleaning Services/Housekeeping</label>
                <div style="font-weight:600;margin:8px 0 4px;">Safety</div>
                <label style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><input type="checkbox" id="chkMustFireExt"> Fire Extinguisher in common area</label>
                <label style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><input type="checkbox" id="chkMustFirstAid"> First aid kit</label>
                <label style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><input type="checkbox" id="chkMustEmergencyContacts"> Emergency contact numbers displayed</label>
                <label style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><input type="checkbox" id="chkMustPowerBackup"> Power backup (lights) for emergency</label>
                <div style="font-weight:600;margin:8px 0 4px;">Hygiene & Waste Management</div>
                <label style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><input type="checkbox" id="chkMustCleaningRegular"> Regular cleaning of toilets/rooms</label>
                <label style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><input type="checkbox" id="chkMustGarbage"> Garbage disposal system</label>
                <label style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><input type="checkbox" id="chkMustPestControl"> Periodic pest control</label>
                <div style="font-weight:600;margin:8px 0 4px;">Others</div>
                <label style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><input type="checkbox" id="chkMustGuestRegister"> Guest register/weekend guest policy</label>
                <label style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><input type="checkbox" id="chkMustCaretaker"> Caretaker for security reasons</label>
              </div>
              <div>
                <div style="font-weight:600;margin:8px 0 4px;">Preferred Items (Good to Have)</div>
                <label style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><input type="checkbox" id="chkPrefWifi"> Wi‑Fi connectivity</label>
                <label style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><input type="checkbox" id="chkPrefWashing"> Washing machine or paid laundry</label>
                <label style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><input type="checkbox" id="chkPrefTV"> TV in common area</label>
                <label style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><input type="checkbox" id="chkPrefShelves"> Storage shelves or wall hooks</label>
                <label style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><input type="checkbox" id="chkPrefCharging"> Charging points near each bed</label>
                <label style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><input type="checkbox" id="chkPrefMess"> Mess facility (basic thali)</label>
                <label style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><input type="checkbox" id="chkPrefInduction"> Induction stove/hotplate</label>
                <label style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><input type="checkbox" id="chkPrefFridge"> Refrigerator</label>
                <label style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><input type="checkbox" id="chkPrefCCTV"> CCTV in common areas</label>
                <label style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><input type="checkbox" id="chkPrefOnsiteCaretaker"> On‑site caretaker/supervisor</label>
                <label style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><input type="checkbox" id="chkPrefRecreation"> Common recreation area</label>
                <label style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><input type="checkbox" id="chkPrefHealthCheckups"> Periodic health check‑ups</label>
                <label style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><input type="checkbox" id="chkPrefWarden"> Warden / Security</label>
                <label style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><input type="checkbox" id="chkPrefBeds"> Beds/Cot/Mattress</label>
              </div>
              <!-- filler to enable 3rd column on very wide screens by letting grid auto-flow; remove if not needed -->
              <div style="display:none"></div>
            </div>
            <style>
              /* Responsive: expand to 3 columns when there's enough space */
              @media (min-width: 1200px) {
                .vendor-checklists .vendor-checklists-grid {
                  grid-template-columns: repeat(3, minmax(260px, 1fr));
                }
              }
            </style>
          </aside>
        </div>
          
          <div class="grid-3" style="margin-top:8px;">
            <div class="field"><label>Actual via Existing (M)</label><input class="input" id="vendorActualExistM" type="number" min="0" value="0"></div>
            <div class="field"><label>Actual via Existing (F)</label><input class="input" id="vendorActualExistF" type="number" min="0" value="0"></div>
            <div class="field"><label>Total (auto)</label><input class="input" id="vendorActualExistTotal" type="number" value="0" readonly></div>
          </div>
          <div class="grid-3" style="margin-top:8px;">
            <div class="field"><label>Actual via New (M)</label><input class="input" id="vendorActualNewM" type="number" min="0" value="0"></div>
            <div class="field"><label>Actual via New (F)</label><input class="input" id="vendorActualNewF" type="number" min="0" value="0"></div>
            <div class="field"><label>Total (auto)</label><input class="input" id="vendorActualNewTotal" type="number" value="0" readonly></div>
          </div>
          <div class="grid-3" style="margin-top:8px;">
            <div class="field"><label>Grand Total Actual (M/F)</label><input class="input" id="vendorActualTotal" type="text" value="0 / 0" readonly></div>
            <div></div>
            <div></div>
          </div>

          <div class="grid-3" style="margin-top:8px;">
            <div class="field"><label>Details Shared with Finance (Date & Time)</label><input class="input" id="vendorIntimationDate" type="datetime-local" title="When actual details were sent to Finance"></div>
            <div></div>
            <div></div>
          </div>

          <div class="grid-4" style="margin-top:8px;">
            <div class="field"><label>Owner/Property Name</label><input class="input" id="propOwnerName" placeholder="Owner or Property"></div>
            <div class="field"><label>Cluster</label><input class="input" id="propCluster" placeholder="Cluster"></div>
            <div class="field"><label>State</label><input class="input" id="propState" placeholder="State"></div>
            <div class="field"><label>City/District</label><input class="input" id="propCity" placeholder="City/District"></div>
            <div class="field"><label>Client</label><input class="input" id="propClient" placeholder="Client" readonly></div>
            <div class="field"><label>Type of Accommodation</label><input class="input" id="propType" placeholder="Type"></div>
            <div class="field"><label>No. of Houses</label><input class="input" id="propHouses" type="number" min="0" value="0"></div>
            <div class="field"><label>No. of Rooms</label><input class="input" id="propRooms" type="number" min="0" value="0"></div>
            <div class="field"><label>Accommodation Capacity (Beds) (>= Actual via New (M+F), auto)</label><input class="input" id="propCapacity" type="number" min="0" value="0"></div>
          </div>
          <div class="grid-4" style="margin-top:8px;">
            <div class="field"><label>Security Deposit Amount</label><input class="input" id="propSecurityDeposit" type="number" min="0" step="0.01" value="0"></div>
            <div class="field"><label>Monthly Rent</label><input class="input" id="propMonthlyRent" type="number" min="0" step="0.01" value="0"></div>
            <div class="field"><label>Monthly Electricity</label><input class="input" id="propElec" type="number" min="0" step="0.01" value="0"></div>
            <div class="field"><label>Monthly Water</label><input class="input" id="propWater" type="number" min="0" step="0.01" value="0"></div>
            <div class="field"><label>Total Monthly Rent (auto)</label><input class="input" id="propTotalMonthlyRent" type="number" readonly></div>
            <div class="field"><label>1.5% p.m. on Security (auto)</label><input class="input" id="propSecurityInterestMonthly" type="number" readonly></div>
            <div class="field"><label>Total Landing Cost (auto)</label><input class="input" id="propLandingCostMonthly" type="number" readonly></div>
            <div class="field"><label>Cost/Bed (w/o Interest) <span class="muted">(At 80% Occupancy - <span id="propCostPerBedNoInt80">0.00</span>)</span></label><input class="input" id="propCostPerBedNoInt" type="number" readonly></div>
            <div class="field"><label>Cost/Bed (with Interest) <span class="muted">(At 80% Occupancy - <span id="propCostPerBedWithInt80">0.00</span>)</span></label><input class="input" id="propCostPerBedWithInt" type="number" readonly></div>
            <div class="field"><label>Associate Deduction / Bed / Month <span class="muted">(min 1500)</span></label><input class="input" id="propAssociateDeduction" type="number" min="1500" step="1" value="1500"></div>
            <div class="field"><label>Processing Fee / Bed <span class="muted">(One-Time Only)</span></label><input class="input" id="propProcessingFee" type="number" min="0" step="1" value="0"></div>
            <div class="field"><label>Water + Electricity / Bed / Month</label><input class="input" id="propWaterElec" type="number" min="0" step="1" value="0"></div>
          </div>

          <!-- Move Confirm (PIN) to bottom of this section -->
          <div class="grid-3" style="margin-top:10px;">
            <div class="field"><label>Agreement Date & Time</label><input class="input" id="apprVendorDate" type="datetime-local" title="Agreement date"></div>
            <div class="field"><label>Confirm Actuals</label><div><input type="checkbox" id="vendorConfirm"> <small class="muted">Tick to confirm (PIN)</small></div></div>
            <div class="field"><label>Confirmed On</label><input class="input" id="vendorActualConfirmDate" type="datetime-local" readonly></div>
          </div>
        </div>
      </section>

      <hr style="border:0;border-top:1px solid var(--border);margin:18px 0;opacity:.6;" />

      <section id="financeSection">
        <h3 style="margin:6px 0 10px;">Financial Coordination</h3>
        <div id="financeInfoBanner" class="info-banner" style="display:none;">
          Finance involvement not required because no new property on-boarded.
        </div>
  <div id="financeHeadControls" style="display:none;">
        <div class="grid-3">
          <div class="field">
            <label>Finance Head Confirmation (Mukesh Goyal)</label>
            <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
              <label><input type="checkbox" id="finFHApprove"> I Approve</label>
              <label><input type="checkbox" id="finFHReject"> I Reject</label>
              <label><input type="checkbox" id="finFHReview"> Needs Review</label>
              <small class="muted">Only one can be selected. PIN required.</small>
            </div>
          </div>
          <div class="field">
            <label>Finance Head Remarks</label>
            <input class="input" id="finFHRemarks" placeholder="Remarks (optional)">
          </div>
          <div class="field">
            <label>Decision Date & Time</label>
            <input class="input" id="finFHDate" type="datetime-local" readonly>
          </div>
        </div>
        </div>
        <div id="financeLockedArea" class="lock-wrap locked" aria-disabled="true">
          <div class="lock-overlay"><div class="msg">Can't proceed without Finance Head approval</div></div>
        <div class="grid-3">
          <div class="field"><label>Payment Confirmed to Landlord (Finance)</label><input class="input" id="finConfirmDate" type="date" title="Finance confirmed payment"><small class="muted">Must not be before Request date (if finance is required)</small></div>
          <div class="field"><label>Payment Amount</label><input class="input" id="finAmount" type="number" min="0" step="0.01" placeholder="0.00"><small class="muted">After Finance Head approval, amount is required and must be greater than 0</small></div>
          <div class="field"><label>Rental Terms</label><input class="input" id="finTerms" placeholder="e.g., Monthly, deposit 2 months"><small class="muted">Optional: describe payment terms</small></div>
        </div>
        <div class="grid-3" style="margin-top:8px;">
          <div class="field"><label>Payment TRN</label><input class="input" id="finTRN" placeholder="Transaction Reference Number"><small class="muted">Optional: enter bank transaction reference</small></div>
          <div></div>
          <div></div>
        </div>
        <div style="margin-top:8px;">
          <label class="muted" style="display:block;margin-bottom:6px;">Payment Screenshot (optional)</label>
          <input id="finPaymentProofInput" type="file" accept="image/*,application/pdf" />
          <div id="finPaymentProofsList" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:8px;"></div>
          <div style="margin-top:6px;"><button class="btn ghost" type="button" id="finClearPaymentProofsBtn">Clear Payment Proof</button></div>
        </div>
        </div>
  </section>

      <hr style="border:0;border-top:1px solid var(--border);margin:18px 0;opacity:.6;" />

      <section id="closureSection" class="lock-wrap locked" aria-disabled="true">
        <div class="lock-overlay"><div class="msg">Can't proceed without Finance Head approval</div></div>
        <h3 style="margin:6px 0 10px;">Closure</h3>
        <div class="grid-3">
          <div class="field"><label>Vendor Confirms Move-in Ready</label><input class="input" id="finalVendorReadyDate" type="date"></div>
          <div class="field">
            <label>Housing Partner Acknowledgement</label>
            <div>
              <input type="checkbox" id="finalReadyAck"> <small class="muted">I Confirm that Payment has been communicated with Landlord and Property is ready to Move-In (PIN)</small>
            </div>
          </div>
          <div class="field"><label>Acknowledged On</label><input class="input" id="finalReadyAckDate" type="datetime-local" readonly></div>
          <div class="field"><label>Additional Notes</label><input class="input" id="finalNotes" placeholder="handover details, checklist"></div>
        </div>
        <div class="grid-3" style="margin-top:8px;">
          <div class="field"><label>Associates Allocated (M)</label><input class="input" id="finalAssocM" type="number" min="0" value="0"></div>
          <div class="field"><label>Associates Allocated (F)</label><input class="input" id="finalAssocF" type="number" min="0" value="0"></div>
          <div class="field"><label>Total (auto)</label><input class="input" id="finalAssocTotal" type="number" readonly value="0"></div>
        </div>
        <div style="margin-top:8px;">
          <label class="muted" style="display:block;margin-bottom:6px;">Rental Terms Document (optional)</label>
          <input id="finalRentalTermsInput" type="file" accept="image/*,application/pdf" />
          <div id="finalRentalTermsList" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:8px;"></div>
          <div style="margin-top:6px;"><button class="btn ghost" type="button" id="finalClearRentalTermsBtn">Clear Rental Terms</button></div>
        </div>
  </section>
    </main>
    <footer>
      <div class="muted" id="drawerStatus">Status: Draft</div>
      <div style="display:flex; gap:10px;">
        <button class="btn ghost" id="deleteBtn">Delete</button>
        <button class="btn warn" id="saveBtn">Save</button>
        <button class="btn success" id="saveCloseBtn">Save & Close</button>
      </div>
    </footer>
  </section>

  <div class="toast" id="toast">Saved</div>

  <!-- PIN Modal -->
  <div class="modal" id="pinModal" aria-hidden="true" aria-labelledby="pinModalTitle">
    <div class="panel">
      <header>
        <div>
          <div id="pinModalTitle" style="font-weight:800;">Enter PIN</div>
          <div class="muted" id="pinModalSub">This action requires authorization</div>
        </div>
        <div><button class="btn" id="pinCloseBtn">Close</button></div>
      </header>
      <main>
        <div class="field">
          <label id="pinLabel">PIN</label>
          <input class="input" id="pinInput" type="password" inputmode="numeric" pattern="[0-9]*" autocomplete="one-time-code" placeholder="Enter PIN" />
        </div>
      </main>
      <footer>
        <button class="btn ghost" id="pinCancelBtn">Cancel</button>
        <button class="btn primary" id="pinOkBtn">Continue</button>
      </footer>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal" id="settingsModal" aria-hidden="true" aria-labelledby="settingsTitle">
    <div class="panel">
      <header>
        <div>
          <div id="settingsTitle" style="font-weight:800;">Settings</div>
          <div class="muted">SLA thresholds and preferences</div>
        </div>
        <div>
          <button class="btn" id="closeSettingsBtn">Close</button>
        </div>
      </header>
      <main>
        <form class="settings-form" id="settingsForm">
          <div class="grid-3">
            <div class="field"><label>SLA: Approvals (days)</label><input class="input" id="slaApprovals" type="number" min="1" value="5"><small>From Request to Vendor Agreement</small></div>
            <div class="field"><label>SLA: Payment (days)</label><input class="input" id="slaPayment" type="number" min="1" value="3"><small>From Vendor Intimation to Payment</small></div>
            <div class="field"><label>SLA: Ready (days)</label><input class="input" id="slaReady" type="number" min="1" value="7"><small>From Payment to Move-in Ready</small></div>
          </div>
          <div style="margin-top:12px; display:flex; gap:10px;">
            <button class="btn warn" type="button" id="saveSettingsBtn">Save</button>
          </div>
        </form>
      </main>
    </div>
  </div>

  <!-- Modal Timeline -->
  <div class="modal" id="timelineModal" aria-hidden="true" aria-labelledby="timelineTitle">
    <div class="panel">
      <header>
        <div>
          <div id="timelineTitle" style="font-weight:800;">Timeline</div>
          <div class="muted" id="timelineSubtitle">Request milestones and TAT</div>
        </div>
        <div>
          <button class="btn ghost" id="printTimelineBtn" title="Print timeline">Print</button>
          <button class="btn" id="closeTimelineBtn">Close</button>
        </div>
      </header>
      <main>
        <div class="grid-2-eq">
          <div>
            <div class="card" style="min-height:auto;">
              <h3>Summary</h3>
              <div id="timelineSummary" class="muted"></div>
            </div>
          </div>
          <div>
            <div class="card" style="min-height:auto;">
              <h3>Totals</h3>
              <div id="timelineTotals" class="muted"></div>
            </div>
          </div>
        </div>
        <div class="card" style="min-height:auto;">
          <h3>Milestones</h3>
          <div class="v-timeline" id="timelineList"></div>
        </div>
      </main>
    </div>
  </div>

  <script>
    // Data model and utilities
    const STORAGE_KEY = 'ln_housing_dashboard_v1';
    // Robust local persistence: IndexedDB-backed with localStorage fallback
    const LocalStore = (() => {
      let dbp = null;
      function open(){
        if (dbp) return dbp;
        dbp = new Promise((resolve, reject) => {
          try {
            const req = indexedDB.open('ln-housing', 1);
            req.onupgradeneeded = () => {
              const db = req.result;
              if (!db.objectStoreNames.contains('kv')) db.createObjectStore('kv', { keyPath: 'k' });
            };
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => reject(req.error || new Error('IndexedDB open failed'));
          } catch (e) { reject(e); }
        });
        return dbp;
      }
      async function getRequests(){
        try {
          const db = await open();
          return await new Promise((resolve, reject) => {
            const tx = db.transaction('kv', 'readonly');
            const store = tx.objectStore('kv');
            const g = store.get('requests');
            g.onsuccess = () => resolve(Array.isArray(g.result?.v) ? g.result.v : []);
            g.onerror = () => reject(g.error);
          });
        } catch {
          try { const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : []; } catch { return []; }
        }
      }
      async function setRequests(arr){
        try {
          const db = await open();
          await new Promise((resolve, reject) => {
            const tx = db.transaction('kv', 'readwrite');
            tx.oncomplete = () => resolve();
            tx.onerror = () => reject(tx.error);
            tx.objectStore('kv').put({ k: 'requests', v: Array.isArray(arr) ? arr : [], t: Date.now() });
          });
        } catch {
          // Fallback best-effort to localStorage
          try { localStorage.setItem(STORAGE_KEY, JSON.stringify(Array.isArray(arr) ? arr : [])); } catch {}
        }
      }
      async function clear(){
        try {
          const db = await open();
          await new Promise((resolve, reject) => {
            const tx = db.transaction('kv', 'readwrite');
            tx.oncomplete = () => resolve();
            tx.onerror = () => reject(tx.error);
            tx.objectStore('kv').delete('requests');
          });
        } catch {}
        try { localStorage.removeItem(STORAGE_KEY); } catch {}
      }
      return { getRequests, setRequests, clear };
    })();
  const RESET_PASSWORD = 'Shubham11';
    const SETTINGS_KEY = 'ln_housing_settings_v1';
    const CREATE_PIN = '7277';
    const state = {
      requests: [],
      sort: { key: 'id', dir: 'desc' },
  filters: { status: 'all', search: '', client: 'all', month: '', year: '', from: '', to: '' },
      selectedId: null,
      timelineForId: null,
      editPinVerified: false,
  costPinVerified: false,
  vendorChecklistPinVerified: false,
  pinCache: { create: false, bv: false, sahi: false, vendor: false, finHead: false },
  tempProofs: {},
  finPaymentProofs: {},
  finalRentalTerms: {}
    };
    const settings = { slaApprovals: 5, slaPayment: 3, slaReady: 7 };
  // Approval authority PINs
  const PIN_BV = '7278';
  const PIN_SAHI = '7279';
  const PIN_VENDOR = '7280';
  const PIN_FIN_HEAD = '7281';
  const BACKDATE_PIN = 'Shubham11';
  // Per-approval SLAs (hours)
  const SLA_BV_HOURS = 24;
  const SLA_SAHI_HOURS = 24;
  const SLA_VENDOR_TENTATIVE_HOURS = 72;
  const SLA_VENDOR_ACK_HOURS = 24; // Vendor acknowledgement within 24h of SAHI approval
  const SLA_VENDOR_ACTUAL_HOURS = 7 * 24; // Vendor Actual Confirmation within 7 days of BV Head approval (when NEW onboarding required)
  const SLA_FIN_HEAD_HOURS = 24; // Finance Head decision within 24h of Vendor Actual Confirmation
  const SLA_FIN_PAYMENT_HOURS = 3 * 24; // Finance completes payment within 3 days of Finance Head approval
  const DUE_SOON_THRESHOLD_HOURS = 6; // consider "due soon" when <= 6h left
    const CLIENTS = [
      'A.T.E. ENTERPRISES PRIVATE LIMITED-Ahmedabad',
      'ANI TECHNOLOGIES PRIVATE LIMITED-Bengaluru',
      'APOLLO SINDOORI HOTELS LIMITED-Ahmedabad',
      'APOLLO SINDOORI HOTELS LIMITED-Bengaluru',
      'APOLLO SINDOORI HOTELS LIMITED-Chennai',
      'APOLLO SINDOORI HOTELS LIMITED-Delhi',
      'APOLLO SINDOORI HOTELS LIMITED-Dhemaji',
      'APOLLO SINDOORI HOTELS LIMITED-Gautam Buddha Nagar',
      'APOLLO SINDOORI HOTELS LIMITED-Guwahati',
      'APOLLO SINDOORI HOTELS LIMITED-Kamrup',
      'APOLLO SINDOORI HOTELS LIMITED-Kolkata',
      'APOLLO SINDOORI HOTELS LIMITED-Madurai',
      'APOLLO SINDOORI HOTELS LIMITED-Mumbai',
      'APOLLO SINDOORI HOTELS LIMITED-Mysore',
      'APOLLO SINDOORI HOTELS LIMITED-New Delhi',
      'APOLLO SINDOORI HOTELS LIMITED-Tiruchirappalli',
      'APOLLO SINDOORI HOTELS LIMITED-Trichy',
      'Apollo Tyres Ltd.-Ahmedabad',
      'Apollo Tyres Ltd.-Vadodara',
      'Ather Energy Limited-Bengaluru',
      'Ather Energy Limited-Bhopal',
      'Ather Energy Limited-Chandigarh',
      'Ather Energy Limited-Chennai',
      'Ather Energy Limited-Hosur',
      'Ather Energy Limited-Kolkata',
      'Ather Energy Limited-Krishnagiri',
      'Ather Energy Limited-Lucknow',
      'Ather Energy Limited-Mumbai',
      'Ather Energy Limited-Pune',
      'Ather Energy Limited-Ulhasnagar',
      'Avians Innovations Technology Pvt. Ltd.-Chikhali',
      'Avians Innovations Technology Pvt. Ltd.-Pune',
      'AVTEC LIMITED-Bengaluru',
      'AVTEC LIMITED-Hosur',
      'AVTEC LIMITED-Krishnagiri',
      'BARODA GLOBAL SHARED SERVICES LIMITED-Bengaluru',
      'BARODA GLOBAL SHARED SERVICES LIMITED-Bharuch',
      'BARODA GLOBAL SHARED SERVICES LIMITED-Delhi',
      'BARODA GLOBAL SHARED SERVICES LIMITED-Gandhinagar',
      'BARODA GLOBAL SHARED SERVICES LIMITED-Hyderabad',
      'BARODA GLOBAL SHARED SERVICES LIMITED-Kanpur',
      'BARODA GLOBAL SHARED SERVICES LIMITED-Lucknow',
      'BARODA GLOBAL SHARED SERVICES LIMITED-Mumbai',
      'BARODA GLOBAL SHARED SERVICES LIMITED-Rajkot',
      'BARODA GLOBAL SHARED SERVICES LIMITED-Udaipur',
      'BARODA GLOBAL SHARED SERVICES LIMITED-Vadodara',
      'Belrise Industries Limited-Chennai',
      'Belrise Industries Limited-Kanchipuram',
      'Bhagwandas Retail Private Limited-Noida',
      'BHAGWATI PRODUCTS LIMITED-Firozabad',
      'BHAGWATI PRODUCTS LIMITED-Greater Noida',
      'BHAGWATI PRODUCTS LIMITED-Noida',
      'Bilva Technologies Private Limited-Bengaluru',
      'Birlasoft Limited-Bengaluru',
      'Birlasoft Limited-Chennai',
      'Birlasoft Limited-Coimbatore',
      'Birlasoft Limited-Hyderabad',
      'Birlasoft Limited-Mumbai',
      'Birlasoft Limited-Noida',
      'BUYPASSNOW PRIVATE LIMITED-Bengaluru',
      'C.M.W. PRESSINGS-Bengaluru',
      'C.M.W. PRESSINGS-Rajajinagar',
      'CII Foundation-Kandivali',
      'CNH INDUSTRIAL (INDIA) PRIVATE LIMITED-Greater Noida',
      'COMMUNICATIONS TEST DESIGN INDIA PRIVATE LIMITED-Bengaluru',
      'COMMUNICATIONS TEST DESIGN INDIA PRIVATE LIMITED-Peenya',
      'Confederation of Indian Industry-Agartala',
      'Confederation of Indian Industry-Agra',
      'Confederation of Indian Industry-Ahmedabad',
      'Confederation of Indian Industry-Almora',
      'Confederation of Indian Industry-Asansol',
      'Confederation of Indian Industry-Aurangabad',
      'Confederation of Indian Industry-Balotra',
      'Confederation of Indian Industry-Bardhaman',
      'Confederation of Indian Industry-Bengaluru',
      'Confederation of Indian Industry-Berhampore',
      'Confederation of Indian Industry-Berhampur',
      'Confederation of Indian Industry-Budge Budge',
      'Confederation of Indian Industry-Burdwan',
      'Confederation of Indian Industry-Chennai',
      'Confederation of Indian Industry-Churu',
      'Confederation of Indian Industry-Cochin',
      'Confederation of Indian Industry-Dehradun',
      'Confederation of Indian Industry-Durgapur',
      'Confederation of Indian Industry-Goa',
      'Confederation of Indian Industry-Gurgaon',
      'Confederation of Indian Industry-Gurugram',
      'Confederation of Indian Industry-Guwahati',
      'Confederation of Indian Industry-Hyderabad',
      'Confederation of Indian Industry-Jaipur',
      'Confederation of Indian Industry-Kalyani',
      'Confederation of Indian Industry-Kandivali',
      'Confederation of Indian Industry-Kannur',
      'Confederation of Indian Industry-Kochi',
      'Confederation of Indian Industry-Kolkata',
      'Confederation of Indian Industry-Kottayam',
      'Confederation of Indian Industry-Kozhikode',
      'Confederation of Indian Industry-Lucknow',
      'Confederation of Indian Industry-Malappuram',
      'Confederation of Indian Industry-Mumbai',
      'Confederation of Indian Industry-Nahan',
      'Confederation of Indian Industry-Palakkad',
      'Confederation of Indian Industry-Palghar',
      'Confederation of Indian Industry-Panchkula',
      'Confederation of Indian Industry-Patan',
      'Confederation of Indian Industry-Patna',
      'Confederation of Indian Industry-Pithampur',
      'Confederation of Indian Industry-Pune',
      'Confederation of Indian Industry-Santalpur',
      'Confederation of Indian Industry-Shillong',
      'Confederation of Indian Industry-Sibsagar',
      'Confederation of Indian Industry-Siliguri',
      'Confederation of Indian Industry-Sindhudurg',
      'Confederation of Indian Industry-Sri City',
      'Confederation of Indian Industry-Thiruvananthapuram',
      'Confederation of Indian Industry-Trivandrum',
      'Confederation of Indian Industry-Vadodara',
      'Confederation of Indian Industry-Vijayawada',
      'Confederation of Indian Industry-Wayanad',
      'DHL Supply Chain India Pvt Ltd-Belagavi',
      'DHL Supply Chain India Pvt Ltd-Bengaluru',
      'Emcure Pharmaceuticals Limited-Hinjewadi',
      'ERESOLUTION CONSULTANCY SERVICES PRIVATE LIMITED-Delhi',
      'ERESOLUTION CONSULTANCY SERVICES PRIVATE LIMITED-Kolkata',
      'ERESOLUTION CONSULTANCY SERVICES PRIVATE LIMITED-Noida',
      'FAIVELEY TRANSPORT RAIL TECHNOLOGIES INDIA PVT LTD-Ghazipur',
      'FAIVELEY TRANSPORT RAIL TECHNOLOGIES INDIA PVT LTD-Hosur',
      'FAIVELEY TRANSPORT RAIL TECHNOLOGIES INDIA PVT LTD-Krishnagiri',
      'FAIVELEY TRANSPORT RAIL TECHNOLOGIES INDIA PVT LTD-Kurukshetra',
      'FAIVELEY TRANSPORT RAIL TECHNOLOGIES INDIA PVT LTD-New Delhi',
      'FAIVELEY TRANSPORT RAIL TECHNOLOGIES INDIA PVT LTD-Rohtak',
      'FAIVELEY TRANSPORT RAIL TECHNOLOGIES INDIA PVT LTD-Salem',
      'FAIVELEY TRANSPORT RAIL TECHNOLOGIES INDIA PVT LTD-Tiruchirappalli',
      'FESTO INDIA PRIVATE LIMITED-Bengaluru',
      'FESTO INDIA PRIVATE LIMITED-Hosur',
      'FESTO INDIA PRIVATE LIMITED-Noida',
      'FESTO INDIA PRIVATE LIMITED-Tamilnadu',
      'FLO MOBILITY PRIVATE LIMITED-Ahmedabad',
      'FLO MOBILITY PRIVATE LIMITED-Bengaluru',
      'FLO MOBILITY PRIVATE LIMITED-Hyderabad',
      'FLO MOBILITY PRIVATE LIMITED-Kendrapara',
      'FLO MOBILITY PRIVATE LIMITED-Mumbai',
      'FLO MOBILITY PRIVATE LIMITED-Prayagraj',
      'FLO MOBILITY PRIVATE LIMITED-Purulia',
      'GNI INFRASTRUCTURE LIMITED-Ahmedabad',
      'GNI INFRASTRUCTURE LIMITED-Aurangabad',
      'Griptronics India Wires and Cables Pvt Ltd-Azamgarh',
      'Griptronics India Wires and Cables Pvt Ltd-Noida',
      'Griptronics India Wires and Cables Pvt Ltd-Sheikhpura',
      'GuruNanak Motors Pvt Ltd-Aurangabad',
      'HABEEB TANNING COMPANY-Vellore',
      'HEXATRON INDUSTRIES LIMITED-Aravalli',
      'HEXATRON INDUSTRIES LIMITED-Sabarkantha',
      'HOMAG INDIA PVT LTD-Ahmedabad',
      'HOMAG INDIA PVT LTD-Bengaluru',
      'HOMAG INDIA PVT LTD-Chandigarh (PB)',
      'HOMAG INDIA PVT LTD-New Delhi',
      'INDIA YAMAHA MOTOR PRIVATE LIMITED-Gautam Buddha Nagar',
      'INDIA YAMAHA MOTOR PRIVATE LIMITED-Greater Noida',
      'INDIA YAMAHA MOTOR PRIVATE LIMITED-Surajpur',
      'INDICATION INSTRUMENTS LIMITED-Bhadohi',
      'INDICATION INSTRUMENTS LIMITED-Bokaro',
      'INDICATION INSTRUMENTS LIMITED-etah',
      'INDICATION INSTRUMENTS LIMITED-Faridabad',
      'INDICATION INSTRUMENTS LIMITED-Jamui',
      'JPT Electronics Systems Private Limited-Bengaluru',
      'JPT Electronics Systems Private Limited-Rajajinagar',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Addanki',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Aligarh',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Allahabad',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Alwar',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Amritsar',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Ashok Nagar',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-auraiya',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Balasore',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Bankura',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Banswara',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Barmer',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Bastar',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Bellary',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Bengaluru',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Bhilwara',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Bhopal',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Bhubaneswar',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Bulandshahr',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Burhanpur',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Chittorgarh',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Dadri',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Dantewada',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Datia',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Deoria',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Dhar',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-etah',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Etawah',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Faridabad',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Gajapati',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Gandhi Nagar',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Gandhinagar',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Ganjam',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Giridih',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Godda',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Gopalganj',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Gorakhpur',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Gurugram',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Hyderabad',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Jaipur',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Jhalawar',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Jodhpur',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Kandhamal',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Kaushambi',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Kendujhar',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Khargone',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Khurda',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Kolhapur',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Koraput',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Kota',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Kushinagar',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Lalitpur',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Lucknow',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Ludhiana',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Madhubani',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Maharajganj',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Mahoba',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Malkangiri',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Mandla',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Mayurbhanj',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Mehsana',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Mumbai',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Munger',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Muzaffarpur',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Nabarangpur',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Noida',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-North 24 Parganas',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Pakur',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Pali',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Panna',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Phulbani',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Pratapgarh',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Prayagraj',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Pune',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Puruliya',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Ranchi',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Rohtas',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Rourkela',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Rupnagar',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Shivpuri',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Sidhi',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Sikar',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-South Delhi',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Sundargarh',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Sundergarh',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Thane',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Umaria',
      'KALPATARU PROJECTS INTERNATIONAL LIMITED-Varanasi',
      'KEWAUNEE LABWAY INDIA PRIVATE LIMITED-Bengaluru',
      'KEWAUNEE LABWAY INDIA PRIVATE LIMITED-Karnataka',
      'Kramer Asia Pacific Pty Ltd-Bengaluru',
      'KRUTRIM SI DESIGNS PRIVATE LIMITED-Bengaluru',
      'KRUTRIM SI DESIGNS PRIVATE LIMITED-Pune',
      'KWALITY MOBIKES PRIVATE LIMITED-Bengaluru',
      'Kyocera Document Solutions India Private Limited-Kolkata',
      'KYUNGSHIN INDUSTRIAL MOTHERSON PRIVATE LIMITED-Kanchipuram',
      'La Gajjar Machineries Private Limited-Ahmedabad',
      'La Gajjar Machineries Private Limited-Ambala',
      'La Gajjar Machineries Private Limited-Bhubaneswar',
      'La Gajjar Machineries Private Limited-Guwahati',
      'La Gajjar Machineries Private Limited-Indore',
      'La Gajjar Machineries Private Limited-Jaipur',
      'La Gajjar Machineries Private Limited-Kolkata',
      'La Gajjar Machineries Private Limited-Lucknow',
      'La Gajjar Machineries Private Limited-Patna',
      'La Gajjar Machineries Private Limited-Ranchi',
      'La Gajjar Machineries Private Limited-Sanand',
      'LIFECARE NEURO PRODUCTS LIMITED-Baddi (HP)',
      'LOTTE INDIA CORPORATION LIMITED-Ahmedabad',
      'M & B Engineering Limited-Ahmedabad',
      'M & B Engineering Limited-Delhi',
      'M & B Engineering Limited-Mumbai',
      'M & B Engineering Limited-Pune',
      'M & B Engineering Limited-Sanand',
      'NASH ENERGY (I) PRIVATE LIMITED-Bengaluru',
      'NASH Industries India Pvt Ltd-Bengaluru',
      'NASH Industries India Pvt Ltd-Bommasandra',
      'NASH Industries India Pvt Ltd-Chennai',
      'NASH Industries India Pvt Ltd-Dabaspete',
      'NASH Industries India Pvt Ltd-Nagarur',
      'NASH Industries India Pvt Ltd-Peenya',
      'NASH Industries India Pvt Ltd-Pune',
      'Nash Products-Bengaluru',
      'Nash Products-Rajajinagar',
      'NATESAN SYNCHROCONES PRIVATE LIMITED-Chennai',
      'Nestle India Limited-Ghazipur',
      'Nestle India Limited-Goa',
      'Nestle India Limited-Jaunpur',
      'Nestle India Limited-Kasaragod',
      'Nestle India Limited-Kozhikode',
      'Nestle India Limited-Mainpuri',
      'Nestle India Limited-North Goa',
      'Nestle India Limited-Ponda',
      'Nestle India Limited-Sindhudurg',
      'Nestle India Limited-South Goa',
      'North West Carrying Company LLP-Ahmedabad',
      'North West Carrying Company LLP-Aligarh',
      'North West Carrying Company LLP-Almora',
      'North West Carrying Company LLP-Baharampore',
      'North West Carrying Company LLP-Bhopal',
      'North West Carrying Company LLP-Bijnor',
      'North West Carrying Company LLP-budaun',
      'North West Carrying Company LLP-Churachandpur',
      'North West Carrying Company LLP-Faridabad',
      'North West Carrying Company LLP-Firozabad',
      'North West Carrying Company LLP-Garia',
      'North West Carrying Company LLP-Gautam Buddha Nagar',
      'North West Carrying Company LLP-Ghaziabad',
      'North West Carrying Company LLP-Gurgaon',
      'North West Carrying Company LLP-Gurugram',
      'North West Carrying Company LLP-Gwalior',
      'North West Carrying Company LLP-Haldia',
      'North West Carrying Company LLP-Harda',
      'North West Carrying Company LLP-Haridwar',
      'North West Carrying Company LLP-Howrah',
      'North West Carrying Company LLP-Indore',
      'North West Carrying Company LLP-Jabalpur',
      'North West Carrying Company LLP-Jajpur',
      'North West Carrying Company LLP-Kamrup',
      'North West Carrying Company LLP-Kharagpur',
      'North West Carrying Company LLP-Kolkata',
      'North West Carrying Company LLP-Lakhimpur',
      'North West Carrying Company LLP-Loni',
      'North West Carrying Company LLP-Lucknow',
      'North West Carrying Company LLP-Mehsana',
      'North West Carrying Company LLP-Nadia',
      'North West Carrying Company LLP-Noida',
      'North West Carrying Company LLP-Port Blair',
      'North West Carrying Company LLP-Raebareli',
      'North West Carrying Company LLP-Raipur',
      'North West Carrying Company LLP-Rampur',
      'North West Carrying Company LLP-Rewari',
      'North West Carrying Company LLP-Rudrapur',
      'North West Carrying Company LLP-Sambalpur',
      'North West Carrying Company LLP-Siliguri',
      'North West Carrying Company LLP-Surat',
      'OBEN ELECTRIC VEHICLES PRIVATE LIMITED-Bengaluru',
      'OERLIKON BALZERS COATING INDIA PRIVATE LIMITED-Ahmedabad',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Adoor',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Agra',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Ahmedabad',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Ahmednagar',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Ajmer',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Akluj',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Akola',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Alappuzha',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Aligarh',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Alwar',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Amalapuram',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Ambala',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Amravati',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Amritsar',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Anakapalle',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Anakapalli',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Anand',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Anantapur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Angul',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Annamayya',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Ariyalur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Asansol',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Aurangabad',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Azamgarh',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Bagalkot',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Balasore',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Ballari ',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Ballarpur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Banaskantha',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-banda',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Barabanki',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-BARAMATI',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Bareilly',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Barmer',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Basavakalyan',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Basti',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Batala',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Bathinda',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Begusarai',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Behror',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Belagavi',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Belgaum',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Bengaluru',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Bettiah',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Betul',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Bhadrak',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Bhagalpur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Bharatpur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Bhavnagar',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Bhilai',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Bhilwara',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Bhind',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Bhiwadi',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Bhojpur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Bhopal',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Bhubaneswar',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Bihar Sharif',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Bijnor',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Bikaner',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Bilaspur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Bilaspur(Chhattisgarh)',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Birbhum',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Bulandshahr',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Buldhana',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Chalakudy',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Chamarajanagar',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Chandigarh',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Chandrapur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Chatra',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Chennai',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Chhatarpur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Chhatrapati Sambhaji Nagar',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Chhindwara',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Chikkaballapur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Chikkamagaluru ',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Chitradurga',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Chittoor',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Churu',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Coimbatore',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Cooch Behar',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Cuttack',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Dakshin Dinajpur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Daund',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Davanagere',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Dehradun',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Delhi',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Deoghar',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Deoria',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Dhamtari',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Dhanbad',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Dhar',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Dharapuram',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Dharmapuri',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Dharwad',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Dhenkanal',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Dholpur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Dhule',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Didwana-Kuchaman',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Dindigul',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Doddaballapura',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Dr. B.R. Ambedkar Konaseema',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Durg',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Durgapur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-East Godavari',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Ernakulam',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Erode',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Etawah',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Faridabad',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Fatehpur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Gadag',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Gadchiroli',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Ganjam',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Gaya',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Ghaziabad',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Ghazipur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Gir Somnath',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Gobichettipalayam',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Gokak',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Gondia',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Gopalganj',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Gorakhpur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Gurgaon',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Gurugram',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Guwahati',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Gwalior',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Haldwani',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Hanumangarh',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Hassan',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Hisar',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Hooghly',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Hosapete',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Hoshangabad',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Hoshiarpur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Hosur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Howrah',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Hubballi',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Hubli',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Hyderabad',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Idukki',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Indore',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Iritty',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Islampur (MH)',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Jabalpur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Jagatsinghpur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Jagtial',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Jaipur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Jalandhar',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Jalgaon',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Jammu',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Jamnagar',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Jamshedpur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Janjgir-Champa',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Jhansi',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Jhargram',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Jhunjhunu',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Jind',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Jodhpur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Jorhat',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Junagadh',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Kachchh',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Kadiam',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Kakinada',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Kalaburagi',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Kanakapura',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Kanchipuram',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Kandi',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Kannur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Kanpur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Kanyakumari',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Karad',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Karaikal',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Karimnagar',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Karjat',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Karur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Kasaragod',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Katni',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Kaushambi',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Kendrapara',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Kerala',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Khammam',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Kharagpur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Khordha',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Kochi',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Kolar',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Kolhapur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Kolkata',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Kollam',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Koppal',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Kota',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Kottayam',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Kozhikode',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Krishna',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Krishnagiri',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Krishnanagar',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Kurnool',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Lakhimpur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Lucknow',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Ludhiana',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Machilipatnam',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Madanapalle',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Madurai',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Malappuram',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Malda',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Mandsaur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Mandya',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Mangalore',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Marthandam',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Mathura',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Mau',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Mayurbhanj',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Medchal-Malkajgiri',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Meerut',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Mohali',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Moradabad',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Morena',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Mumbai',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Murshidabad',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Muvattupuzha',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Muzaffarpur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Muzzafarnagar',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Mysore',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Mysuru ',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Nabarangpur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Nabha',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Nagaur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Nagpur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Nalanda',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Nalgonda',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Namakkal',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Nandurbar',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Nashik',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Nawada',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Nayagarh',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Neemuch',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Nellore',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-New Delhi',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Neyyattinkara',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Nirmal',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Niwari',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Nizamabad',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Noida',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Palakkad',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Pali',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Palladam',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Palwal',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Panipat',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Parbhani',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Paschim Bardhaman',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Pathanamthitta',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Pathankot',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Patna',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Prakasam',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Prayagraj',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Pune',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Purba Medinipur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Puri',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Purnia',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Raebareli',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Raichur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Raigarh',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Raipur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Rajkot',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Rajnandgaon',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Rajsamand',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Ramanagara',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Ranchi',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Rangareddy',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Ranipet',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Ratnagiri',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Rewa',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Rewari',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Rohtak',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Rohtas',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Roorkee',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Rudrapur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Sagar',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Saharanpur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Salem',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Sambalpur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Sangli',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Sasaram',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Satara',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Satna',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Sehore',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Seoni',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Shahjahanpur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Shajapur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Shimoga',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Shivamogga ',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Shivpuri',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Shrirampur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Sikar',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Siliguri',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Sindhudurg',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Sirohi',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Sitapur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Sivaganga',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Siwan',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Solapur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Sonipat',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Sri Ganganagar',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Srikakulam',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Srinagar',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Sundargarh',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Sundergarh',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Supaul',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Surat',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Tenkasi',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Thane',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Thanjavur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Thiruvallur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Thiruvananthapuram',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Thiruvannamalai',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Thiruvarur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Thoothukkudi',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Thoothukudi',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Thrissur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Tiruchirappalli',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Tirunelveli',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Tirupati',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Tiruppur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Tirur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Tiruvallur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Tiruvannamalai',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Tumakuru ',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Tumkur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Udaipur',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Udupi',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Ujjain',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Ulhasnagar',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Uttara Kannada',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Vadodara',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Vaishali',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Varanasi',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Vidisha',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Vijayanagaram',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Vijayawada',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Visakhapatnam',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Warangal',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Wayanad',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Yamuna Nagar',
      'OLA ELECTRIC TECHNOLOGIES PRIVATE LIMITED-Yavatmal',
      'OLA FLEET TECHNOLOGIES PRIVATE LIMITED-Gurgaon',
      'OLA FLEET TECHNOLOGIES PRIVATE LIMITED-Hyderabad',
      'OLIVE PLUS TWIST AVENUES PRIVATE LIMITED-Chennai',
      'PADMINI VNA MECHATRONICS PRIVATE LIMITED-Gurugram',
      'PEPING COMMERCE PRIVATE LIMITED-Bengaluru',
      'Powerica Limited-Bengaluru',
      'Powerica Limited-Nelamangala',
      'Precision Products-Bengaluru',
      'Precision Products-Rajajinagar',
      'PURESOFTWARE TECHNOLOGIES PRIVATE LIMITED-Noida',
      'Rangsons Aerospace Private Limited-Mysore',
      'REDISOLVE SOFTWARE PVT LTD-Chennai',
      'River Mobility Private Limited-Bengaluru',
      'River Mobility Private Limited-Hoskote',
      'River Mobility Private Limited-Hyderabad',
      'River Mobility Private Limited-Kochi',
      'River Mobility Private Limited-Pune',
      'ROYALBISON AUTORENTALS INDIA PVT LTD-Ahmedabad',
      'ROYALBISON AUTORENTALS INDIA PVT LTD-Bengaluru',
      'ROYALBISON AUTORENTALS INDIA PVT LTD-Hyderabad',
      'ROYALBISON AUTORENTALS INDIA PVT LTD-Jaipur',
      'ROYALBISON AUTORENTALS INDIA PVT LTD-Madhapur',
      'ROYALBISON AUTORENTALS INDIA PVT LTD-Visakhapatnam',
      'SAMBHAV FOUNDATION-Chennai',
      'SAMBHAV FOUNDATION-Gorantla',
      'SAMBHAV FOUNDATION-Noida',
      'SAMBHAV FOUNDATION-Sanand',
      'SAMPARK INDIA LOGISTICS LIMITED-Bengaluru',
      'SAMPARK INDIA LOGISTICS LIMITED-Chennai',
      'SAMPARK INDIA LOGISTICS LIMITED-Delhi',
      'SAMPARK INDIA LOGISTICS LIMITED-Faridabad',
      'SAMPARK INDIA LOGISTICS LIMITED-Gurugram',
      'SAMPARK INDIA LOGISTICS LIMITED-Kolkata',
      'SAMPARK INDIA LOGISTICS LIMITED-Ludhiana',
      'SAMPARK INDIA LOGISTICS LIMITED-Noida',
      'SAMPARK INDIA LOGISTICS LIMITED-Palwal',
      'SAMPARK INDIA LOGISTICS LIMITED-Rajgarh-Rj',
      'SAMPARK INDIA LOGISTICS LIMITED-Roorkee',
      'Sandhar Technologies Limited-Chennai',
      'Sandhar Technologies Limited-Hosur',
      'Sandhar Technologies Limited-Krishnagiri',
      'Sandhar Technologies Limited-Solan',
      'SATRAC ENGINEERING PRIVATE LIMITED-Bengaluru',
      'SHEERDRIVE PRIVATE LIMITED-Mumbai',
      'Sindoori Management Solutions Private Limited-Chennai',
      'Sindoori Management Solutions Private Limited-Mumbai',
      'Sindoori Management Solutions Private Limited-Nashik',
      'STESALIT LIMITED-Greater Noida',
      'STRING BIO PRIVATE LIMITED-Nashik',
      'SUZUKI MOTOR GUJARAT PRIVATE LIMITED-Ahmedabad',
      'SUZUKI MOTOR GUJARAT PRIVATE LIMITED-Mehsana',
      'Tractors and Farm Equipment Limited-Bengaluru',
      'Tractors and Farm Equipment Limited-Doddaballapur',
      'Tractors and Farm Equipment Limited-Doddaballapura',
      'VARROC ENGINEERING LIMITED-Pune',
      'Venture7 Technology Pvt Ltd-Faridabad',
      'Venture7 Technology Pvt Ltd-Gurgaon',
      'Venture7 Technology Pvt Ltd-Palwal',
      'VIKRAM SOLAR LIMITED-Falta',
      'WABTEC INDIA INDUSTRIAL PRIVATE LIMITED-Bengaluru',
      'Wildcraft India Pvt Ltd-Alwar',
      'Wildcraft India Pvt Ltd-Ayodhya',
      'Wildcraft India Pvt Ltd-Bagpat',
      'Wildcraft India Pvt Ltd-Ballia',
      'Wildcraft India Pvt Ltd-Belgaum',
      'Wildcraft India Pvt Ltd-Bengaluru',
      'Wildcraft India Pvt Ltd-Bhubaneswar',
      'Wildcraft India Pvt Ltd-Chandigarh',
      'Wildcraft India Pvt Ltd-Chennai',
      'Wildcraft India Pvt Ltd-Cochin',
      'Wildcraft India Pvt Ltd-Coimbatore',
      'Wildcraft India Pvt Ltd-Dehradun',
      'Wildcraft India Pvt Ltd-Delhi',
      'Wildcraft India Pvt Ltd-Faridabad',
      'Wildcraft India Pvt Ltd-Ghaziabad',
      'Wildcraft India Pvt Ltd-Gorakhpur',
      'Wildcraft India Pvt Ltd-Gurgaon',
      'Wildcraft India Pvt Ltd-Guwahati',
      'Wildcraft India Pvt Ltd-Haldwani',
      'Wildcraft India Pvt Ltd-Hyderabad',
      'Wildcraft India Pvt Ltd-Jabalpur',
      'Wildcraft India Pvt Ltd-Jaipur',
      'Wildcraft India Pvt Ltd-Jaunpur',
      'Wildcraft India Pvt Ltd-Kanpur',
      'Wildcraft India Pvt Ltd-Kolkata',
      'Wildcraft India Pvt Ltd-Kota',
      'Wildcraft India Pvt Ltd-Lucknow',
      'Wildcraft India Pvt Ltd-Madurai',
      'Wildcraft India Pvt Ltd-Mangalore',
      'Wildcraft India Pvt Ltd-Mumbai',
      'Wildcraft India Pvt Ltd-Muradnagar',
      'Wildcraft India Pvt Ltd-Mysore',
      'Wildcraft India Pvt Ltd-Nagercoil',
      'Wildcraft India Pvt Ltd-Noida',
      'Wildcraft India Pvt Ltd-Palakkad',
      'Wildcraft India Pvt Ltd-Patna',
      'Wildcraft India Pvt Ltd-Prayagraj',
      'Wildcraft India Pvt Ltd-Pudukkottai',
      'Wildcraft India Pvt Ltd-Pune',
      'Wildcraft India Pvt Ltd-Ranchi',
      'Wildcraft India Pvt Ltd-Shivamogga ',
      'Wildcraft India Pvt Ltd-Thiruvananthapuram',
      'Wildcraft India Pvt Ltd-Tuticorin',
      'Wildcraft India Pvt Ltd-Vadodara',
      'Wildcraft India Pvt Ltd-Varanasi',
      'Wildcraft India Pvt Ltd-Vijayawada',
      'XAVIENT INFOTECH PVT LTD-Mumbai',
      'Xavient Software Solutions India Private Limited-Gautam Buddha Nagar',
      'Xavient Software Solutions India Private Limited-Ghaziabad',
      'Xavient Software Solutions India Private Limited-New Delhi',
      'Xavient Software Solutions India Private Limited-Noida',
      'Zanini India Pvt Ltd-Sanand',
      'Zippin Pharma Private Limited-Mumbai',
      'Zippin Pharma Private Limited-Mumbai Suburban',
      'Zippin Pharma Private Limited-Palghar',
      'Zippin Pharma Private Limited-Pune',
      'Zippin Pharma Private Limited-Raigad',
      'Zippin Pharma Private Limited-Thane'
    ];

    const qs = (sel, el=document) => el.querySelector(sel);
    const qsa = (sel, el=document) => Array.from(el.querySelectorAll(sel));

    // Masked PIN prompt helper (moved into script)
    function askPin({ title='Enter PIN', subtitle='This action requires authorization', label='PIN' }={}){
      return new Promise((resolve) => {
        const modal = qs('#pinModal'); const ttl = qs('#pinModalTitle'); const sub = qs('#pinModalSub'); const lab = qs('#pinLabel'); const input = qs('#pinInput');
        const close = () => { modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); input.value=''; cleanup(); };
        const ok = () => { const v = (input.value||'').trim(); close(); resolve(v); };
        const cancel = () => { close(); resolve(''); };
        const keyH = (e) => { if (e.key === 'Enter') { e.preventDefault(); ok(); } if (e.key === 'Escape') { e.preventDefault(); cancel(); } };
        function cleanup(){ btnOk.removeEventListener('click', ok); btnCancel.removeEventListener('click', cancel); btnClose.removeEventListener('click', cancel); modal.removeEventListener('keydown', keyH); }
        const btnOk = qs('#pinOkBtn'); const btnCancel = qs('#pinCancelBtn'); const btnClose = qs('#pinCloseBtn');
        if (ttl) ttl.textContent = title; if (sub) sub.textContent = subtitle; if (lab) lab.textContent = label;
        // Adjust input mode: numeric for PIN, text for Password
        if (label.toLowerCase().includes('password')) { input.type = 'password'; input.inputMode = 'text'; input.pattern = ''; }
        else { input.type = 'password'; input.inputMode = 'numeric'; input.pattern = '[0-9]*'; }
        modal.classList.add('open'); modal.setAttribute('aria-hidden','false');
        setTimeout(() => { input.focus(); }, 50);
        btnOk.addEventListener('click', ok); btnCancel.addEventListener('click', cancel); btnClose.addEventListener('click', cancel);
        modal.addEventListener('keydown', keyH);
      });
    }
    const IST_TZ = 'Asia/Kolkata';
    const timeSource = { ready:false, epochMs:Date.now(), monoMs:performance.now() };
    async function syncISTTime(){
      try {
        const res = await fetch('https://worldtimeapi.org/api/timezone/Asia/Kolkata', { cache:'no-store' });
        if (!res.ok) throw new Error('network');
        const j = await res.json();
        const epochMs = ((j.unixtime||0) * 1000) || (new Date(j.datetime).getTime());
        if (epochMs) { timeSource.epochMs = epochMs; timeSource.monoMs = performance.now(); timeSource.ready = true; }
      } catch(e) {
        console.warn('IST time fetch failed; using system clock');
      }
    }
    const istNowMs = () => timeSource.epochMs + (performance.now() - timeSource.monoMs);
    const todayISO = () => new Date(istNowMs()).toISOString().slice(0,10);
    const toLocalDatetimeValue = (d) => {
      if (!d) return '';
      const dt = (d instanceof Date) ? d : new Date(d);
      const parts = new Intl.DateTimeFormat('en-GB', { timeZone: IST_TZ, year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false }).formatToParts(dt).reduce((acc,p)=>{ acc[p.type]=p.value; return acc; }, {});
      return `${parts.year}-${parts.month}-${parts.day}T${parts.hour}:${parts.minute}`;
    };
    const nowLocalDatetimeValue = () => toLocalDatetimeValue(new Date(istNowMs()));
    const toLocalDateValue = (d) => {
      if (!d) return '';
      const dt = (d instanceof Date) ? d : new Date(d);
      const parts = new Intl.DateTimeFormat('en-GB', { timeZone: IST_TZ, year: 'numeric', month: '2-digit', day: '2-digit' }).formatToParts(dt).reduce((acc,p)=>{ acc[p.type]=p.value; return acc; }, {});
      return `${parts.year}-${parts.month}-${parts.day}`;
    };
    const nowLocalDateValue = () => toLocalDateValue(new Date(istNowMs()));
  const nowISODateTime = () => new Date(istNowMs()).toISOString();
  const fmtDate = (d) => d ? new Date(d).toLocaleDateString() : '—';
  const fmtDateTime = (d) => d ? new Date(d).toLocaleString() : '—';
  const hoursBetween = (aISO, bISO) => { if (!aISO || !bISO) return null; return Math.round((new Date(bISO) - new Date(aISO)) / 36e5); };
    const daysBetween = (a, b) => {
      if (!a || !b) return null; const d1 = new Date(a).setHours(0,0,0,0); const d2 = new Date(b).setHours(0,0,0,0); return Math.round((d2 - d1) / (1000*60*60*24));
    };
    const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
    const sum = (arr) => arr.reduce((acc, n) => acc + (Number(n)||0), 0);
    const showToast = (msg) => { const el = qs('#toast'); el.textContent = msg; el.classList.add('show'); setTimeout(() => el.classList.remove('show'), 1800); };

    // Persistence
    async function load() {
      try { const arr = await LocalStore.getRequests(); if (Array.isArray(arr)) state.requests = arr; } catch (e) { console.error('Load failed', e); state.requests = []; }
      try { const sraw = localStorage.getItem(SETTINGS_KEY); if (sraw) { const obj = JSON.parse(sraw); Object.assign(settings, obj||{}); } } catch (e) {}
    }
    async function save() {
      try { await LocalStore.setRequests(state.requests); } catch (e) { console.error('Save failed', e); }
      // Auto-sync to Firebase (debounced) if available
      try { fbAutoSync(); } catch(_){ }
    }
    function saveSettings(){ try { localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings)); } catch(e){} }

    // Debounced Firebase autosync marker (actual push/pull handled by 2s loop)
    let _fbSyncTimer = null;
    function fbAutoSync(){
      if (!fb || !fb.ready) return;
      clearTimeout(_fbSyncTimer);
      _fbSyncTimer = setTimeout(() => { try { fb.noteLocalChange(); } catch(_){} }, 400);
    }

    // Firebase sync (Firestore)
    const fb = {
      get ready(){ return !!window.FirebaseSync; },
      statusEl: null,
  syncBtn: null,
  lastSyncedEl: null,
  lastSyncAt: 0,
      // sync state
      lastRemoteAt: 0,
      lastLocalAt: 0,
      pendingPush: false,
      loopTimer: null,
      updateUi(text){
        if (!this.statusEl) this.statusEl = qs('#fbStatus');
        if (!this.syncBtn) this.syncBtn = qs('#fbSyncBtn');
        if (!this.lastSyncedEl) this.lastSyncedEl = qs('#fbLastSynced');
        if (!this.statusEl || !this.syncBtn) return;
        if (!this.ready) {
          this.statusEl.textContent = 'Firebase: connecting…';
          this.statusEl.classList.remove('ok','err');
          this.statusEl.classList.add('neutral');
          this.syncBtn.disabled = true;
          return;
        }
        const connected = !!window.FirebaseSync?.connected;
        this.statusEl.textContent = connected ? 'Firebase: connected' : 'Firebase: offline';
        this.statusEl.classList.remove('ok','err','neutral');
        this.statusEl.classList.add(connected ? 'ok' : 'err');
        this.syncBtn.disabled = !connected;
        if (this.lastSyncedEl) {
          const val = this.lastSyncAt ? new Date(this.lastSyncAt).toLocaleString() : '—';
          this.lastSyncedEl.textContent = `• Last sync: ${val}`;
        }
      },
      noteLocalChange(){
        this.pendingPush = true;
        this.lastLocalAt = Date.now();
      },
      startSyncLoop(){
        if (this.loopTimer) return;
        try { this.loopTimer = setInterval(() => { this.syncTick().catch(()=>{}); }, 2000); } catch(_){ }
      },
      stopSyncLoop(){ if (this.loopTimer) { clearInterval(this.loopTimer); this.loopTimer = null; } },
      async syncTick(){
        if (!this.ready || !window.FirebaseSync?.connected) return;
        try {
          // Pull latest from cloud
          if (typeof window.FirebaseSync.fetch === 'function') {
            const remote = await window.FirebaseSync.fetch();
            const rAt = Number(remote?.updatedAtMillis || 0);
            if (rAt && rAt > this.lastRemoteAt) {
              // If remote is newer, adopt it (drop pending local to avoid clobber)
              state.requests = Array.isArray(remote.requests) ? remote.requests : [];
              try { await LocalStore.setRequests(state.requests); } catch {}
              render();
              if (this.pendingPush && rAt >= this.lastLocalAt) this.pendingPush = false;
              this.lastRemoteAt = rAt;
              this.lastSyncAt = Date.now();
              this.updateUi();
              // Optional toast to indicate pull
              // showToast('Pulled latest from Firebase');
            }
          }
          // If we have local changes that are newer than last seen remote, push them
          if (this.pendingPush && this.lastLocalAt > this.lastRemoteAt) {
            await window.FirebaseSync.save(state.requests);
            this.pendingPush = false;
            const now = Date.now();
            this.lastRemoteAt = now;
            this.lastSyncAt = now;
            this.updateUi();
          }
        } catch(e){ /* swallow loop errors */ }
      },
      // Update relative tooltip every 30s
      _relTimer: null,
      _startRelTimer(){
        const update = () => {
          if (!this.lastSyncedEl) this.lastSyncedEl = qs('#fbLastSynced');
          if (!this.lastSyncedEl) return;
          if (!this.lastSyncAt) { this.lastSyncedEl.title = 'Not synced yet'; return; }
          const secs = Math.max(0, Math.floor((Date.now() - this.lastSyncAt)/1000));
          const parts = [];
          const h = Math.floor(secs/3600); const m = Math.floor((secs%3600)/60); const s = secs%60;
          if (h) parts.push(h + 'h'); if (m) parts.push(m + 'm'); if (!h && !m) parts.push(s + 's');
          const label = parts.join(' ');
          this.lastSyncedEl.title = secs < 5 ? 'Synced just now' : `Synced ${label} ago`;
        };
        try { update(); } catch(_){}
        try { if (this._relTimer) clearInterval(this._relTimer); this._relTimer = setInterval(update, 30000); } catch(_){ }
      },
      async initAndAutoLoad(){
        if (!this.ready) {
          this.updateUi();
          // Wait for FirebaseSync to load for a short period
          for (let i = 0; i < 50 && !this.ready; i++) { // up to ~5s
            await new Promise(r => setTimeout(r, 100));
          }
          if (!this.ready) return; // give up silently; overlay will still handle connection gating
        }
        try {
          const ok = await window.FirebaseSync.check();
          this.updateUi();
          if (ok) {
            // Get initial data and timestamp
            let initial = { requests: [], updatedAtMillis: 0 };
            try { if (typeof window.FirebaseSync.fetch === 'function') initial = await window.FirebaseSync.fetch(); }
            catch {}
            if (Array.isArray(initial.requests) && initial.requests.length) {
              state.requests = initial.requests;
              try { await LocalStore.setRequests(state.requests); } catch {}
              render();
              showToast('Loaded from Firebase');
              this.lastSyncAt = Date.now();
            } else {
              // No remote data; treat local as source if any, and render
              try {
                const arr = await LocalStore.getRequests();
                if (Array.isArray(arr) && arr.length) {
                  state.requests = arr;
                  render();
                  showToast('Loaded local data');
                  this.noteLocalChange(); // mark for upload
                }
              } catch {}
            }
            this.lastRemoteAt = Number(initial.updatedAtMillis || 0);
            this.startSyncLoop();
            this._startRelTimer();
          }
        } catch(e){ console.warn('Firebase init/load failed', e); this.updateUi(); }
      },
      async save(){
        if (!this.ready) return showToast('Firebase not ready');
        try { await window.FirebaseSync.save(state.requests); showToast('Synced to Firebase'); const now = Date.now(); this.lastRemoteAt = now; this.lastSyncAt = now; this.pendingPush = false; this.updateUi(); this._startRelTimer(); }
        catch(e){ console.error(e); showToast('Firebase sync failed'); }
      }
    };

    // Demo data
    function makeDemoData() {
      const now = istNowMs();
      const iso = (ms) => new Date(ms).toISOString();
      const daysAgo = (d) => iso(now - d*86400000);
      const clients = [
        'ANI TECHNOLOGIES PRIVATE LIMITED-Bengaluru',
        'Ather Energy Limited-Chennai',
        'BARODA GLOBAL SHARED SERVICES LIMITED-Mumbai',
        'Birlasoft Limited-Hyderabad',
        'Confederation of Indian Industry-Ahmedabad',
        'APOLLO SINDOORI HOTELS LIMITED-Bengaluru'
      ];
      const requestors = ['Girish', 'Olive', 'Vara', 'Shubham', 'Ashwin', 'Afreen'];
      const mkWeekly = (m, f) => {
        // split roughly across 4 weeks
        const m1 = Math.floor(m*0.25), m2 = Math.floor(m*0.25), m3 = Math.floor(m*0.25), m4 = m - (m1+m2+m3);
        const f1 = Math.floor(f*0.25), f2 = Math.floor(f*0.25), f3 = Math.floor(f*0.25), f4 = f - (f1+f2+f3);
        return [
          { male: m1, female: f1, total: m1+f1 },
          { male: m2, female: f2, total: m2+f2 },
          { male: m3, female: f3, total: m3+f3 },
          { male: m4, female: f4, total: m4+f4 },
        ];
      };
      const mk = (i, dAgo, totals, stage) => {
        const id = 'REQ-' + (1000 + i);
        const reqDate = daysAgo(dAgo);
        const bedsWeekly = mkWeekly(totals.m, totals.f);
        const notes = ['Near plant', 'Urgent', 'Standard onboarding', 'Expansion', 'Replacement'][i % 5];
        // approvals chain
        const bvDate   = (stage >= 2) ? daysAgo(Math.max(dAgo-9, 1)) : '';
        const sahiDate = (stage >= 3) ? daysAgo(Math.max(dAgo-7, 1)) : '';
        const vendDate = (stage >= 4) ? daysAgo(Math.max(dAgo-5, 1)) : '';
        const finPay   = (stage >= 5) ? daysAgo(Math.max(dAgo-3, 0)) : '';
        const ready    = (stage >= 6) ? daysAgo(Math.max(dAgo-1, 0)) : '';
        // progression of counts (never exceeding requested)
        const bvM = Math.min(totals.m, Math.max(0, totals.m - 1));
        const bvF = Math.min(totals.f, Math.max(0, totals.f - 1));
        const sahiM = Math.min(bvM, Math.max(0, bvM - 0));
        const sahiF = Math.min(bvF, Math.max(0, bvF - 0));
        const vendM = Math.min(sahiM, Math.max(0, sahiM - 0));
        const vendF = Math.min(sahiF, Math.max(0, sahiF - 0));
        const vendTentM = Math.max(0, Math.min(totals.m, vendM || Math.floor(totals.m*0.8)));
        const vendTentF = Math.max(0, Math.min(totals.f, vendF || Math.floor(totals.f*0.8)));
        const obj = {
          id,
          requestorName: requestors[i-1] || 'Girish',
          clientName: clients[(i-1) % clients.length],
          requestDate: reqDate,
          notes,
          beds: { male: totals.m, female: totals.f, total: totals.m + totals.f },
          bedsWeekly,
          approvals: {
            bv: { male: (stage>=2?bvM:0), female: (stage>=2?bvF:0), date: bvDate, remarks: stage>=2 ? 'Reviewed' : '' },
            sahi: { male: (stage>=3?sahiM:0), female: (stage>=3?sahiF:0), date: sahiDate, remarks: stage>=3 ? 'Approved' : '' },
            vendor: {
              male: (stage>=4?vendM:0), female: (stage>=4?vendF:0), date: vendDate,
              name: 'Partner ' + ((i%4)+1), readyDate: ready,
              newProp: 'no', identifyDate: '', tentativeMoveIn: (stage>=4? daysAgo(Math.max(dAgo-4,0)) : ''),
              notes: (stage>=4? 'Confirmed availability' : ''),
              ack: (vendTentM+vendTentF)>0, ackDate: (vendTentM+vendTentF)>0 ? daysAgo(Math.max(dAgo-6, 0)) : '',
              // seed split same as aggregate for samples
              tentativeExistM: Math.floor(vendTentM*0.6), tentativeExistF: Math.floor(vendTentF*0.6),
              tentativeNewM: vendTentM - Math.floor(vendTentM*0.6), tentativeNewF: vendTentF - Math.floor(vendTentF*0.6),
              tentativeM: vendTentM, tentativeF: vendTentF, actualConfirmDate: (stage>=4? vendDate : '')
            }
          },
          finance: {
            vendorIntimationDate: (stage>=4? daysAgo(Math.max(dAgo-4,0)) : ''),
            vendorIntimationBeds: (stage>=4? vendM+vendF : 0),
            perBedCost: (stage>=4? 5500 : ''),
            securityDeposit: (stage>=4? 11000 : ''),
            amount: (stage>=5? (vendM+vendF)*5500 : ''),
            terms: 'Monthly, 2 months deposit',
            confirmDate: (stage>=5? daysAgo(Math.max(dAgo-4,0)) : ''),
            
          },
          final: {
            vendorReadyDate: ready,
            notes: stage>=6 ? 'Move-in completed' : '',
            actualMoveInDate: (stage>=6? ready : '')
          },
          history: [],
          proofs: []
        };
        return obj;
      };

      // stages: 1=request only, 2=BV, 3=SAHI, 4=Vendor, 5=Finance Paid, 6=Ready/Completed
      const samples = [
        mk(1, 12, { m: 10, f: 6 }, 6), // Completed
  mk(2, 9,  { m: 8,  f: 4 }, 5), // Closure pending
        mk(3, 6,  { m: 6,  f: 2 }, 4), // Vendor approved
        mk(4, 4,  { m: 5,  f: 1 }, 3), // SAHI approved
        mk(5, 2,  { m: 4,  f: 0 }, 2), // BV approved
        mk(6, 7,  { m: 7,  f: 3 }, 4)  // Afreen till Vendor
      ];
      return samples;
    }

    // Derived computations
    function computeStage(req) {
      const a = req.approvals || {};
      const steps = [
        { key: 'bv', label: 'BV Head (Suhail)' },
        { key: 'sahi', label: 'SAHI Head (Ashish)' },
        { key: 'vendor', label: 'Housing Partner' },
      ];
  // Treat request as not started until a date is set AND at least some requirement (beds) is entered
  const requestedTotal = Number(req?.beds?.total || 0);
  if (!req.requestDate || requestedTotal <= 0) return { stage: 'Draft', next: 'Request' };
  // Closure override: if acknowledgement is given, treat as Completed immediately
  if (req.final?.readyAck) return { stage: 'Completed', next: null };
      for (const s of steps) {
        if (s.key === 'vendor') {
          const v = a.vendor || {};
          const vendorComplete = !!v.date || (!!v.confirm && !!v.actualConfirmDate);
          if (!vendorComplete) return { stage: 'Approvals', next: s.label };
          continue;
        }
        if (!a[s.key] || !a[s.key].date) return { stage: 'Approvals', next: s.label };
      }
      // Skip finance when vendor actuals are fully from existing capacity (no new onboarding)
      const vend = a.vendor || {};
      const noFinance = !!vend.confirm && (Number(vend.actualNewM||0) + Number(vend.actualNewF||0) === 0);
      const finHeadDecision = (req?.finance?.head?.decision || '').toLowerCase();
      const finHeadDone = !!req?.finance?.head?.date;
      if (!req.finance || !req.finance.confirmDate) {
        if (noFinance) {
          // Treat as closure pending to allow final acknowledgement
          // Closure can complete with Ready Acknowledgement (PIN) even if vendorReadyDate is not filled
          if (!req.final || !req.final.readyAck) return { stage: 'Closure Pending', next: 'Housing Partner Closure' };
          return { stage: 'Completed', next: null };
        }
        if (finHeadDone && finHeadDecision === 'approve') {
          if (!req.final || !req.final.readyAck) return { stage: 'Closure Pending', next: 'Housing Partner Closure' };
          return { stage: 'Completed', next: null };
        }
        return { stage: 'Finance Pending', next: finHeadDone ? 'Payment Confirmation' : 'Finance Approval' };
      }
  // After finance confirmed, closure can complete once Ready Acknowledgement is ticked (PIN)
  if (!req.final || !req.final.readyAck) return { stage: 'Closure Pending', next: 'Housing Partner Closure' };
      return { stage: 'Completed', next: null };
    }

    function computeProgress(req) {
      let done = 0; let total = 5; // request + 2 approvals + partner + finance
      if (req.requestDate) done++;
      if (req.approvals?.bv?.date) done++;
      if (req.approvals?.sahi?.date) done++;
  const vendorApproved = !!(req.approvals?.vendor?.date) || (!!req.approvals?.vendor?.confirm && !!req.approvals?.vendor?.actualConfirmDate);
  if (vendorApproved) done++;
  if (req.finance?.confirmDate) done++;
  // Treat as complete when closure acknowledgement is provided (vendorReadyDate optional)
  if (req.final?.readyAck) done = total;
      return Math.round((done / total) * 100);
    }

    // Per-approval TAT helpers
    function vendorTentativeConfirmed(req){
      const exM = Number(req?.approvals?.vendor?.tentativeExistM||0);
      const exF = Number(req?.approvals?.vendor?.tentativeExistF||0);
      const nwM = Number(req?.approvals?.vendor?.tentativeNewM||0);
      const nwF = Number(req?.approvals?.vendor?.tentativeNewF||0);
      const aggM = Number(req?.approvals?.vendor?.tentativeM||0);
      const aggF = Number(req?.approvals?.vendor?.tentativeF||0);
      const sum = (exM+exF+nwM+nwF) || (aggM+aggF);
      return sum > 0; // treat any non-zero tentative beds as confirmation
    }

    function computeApprovalTats(req){
      const valid = (d) => { if (!d) return null; const t = new Date(d); return isNaN(t.getTime()) ? null : d; };
      // BV TAT starts only when the requestor has actually added a request: a valid date AND non-zero requested beds
      const hasRequest = !!valid(req?.requestDate) && Number(req?.beds?.total || 0) > 0;
      const startBV = hasRequest ? valid(req?.requestDate) : null;
      const doneBV = valid(req?.approvals?.bv?.date);
      const startSAHI = doneBV || null;
      const doneSAHI = valid(req?.approvals?.sahi?.date);
      // Vendor acknowledgement TAT: 24h from SAHI approval to vendor ack
      const startVendAck = doneSAHI || null;
      const doneVendAck = valid(req?.approvals?.vendor?.ackDate);
      // Determine if new property is required
      const tentNewM = Number(req?.approvals?.vendor?.tentativeNewM||0);
      const tentNewF = Number(req?.approvals?.vendor?.tentativeNewF||0);
      const newRequired = (tentNewM + tentNewF) > 0 || ((req?.approvals?.vendor?.newProp||'').toLowerCase() === 'yes');
  // Vendor actual confirmation TAT: 7 days from BV approval (always shown)
  const startVendActual = doneBV || null;
      const doneVendActual = valid(req?.approvals?.vendor?.actualConfirmDate);
      // Finance Head decision TAT: 24h from Vendor Actual Confirmation (only when new onboarding exists)
      const actualNewTotal = Number(req?.approvals?.vendor?.actualNewM||0) + Number(req?.approvals?.vendor?.actualNewF||0);
      const financeRequired = !!doneVendActual && actualNewTotal > 0;
      const doneFinHead = valid(req?.finance?.head?.date);
      const startFinHead = financeRequired ? (doneVendActual || null) : null;
      // Finance payment TAT: 3 days from Finance Head APPROVAL to payment confirmation
      const finDecision = (req?.finance?.head?.decision || '').toLowerCase();
      const startFinPay = (finDecision === 'approve' && doneFinHead) ? doneFinHead : null;
      const doneFinPay = valid(req?.finance?.confirmDate);
      return {
        bv:      { key:'bv',      label:'BV Head',            start: startBV,      slaH: SLA_BV_HOURS,            doneAt: doneBV },
        sahi:    { key:'sahi',    label:'SAHI Head',          start: startSAHI,    slaH: SLA_SAHI_HOURS,          doneAt: doneSAHI },
        vendAck: { key:'vendAck', label:'Housing Partner Ack',start: startVendAck, slaH: SLA_VENDOR_ACK_HOURS,     doneAt: doneVendAck },
        vendActual: { key:'vendActual', label:'Housing Partner Actual', start: startVendActual, slaH: SLA_VENDOR_ACTUAL_HOURS, doneAt: doneVendActual },
        finHead: { key:'finHead', label:'Finance Head', start: startFinHead, slaH: SLA_FIN_HEAD_HOURS, doneAt: doneFinHead },
        finPay:  { key:'finPay',  label:'Finance Payment', start: startFinPay, slaH: SLA_FIN_PAYMENT_HOURS, doneAt: doneFinPay },
      };
    }

    function approvalStepStatus(step){
      // Returns {status:'pending'|'done'|'overdue'|'soon', remainingH, overdueH, dueAt}
      const now = nowISODateTime();
      if (!step.start) return { status: 'pending', remainingH: null, overdueH: null, dueAt: null };
      const dueAt = new Date(new Date(step.start).getTime() + step.slaH * 3600000).toISOString();
      if (step.doneAt) {
        return { status: 'done', remainingH: 0, overdueH: 0, dueAt };
      }
      const rem = hoursBetween(now, dueAt) !== null ? Math.ceil((new Date(dueAt) - new Date(now)) / 36e5) : null;
      if (rem !== null && rem < 0) return { status:'overdue', remainingH: 0, overdueH: Math.abs(rem), dueAt };
      if (rem !== null && rem <= DUE_SOON_THRESHOLD_HOURS) return { status:'soon', remainingH: rem, overdueH: 0, dueAt };
      return { status:'pending', remainingH: rem, overdueH: 0, dueAt };
    }

    function nextPendingApproval(req){
      const t = computeApprovalTats(req);
      if (!t.bv.doneAt) return { step: t.bv, stat: approvalStepStatus(t.bv) };
      if (!t.sahi.doneAt) return { step: t.sahi, stat: approvalStepStatus(t.sahi) };
      if (!t.vendAck.doneAt) return { step: t.vendAck, stat: approvalStepStatus(t.vendAck) };
      if (!t.vendActual.doneAt) return { step: t.vendActual, stat: approvalStepStatus(t.vendActual) };
      if (!t.finHead.doneAt) return { step: t.finHead, stat: approvalStepStatus(t.finHead) };
      if (!t.finPay.doneAt) return { step: t.finPay, stat: approvalStepStatus(t.finPay) };
      return null;
    }

    function computeStatusChip(req) {
      const { stage } = computeStage(req);
      if (stage === 'Completed') return { cls: 'ok', text: 'Completed' };
  if (stage === 'Closure Pending') return { cls: 'info', text: 'Closure Pending' };
      if (stage === 'Finance Pending') return { cls: 'warn', text: 'Finance Pending' };
      if (stage === 'Approvals') {
        const np = nextPendingApproval(req);
        if (np && (np.stat.status === 'overdue' || np.stat.status === 'soon')) {
          return { cls: np.stat.status === 'overdue' ? 'danger' : 'warn', text: np.stat.status === 'overdue' ? 'Approval Overdue' : 'Approval Due Soon' };
        }
        return { cls: 'warn', text: 'Pending Approvals' };
      }
      return { cls: 'info', text: stage };
    }

    function tatToNext(req) {
    const st = computeStage(req);
      const now = todayISO();
      switch (st.stage) {
        case 'Approvals': {
      const np = nextPendingApproval(req);
      if (!np || !np.step.start) return '—';
  const dueAt = new Date(new Date(np.step.start).getTime() + np.step.slaH * 3600000);
  const remH = Math.ceil((dueAt - new Date())/36e5);
  const label = np.step.key==='bv' ? 'BV' : np.step.key==='sahi' ? 'SAHI' : (np.step.key==='vendAck' ? 'Vendor Ack' : np.step.key==='vendActual' ? 'Vendor Actual' : np.step.key==='finHead' ? 'Finance Head' : 'Finance Payment');
  if (remH < 0) return `Overdue ${Math.abs(remH)}h (${label})`;
  if (remH > 24) return `${Math.ceil(remH/24)}d → ${label}`;
  return `${remH}h → ${label}`;
        }
        case 'Finance Pending': {
          const lastDate = req.approvals?.vendor?.date || req.approvals?.sahi?.date || req.approvals?.bv?.date || req.requestDate;
          return daysBetween(lastDate, now) + 'd';
        }
        case 'Closure Pending': {
          const lastDate = req.finance?.confirmDate || req.approvals?.vendor?.date || req.requestDate;
          const target = req.approvals?.vendor?.readyDate || req.approvals?.vendor?.tentativeMoveIn || now;
          const d = daysBetween(lastDate, target);
          return (d !== null ? d : 0) + 'd';
        }
        case 'Completed': return '—';
        default: {
          const hasRequest = !!req?.requestDate && Number(req?.beds?.total||0) > 0;
          return hasRequest ? (daysBetween(req.requestDate, now) + 'd') : '—';
        }
      }
    }

    function averageTatDays(list) {
      const completed = list.filter(r => computeStage(r).stage === 'Completed');
      if (completed.length === 0) return 0;
      const vals = completed.map(r => daysBetween(r.requestDate, r.final.vendorReadyDate) || 0);
      return Math.round(sum(vals) / vals.length);
    }
    function tatClass(req){
      const st = computeStage(req).stage;
      if (st === 'Approvals') {
        const np = nextPendingApproval(req);
        if (np) {
          if (np.stat.status === 'overdue') return 'overdue';
          if (np.stat.status === 'soon') return 'soon';
        }
        return '';
      }
      const n = parseInt(String(tatToNext(req)).replace(/\D/g,'')) || 0;
      if (st === 'Finance Pending' && n > settings.slaPayment) return 'overdue';
      if (st === 'Finance Pending' && n > Math.max(1, settings.slaPayment-1)) return 'soon';
  if (st === 'Closure Pending' && n > settings.slaReady) return 'overdue';
  if (st === 'Closure Pending' && n > Math.max(1, settings.slaReady-1)) return 'soon';
      return '';
    }

    // Drawer approval TAT badges
    function ensureTatBadge(containerInputSelector, text, status){
      const anchor = qs(containerInputSelector);
      if (!anchor) return;
      const card = anchor.closest('.card');
      if (!card) return;
      const h3 = card.querySelector('h3');
      if (!h3) return;
      let badge = h3.querySelector('.tat-badge');
      if (!badge) {
        badge = document.createElement('span');
        badge.className = 'tat-badge chip';
        badge.style.marginLeft = '8px';
        h3.appendChild(badge);
      }
      badge.className = 'tat-badge chip ' + (status==='overdue' ? 'danger' : status==='soon' ? 'warn' : 'info');
      badge.textContent = text;
    }

    function renderApprovalTatBadges(req){
      const t = computeApprovalTats(req||{});
      const upd = (step, sel) => {
        const st = approvalStepStatus(step);
  const label = step.key==='bv' ? 'BV' : step.key==='sahi' ? 'SAHI' : (step.key==='vendAck' ? 'Housing Partner Ack' : step.key==='vendActual' ? 'Housing Partner Actual' : step.key==='finHead' ? 'Finance Head' : step.key==='finPay' ? 'Finance Payment' : 'Vendor');
        let txt = `${label}: `;
        if (!step.start) txt += '—';
        else if (st.status === 'done') txt += 'Done';
        else if (st.status === 'overdue') txt += `Overdue ${st.overdueH}h`;
        else if (st.remainingH !== null) {
          if (st.remainingH > 24) txt += `${Math.ceil(st.remainingH/24)}d left`;
          else txt += `${st.remainingH}h left`;
        }
        else txt += '—';
        ensureTatBadge(sel, txt, st.status);
      };
      upd(t.bv, '#apprBVDate');
      upd(t.sahi, '#apprSAHIDate');
      // Vendor acknowledgement badge tied to ack checkbox
      upd(t.vendAck, '#vendorAck');
  // Vendor Actual Confirmation badge tied to an input within the Actual Confirmation card
  // This ensures the badge appears on the "Housing Partner - Actual Confirmation & Property Details" header consistently
  upd(t.vendActual, '#vendorActualConfirmDate');
      // Finance Head decision badge tied to head decision checkboxes
      upd(t.finHead, '#finFHApprove');
      // Finance Payment completion badge tied to payment confirm date field
      upd(t.finPay, '#finConfirmDate');
    }

    // Rendering
    function render() {
      // Summary
      qs('#totalRequests').textContent = state.requests.length;
      const pendingApprovals = state.requests.filter(r => computeStage(r).stage === 'Approvals').length;
      qs('#pendingApprovals').textContent = pendingApprovals;
      const avg = averageTatDays(state.requests);
      qs('#avgTat').textContent = avg + 'd';
      const bedsReq = sum(state.requests.map(r => r.beds?.total || 0));
      const vendorTotals = state.requests.map(r => (r.approvals?.vendor ? ((r.approvals.vendor.male||0)+(r.approvals.vendor.female||0)) : 0));
      const bedsAppr = sum(state.requests.map((r, i) => Math.min(vendorTotals[i], r.beds?.total || 0)));
      const bedsFinal = sum(state.requests.filter(r => computeStage(r).stage !== 'Approvals').map((r, i) => Math.min((r.approvals?.vendor ? ((r.approvals.vendor.male||0)+(r.approvals.vendor.female||0)) : 0), r.beds?.total || 0)));
      qs('#bedsSummary').textContent = bedsReq + ' / ' + bedsAppr + ' / ' + bedsFinal;

      // Keep client/year filter options synced with current data
      const cf = qs('#clientFilter');
      if (cf) {
        const prev = state.filters.client || 'all';
        const set = new Set(); state.requests.forEach(r => { if (r.clientName) set.add(r.clientName); });
        const list = Array.from(set).sort();
        cf.innerHTML = '<option value="all">All clients</option>' + list.map(c => `<option>${escapeHtml(c)}</option>`).join('');
        cf.value = (prev && (prev==='all' || list.includes(prev))) ? prev : 'all';
        state.filters.client = cf.value;
      }
      const yf = qs('#yearFilter');
      if (yf) {
        const prevY = String(state.filters.year||'');
        const years = new Set(); state.requests.forEach(r => { if (r.requestDate) { const y = new Date(r.requestDate).getFullYear(); if (!isNaN(y)) years.add(y); } });
        const ylist = Array.from(years).sort((a,b)=>a-b);
        yf.innerHTML = '<option value="">All years</option>' + ylist.map(y => `<option value="${y}">${y}</option>`).join('');
        yf.value = (prevY && ylist.map(String).includes(prevY)) ? prevY : '';
        state.filters.year = yf.value;
      }

      // Overdue count
      const overdue = state.requests.filter(r => tatClass(r)==='overdue').length;
      const elOverdue = qs('#overdueCount'); if (elOverdue) elOverdue.textContent = overdue;

      // Table
      const tbody = qs('#tableBody');
      tbody.innerHTML = '';
      const filtered = applyFilters([...state.requests]);
      const sorted = applySort(filtered);
      if (sorted.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 12; td.className = 'empty'; td.textContent = 'No matching requests.'; tr.appendChild(td); tbody.appendChild(tr); return;
      }
      for (const r of sorted) {
        const tr = document.createElement('tr');
        const stage = computeStage(r);
        const chip = computeStatusChip(r);
        const age = daysBetween(r.requestDate, todayISO());
        const progress = computeProgress(r);
        tr.innerHTML = `
          <td><button class="link-id" data-id="${r.id}" title="View timeline">${r.id}</button></td>
          <td>${escapeHtml(r.requestorName)}</td>
          <td>${escapeHtml(r.clientName||'')}</td>
          <td>${fmtDate(r.requestDate)}</td>
          <td>${r.beds.male}/${r.beds.female}/${r.beds.total}</td>
          <td>${stage.stage}${stage.next ? ' → ' + stage.next : ''}</td>
          <td><span class="chip ${chip.cls}">${chip.text}</span></td>
          <td class="tat-cell ${tatClass(r)}">${tatToNext(r)}</td>
          <td>${age !== null ? age + 'd' : '—'}</td>
          <td>
            <div class="progress" title="${progress}%">
              <span style="width:${progress}%;"></span>
            </div>
          </td>
          <td>
            <div class="row-actions">
              <button class="btn ghost" data-act="view" data-id="${r.id}">Open</button>
              <button class="btn primary" data-act="advance" data-id="${r.id}">Advance</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      }
    }

    function escapeHtml(str) { return (str||'').replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }

    function applyFilters(list) {
      const f = state.filters;
      const search = (f.search||'').trim().toLowerCase();
      return list.filter(r => {
        // Status
        const stage = computeStage(r);
        if (f.status === 'awaiting_approvals' && stage.stage !== 'Approvals') return false;
        if (f.status === 'finance_pending' && stage.stage !== 'Finance Pending') return false;
  if (f.status === 'payment_done' && stage.stage !== 'Closure Pending') return false;
  if (f.status === 'movein_ready' && stage.stage !== 'Closure Pending' && stage.stage !== 'Completed') return false; // close enough
        if (f.status === 'completed' && stage.stage !== 'Completed') return false;
        // Client
        if (f.client && f.client !== 'all') {
          if ((r.clientName||'') !== f.client) return false;
        }
        // Month / Year
        const rd = r.requestDate ? new Date(r.requestDate) : null;
        if (f.month) { const m = rd ? (rd.getMonth()+1) : null; if (m !== Number(f.month)) return false; }
        if (f.year) { const y = rd ? rd.getFullYear() : null; if (y !== Number(f.year)) return false; }
  // Dates (convert requestDate which may include time)
  if (f.from) { const rd2 = r.requestDate ? new Date(r.requestDate) : null; const from = new Date(f.from + 'T00:00'); if (rd2 && rd2 < from) return false; }
  if (f.to) { const rd2 = r.requestDate ? new Date(r.requestDate) : null; const to = new Date(f.to + 'T23:59:59'); if (rd2 && rd2 > to) return false; }
        // Quick chips
        if (f.quick === 'overdue' && tatClass(r) !== 'overdue') return false;
        if (f.quick === 'soon' && tatClass(r) !== 'soon') return false;
        // Search fields
        if (search) {
          const hay = [r.id, r.requestorName, r.notes, r.approvals?.vendor?.name].join(' ').toLowerCase();
          if (!hay.includes(search)) return false;
        }
        return true;
      });
    }

    function applySort(list) {
      const { key, dir } = state.sort;
      const d = dir === 'asc' ? 1 : -1;
      list.sort((a,b) => {
        const valA = sorterValue(a, key);
        const valB = sorterValue(b, key);
        if (valA < valB) return -1 * d; if (valA > valB) return 1 * d; return 0;
      });
      return list;
    }
    function sorterValue(r, key) {
      switch(key){
        case 'id': return r.id;
  case 'date': return r.requestDate ? new Date(r.requestDate).getTime() : 0;
        case 'requestor': return r.requestorName || '';
        case 'client': return r.clientName || '';
        case 'age': return daysBetween(r.requestDate, todayISO()) || 0;
        case 'tatNext': {
          const n = parseInt(String(tatToNext(r)).replace(/\D/g,'')) || 0; return n;
        }
        default: return '';
      }
    }

    // Drawer logic
    const drawer = qs('#drawer');
    const openDrawer = () => { drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false'); };
    const closeDrawer = () => { drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); state.selectedId = null; };

  function populateDrawer(req) {
      qs('#drawerTitle').textContent = req?.id ? 'Request ' + req.id : 'New Request';
      qs('#drawerSubtitle').textContent = req?.id ? 'Edit and progress the request' : 'Fill in request details and progress through steps';
  // Open drawer early to provide immediate feedback
  openDrawer();
      const set = (sel, val) => { const el = qs(sel); if (el) el.value = val ?? ''; };
    // Requestor handling: default Girish; allow override when Not Girish is checked
    const reqName = (req && req.requestorName) ? req.requestorName : 'Girish';
    set('#reqRequestor', reqName);
    const notG = qs('#reqNotGirish');
    const reqInput = qs('#reqRequestor');
    if (notG && reqInput) {
      const isNotG = (reqName || '').trim() !== 'Girish';
      notG.checked = isNotG;
      if (isNotG) { reqInput.removeAttribute('readonly'); reqInput.removeAttribute('title'); }
      else { reqInput.setAttribute('readonly',''); reqInput.setAttribute('title','Locked to Girish'); reqInput.value = 'Girish'; }
    }
    // Auto-capture request datetime for new drafts if not provided
    if (!req?.requestDate && !req?.id) {
      req.requestDate = nowISODateTime();
    }
    set('#reqDate', toLocalDatetimeValue(req?.requestDate) || '');
      set('#reqNotes', req?.notes || '');
      // client select setup with inline type-to-filter
      const sel = qs('#clientSelect'); const other = qs('#clientOther');
      if (sel) {
        const rebuild = (q='') => {
          sel.innerHTML = '';
          const add = (v,t=v) => { const o=document.createElement('option'); o.value=v; o.textContent=t; sel.appendChild(o); };
          add('', 'Select client');
          const norm = (s) => (s||'').toLowerCase();
          const needle = norm(q);
          const list = needle ? CLIENTS.filter(c => norm(c).startsWith(needle)) : CLIENTS;
          list.forEach(c=>add(c));
          add('__other__','Other (type manually)');
        };
        rebuild('');
        const current = req?.clientName || '';
        const otherWrap = other ? other.closest('.field') : null;
        if (current && !CLIENTS.includes(current)) {
          sel.value='__other__';
          if (other) {
            other.removeAttribute('disabled');
            other.value = current;
          }
          if (otherWrap) otherWrap.style.display = '';
        } else {
          sel.value = current || '';
          if (other) { other.value=''; other.setAttribute('disabled',''); }
          if (otherWrap) otherWrap.style.display = 'none';
        }
        // Inline type-to-filter: capture quick typing on the select's container
        let typeBuf = '';
        let lastTypeTs = 0;
        const TYPE_RESET_MS = 800;
        const container = sel.closest('.field') || sel;
        const handleType = (ch) => {
          const now = Date.now();
          if (now - lastTypeTs > TYPE_RESET_MS) typeBuf = '';
          lastTypeTs = now;
          typeBuf += ch;
          const prev = sel.value;
          rebuild(typeBuf);
          const hasPrev = Array.from(sel.options).some(o => o.value === prev);
          sel.value = hasPrev ? prev : '';
        };
        container.addEventListener('keydown', (e) => {
          if (e.ctrlKey || e.metaKey || e.altKey) return;
          const k = e.key;
          if (k === 'Backspace') { typeBuf = typeBuf.slice(0, -1); handleType(''); e.preventDefault(); return; }
          if (k.length === 1 && /[\w\s\-.,/()]/.test(k)) { handleType(k.toLowerCase()); e.preventDefault(); }
        });
        sel.onchange = () => {
          const v = sel.value;
          if (v==='__other__') {
            if (other) other.removeAttribute('disabled');
            if (otherWrap) otherWrap.style.display = '';
            other?.focus();
          } else {
            if (other){ other.value=''; other.setAttribute('disabled',''); }
            if (otherWrap) otherWrap.style.display = 'none';
          }
        };
      }
  set('#bedsMale', req?.beds?.male || 0);
      set('#bedsFemale', req?.beds?.female || 0);
      set('#bedsTotal', (req?.beds?.male || 0) + (req?.beds?.female || 0));
      // Weekly breakdown
      const bw = req?.bedsWeekly || [];
      const w = (i, k) => (bw[i] && typeof bw[i][k] === 'number') ? bw[i][k] : 0;
      set('#w1Male', w(0,'male')); set('#w1Female', w(0,'female'));
      set('#w2Male', w(1,'male')); set('#w2Female', w(1,'female'));
      set('#w3Male', w(2,'male')); set('#w3Female', w(2,'female'));
      set('#w4Male', w(3,'male')); set('#w4Female', w(3,'female'));
      set('#apprBVM', req?.approvals?.bv?.male || 0);
      set('#apprBVF', req?.approvals?.bv?.female || 0);
    set('#apprBVTotal', ((req?.approvals?.bv?.male||0)+(req?.approvals?.bv?.female||0)) || 0);
  set('#apprBVDate', toLocalDatetimeValue(req?.approvals?.bv?.date) || '');
      set('#apprBVNotes', req?.approvals?.bv?.remarks || '');
  // BV approve checkbox reflects date presence
  const bvTick = qs('#apprBVApprove'); if (bvTick) bvTick.checked = !!(req?.approvals?.bv?.date);
      if (req?.approvals?.bv?.date) { qs('#apprBVM')?.setAttribute('disabled',''); qs('#apprBVF')?.setAttribute('disabled',''); }
      set('#apprSAHIM', req?.approvals?.sahi?.male || 0);
      set('#apprSAHIF', req?.approvals?.sahi?.female || 0);
    set('#apprSAHITotal', ((req?.approvals?.sahi?.male||0)+(req?.approvals?.sahi?.female||0)) || 0);
  set('#apprSAHIDate', toLocalDatetimeValue(req?.approvals?.sahi?.date) || '');
      set('#apprSAHINotes', req?.approvals?.sahi?.remarks || '');
  const sahiTick = qs('#apprSAHIApprove'); if (sahiTick) sahiTick.checked = !!(req?.approvals?.sahi?.date);
      if (req?.approvals?.sahi?.date) { qs('#apprSAHIM')?.setAttribute('disabled',''); qs('#apprSAHIF')?.setAttribute('disabled',''); }
      // Enable approve only if counts are > 0
      const toggleApproveEnablers = () => {
  const reqTotal = Number(qs('#bedsTotal')?.value||0);
  const allowZeroFlow = (reqTotal === 0);
  const bvSum = Number(qs('#apprBVM')?.value||0) + Number(qs('#apprBVF')?.value||0);
  const sahiSum = Number(qs('#apprSAHIM')?.value||0) + Number(qs('#apprSAHIF')?.value||0);
  const bvApprove = qs('#apprBVApprove'); if (bvApprove) bvApprove.disabled = allowZeroFlow ? false : !(bvSum > 0);
  const sahiApprove = qs('#apprSAHIApprove'); if (sahiApprove) sahiApprove.disabled = allowZeroFlow ? false : !(sahiSum > 0);
        const vendAck = qs('#vendorAck');
        if (vendAck) {
          vendAck.disabled = (reqTotal === 0);
          if (vendAck.disabled) { vendAck.checked = false; const dt=qs('#vendorAckDate'); if (dt) dt.value=''; }
        }
      };
      toggleApproveEnablers();
      // removed Finance Head fields
      set('#apprVendorM', req?.approvals?.vendor?.male || 0);
      set('#apprVendorF', req?.approvals?.vendor?.female || 0);
    set('#apprVendorTotal', ((req?.approvals?.vendor?.male||0)+(req?.approvals?.vendor?.female||0)) || 0);
  set('#apprVendorDate', toLocalDatetimeValue(req?.approvals?.vendor?.date) || '');
      set('#vendorName', req?.approvals?.vendor?.name || '');
      set('#vendorReadyDate', req?.approvals?.vendor?.readyDate || '');
      set('#vendorNewProp', req?.approvals?.vendor?.newProp || 'no');
      set('#vendorIdentifyDate', req?.approvals?.vendor?.identifyDate || '');
  set('#vendorTentativeMoveIn', req?.approvals?.vendor?.tentativeMoveIn || '');
  set('#vendorNotes', req?.approvals?.vendor?.notes || '');
  // New vendor fields
  const ack = !!req?.approvals?.vendor?.ack;
  const ackDateISO = req?.approvals?.vendor?.ackDate || '';
  const ackEl = qs('#vendorAck'); if (ackEl) ackEl.checked = ack;
  set('#vendorAckDate', toLocalDatetimeValue(ackDateISO));
  // Tentative breakdown (Existing vs New); fallback to aggregate if present
  let exM = (req?.approvals?.vendor?.tentativeExistM ?? req?.approvals?.vendor?.tentativeM) || 0;
  let exF = (req?.approvals?.vendor?.tentativeExistF ?? req?.approvals?.vendor?.tentativeF) || 0;
  let nwM = (req?.approvals?.vendor?.tentativeNewM ?? 0) || 0;
  let nwF = (req?.approvals?.vendor?.tentativeNewF ?? 0) || 0;
  // If not acknowledged, do not show any previously saved tentative counts (mask to 0)
  if (!ack) { exM = 0; exF = 0; nwM = 0; nwF = 0; }
  set('#vendorTentativeExistM', exM);
  set('#vendorTentativeExistF', exF);
  set('#vendorTentativeExistTotal', (Number(exM)||0) + (Number(exF)||0));
  set('#vendorTentativeNewM', nwM);
  set('#vendorTentativeNewF', nwF);
  // New Total should reflect only New M+F, not include Existing
  set('#vendorTentativeTotal', (Number(nwM)||0) + (Number(nwF)||0));
      set('#vendorIntimationBeds', req?.finance?.vendorIntimationBeds || 0);
  set('#vendorPerBedCost', '');
      set('#vendorSecurityDeposit', req?.finance?.securityDeposit ?? '');
  set('#vendorActualConfirmDate', toLocalDatetimeValue(req?.approvals?.vendor?.actualConfirmDate) || '');
  set('#vendorActualMoveInDate', toLocalDatetimeValue(req?.final?.actualMoveInDate) || '');
  set('#vendorIntimationDate', toLocalDatetimeValue(req?.finance?.vendorIntimationDate) || '');
      set('#vendorIntimationAmount', req?.finance?.vendorIntimationAmount ?? '');
      set('#vendorIntimationRemarks', req?.finance?.vendorIntimationRemarks || '');
      set('#finAmount', req?.finance?.amount ?? '');
      set('#finTerms', req?.finance?.terms || '');
  set('#finConfirmDate', toLocalDateValue(req?.finance?.confirmDate) || '');
  // Payment Date removed from UI; keep legacy data display removed
  set('#finTRN', req?.finance?.trn || '');
  // Finance Head decision populate
  const fh = req?.finance?.head || {};
  try {
    // Reflect persisted Finance Head decision into UI so gating works after reload
    const d = (fh.decision || '').toLowerCase();
    const aEl = qs('#finFHApprove'); const rEl = qs('#finFHReject'); const vEl = qs('#finFHReview');
    if (aEl && rEl && vEl) {
      aEl.checked = d === 'approve';
      rEl.checked = d === 'reject';
      vEl.checked = d === 'review';
    }
    const dtEl = qs('#finFHDate'); if (dtEl) dtEl.value = toLocalDatetimeValue(fh.date) || '';
    const remEl = qs('#finFHRemarks'); if (remEl) remEl.value = fh.remarks || '';
  } catch(_) {}
  const fhApprove = qs('#finFHApprove'); const fhReject = qs('#finFHReject'); const fhReview = qs('#finFHReview');
  if (fhApprove) fhApprove.checked = fh.decision === 'approve';
  if (fhReject) fhReject.checked = fh.decision === 'reject';
  if (fhReview) fhReview.checked = fh.decision === 'review';
  set('#finFHRemarks', fh.remarks || '');
  set('#finFHDate', toLocalDatetimeValue(fh.date) || '');
  set('#finalVendorReadyDate', toLocalDateValue(req?.final?.vendorReadyDate) || '');
  { const el = qs('#finalReadyAck'); if (el) el.checked = !!req?.final?.readyAck; }
  set('#finalReadyAckDate', toLocalDatetimeValue(req?.final?.readyAckDate) || '');
      set('#finalNotes', req?.final?.notes || '');
  // Associate totals
  const faM = Number(req?.final?.assocM||0); const faF = Number(req?.final?.assocF||0);
  set('#finalAssocM', faM); set('#finalAssocF', faF); const faT = qs('#finalAssocTotal'); if (faT) faT.value = String((faM||0)+(faF||0));

  // Finance payment proof and rental terms
  state.finPaymentProofs[state.selectedId || 'NEW'] = (req?.finance?.paymentProof ? [req.finance.paymentProof] : (state.finPaymentProofs[state.selectedId || 'NEW'] || []));
  state.finalRentalTerms[state.selectedId || 'NEW'] = (req?.final?.rentalTermsDoc ? [req.final.rentalTermsDoc] : (state.finalRentalTerms[state.selectedId || 'NEW'] || []));
  renderFinPaymentProofsList();
  renderFinalRentalTermsList();

  // Proofs render from saved request or temp cache for this draft
  state.tempProofs[state.selectedId || 'NEW'] = (req?.proofs && Array.isArray(req.proofs)) ? req.proofs : (state.tempProofs[state.selectedId || 'NEW'] || []);
  renderProofsList();

  state.editPinVerified = false;
  state.costPinVerified = false;
  state.vendorChecklistPinVerified = false;
  state.pinCache = {
    create: !req?.id,
    bv: !!req?.approvals?.bv?.date,
    sahi: false,
    vendor: false,
    finHead: false
  };
  lockRequestFormFields();
  bindLockedFieldHandlers();
  if (!req?.id) {
    unlockRequestFormFields();
    state.editPinVerified = true;
    state.costPinVerified = false;
  }
      // Secure Per Bed Cost until PIN
      const costEl = qs('#vendorPerBedCost');
      if (costEl) {
        costEl.dataset.savedValue = (req?.finance?.perBedCost ?? '') === '' ? '' : String(req.finance.perBedCost);
        costEl.value = '';
        costEl.setAttribute('disabled','');
        costEl.style.display = 'none';
      }
  const unlockBtn = qs('#unlockPerBedBtn');
  if (unlockBtn) unlockBtn.onclick = async () => { await ensureCostPin(); };
    updateStepper(req);
      updateDrawerStatus(req);
  updateApprovalBounds(); if (!!req?.approvals?.vendor?.ack) prefillVendorTentatives(); updateVendorEnablers();
      toggleVendorNewPropFields();
  // Populate Actual Confirmation & Property Details
  const client = req?.clientName || '';
  const setIf = (id, v) => { const el = qs(id); if (el) el.value = v; };
  setIf('#propClient', client);
  const prop = req?.approvals?.vendor?.property || {};
  setIf('#propOwnerName', prop.ownerName || '');
  setIf('#propCluster', prop.cluster || '');
  setIf('#propState', prop.state || '');
  setIf('#propCity', prop.city || '');
  setIf('#propType', prop.type || '');
  setIf('#propHouses', Number(prop.houses||0));
  setIf('#propRooms', Number(prop.rooms||0));
  setIf('#propCapacity', Number(prop.capacity||0));
  setIf('#propSecurityDeposit', Number(prop.securityDeposit||0));
  setIf('#propMonthlyRent', Number(prop.monthlyRent||0));
  setIf('#propElec', Number(prop.electricity||0));
  setIf('#propWater', Number(prop.water||0));
  // New per-bed fields: load saved or default; auto-fill from requestor if empty
  const assocFromReq = Number(req?.associateCharges?.assocDeduction||0);
  const procFromReq = Number(req?.associateCharges?.processingFee||0);
  const weFromReq = Number(req?.associateCharges?.waterElec||0);
  setIf('#propAssociateDeduction', (prop.associateDeductionPerBed ?? (assocFromReq||1500)));
  setIf('#propProcessingFee', (prop.processingFeePerBed ?? procFromReq));
  setIf('#propWaterElec', (prop.waterElecPerBed ?? weFromReq));
  // Checklist load
  const cl = req?.approvals?.vendor?.checklist || {};
  const on = (id, v) => { const el = qs(id); if (el) el.checked = !!v; };
  on('#chkMustWater', cl.mustWater);
  on('#chkMustVentilation', cl.mustVentilation);
  on('#chkMustLighting', cl.mustLighting);
  on('#chkMustToilets', cl.mustToilets);
  on('#chkMustCooking', cl.mustCooking);
  on('#chkMustDustbins', cl.mustDustbins);
  on('#chkMustHousekeeping', cl.mustHousekeeping);
  on('#chkMustFireExt', cl.mustFireExt);
  on('#chkMustFirstAid', cl.mustFirstAid);
  on('#chkMustEmergencyContacts', cl.mustEmergencyContacts);
  on('#chkMustPowerBackup', cl.mustPowerBackup);
  on('#chkMustCleaningRegular', cl.mustCleaningRegular);
  on('#chkMustGarbage', cl.mustGarbage);
  on('#chkMustPestControl', cl.mustPestControl);
  on('#chkMustGuestRegister', cl.mustGuestRegister);
  on('#chkMustCaretaker', cl.mustCaretaker);
  on('#chkPrefWifi', cl.prefWifi);
  on('#chkPrefWashing', cl.prefWashing);
  on('#chkPrefTV', cl.prefTV);
  on('#chkPrefShelves', cl.prefShelves);
  on('#chkPrefCharging', cl.prefCharging);
  on('#chkPrefMess', cl.prefMess);
  on('#chkPrefInduction', cl.prefInduction);
  on('#chkPrefFridge', cl.prefFridge);
  on('#chkPrefCCTV', cl.prefCCTV);
  on('#chkPrefOnsiteCaretaker', cl.prefOnsiteCaretaker);
  on('#chkPrefRecreation', cl.prefRecreation);
  on('#chkPrefHealthCheckups', cl.prefHealthCheckups);
  on('#chkPrefWarden', cl.prefWarden);
  on('#chkPrefBeds', cl.prefBeds);
  setIf('#vendorActualExistM', Number(req?.approvals?.vendor?.actualExistM||0));
  setIf('#vendorActualExistF', Number(req?.approvals?.vendor?.actualExistF||0));
  setIf('#vendorActualNewM', Number(req?.approvals?.vendor?.actualNewM||0));
  setIf('#vendorActualNewF', Number(req?.approvals?.vendor?.actualNewF||0));
  computeCostFields();
  updateVendorActualTotals();
  try { applyFinanceGate(); } catch(_) {}
  const vendConfirm = qs('#vendorConfirm'); if (vendConfirm) vendConfirm.checked = !!req?.approvals?.vendor?.confirm;
  const fhEl = qs('#financeHeadControls'); if (fhEl) fhEl.style.display = (vendConfirm && vendConfirm.checked && !isFinanceNotRequired()) ? '' : 'none';
  renderApprovalTatBadges(req);
      // Ensure tentative totals and ack enablement reflect loaded values
      try {
        const exM0 = Number(qs('#vendorTentativeExistM')?.value||0);
        const exF0 = Number(qs('#vendorTentativeExistF')?.value||0);
        const nwM0 = Number(qs('#vendorTentativeNewM')?.value||0);
        const nwF0 = Number(qs('#vendorTentativeNewF')?.value||0);
  if (qs('#vendorTentativeExistTotal')) qs('#vendorTentativeExistTotal').value = exM0 + exF0;
  if (qs('#vendorTentativeTotal')) qs('#vendorTentativeTotal').value = nwM0 + nwF0;
      } catch {}
  if (typeof toggleApproveEnablers==='function') toggleApproveEnablers();
      enhanceDateInputs();
  // Notify when starting a fresh draft
  if (!req?.id) { showToast('New draft started'); }
  // Wire Finance Head decision handlers
  setupFinanceHeadHandlers();
  // Apply finance/closure gate on load (default locked until approval)
  try { applyFinanceGate(); } catch(_) {}
  // Apply BV gate on load so SAHI/Vendor are locked until BV approves
  try { applyBVGates(); } catch(_) {}
    }

    // Proofs handling
    function renderProofsList(){
      const list = qs('#reqProofsList'); if (!list) return;
      const files = state.tempProofs[state.selectedId || 'NEW'] || [];
      list.innerHTML = '';
      files.forEach((p, idx) => {
        const card = document.createElement('div'); card.className = 'proof-card';
        const isImg = /^data:image\//.test(p.dataUrl);
        const thumb = isImg ? `<img class="proof-thumb" alt="proof" src="${p.dataUrl}">` : `<div class="proof-thumb" style="display:flex;align-items:center;justify-content:center;">PDF</div>`;
        const name = escapeHtml(p.name || ('file_'+(idx+1)));
        const sizeKB = Math.round((p.size||0) / 102.4) / 10;
        card.innerHTML = `${thumb}<div class="proof-meta">${name}<br/><span>${sizeKB} KB</span></div><div class="proof-actions"><a class="btn" href="${p.dataUrl}" target="_blank" download="${name}">Download</a><button class="btn danger" data-idx="${idx}">Remove</button></div>`;
        list.appendChild(card);
      });
      list.addEventListener('click', (e) => {
        const btn = e.target.closest('button.btn.danger'); if (!btn) return;
        const i = Number(btn.getAttribute('data-idx'));
        const key = state.selectedId || 'NEW';
        const arr = state.tempProofs[key] || [];
        arr.splice(i,1); state.tempProofs[key] = arr; renderProofsList();
      }, { once: true });
    }

    function renderFinPaymentProofsList(){
      const wrap = qs('#finPaymentProofsList'); if (!wrap) return; const arr = state.finPaymentProofs[state.selectedId || 'NEW'] || [];
      wrap.innerHTML = '';
      if (arr.length === 0) return;
      const p = arr[0];
      const isImg = /^data:image\//.test(p.dataUrl);
      const html = isImg ? `<img class="proof-thumb" alt="payment" src="${p.dataUrl}">` : `<div class="proof-thumb" style="display:flex;align-items:center;justify-content:center;">PDF</div>`;
      const card = document.createElement('div'); card.className = 'proof-card';
      const sizeKB = Math.round((p.size||0) / 102.4) / 10;
      card.innerHTML = `${html}<div class="proof-meta">${escapeHtml(p.name||'payment_proof')}<br/><span>${sizeKB} KB</span></div>`;
      wrap.appendChild(card);
    }

    function renderFinalRentalTermsList(){
      const wrap = qs('#finalRentalTermsList'); if (!wrap) return; const arr = state.finalRentalTerms[state.selectedId || 'NEW'] || [];
      wrap.innerHTML = '';
      if (arr.length === 0) return;
      const p = arr[0];
      const isImg = /^data:image\//.test(p.dataUrl);
      const html = isImg ? `<img class="proof-thumb" alt="rental terms" src="${p.dataUrl}">` : `<div class="proof-thumb" style="display:flex;align-items:center;justify-content:center;">PDF</div>`;
      const card = document.createElement('div'); card.className = 'proof-card';
      const sizeKB = Math.round((p.size||0) / 102.4) / 10;
      card.innerHTML = `${html}<div class="proof-meta">${escapeHtml(p.name||'rental_terms')}<br/><span>${sizeKB} KB</span></div>`;
      wrap.appendChild(card);
    }

    // Hook file inputs after init/populate
    document.addEventListener('change', async (e) => {
      if (!e.target.matches('#reqProofsInput')) return;
      const files = Array.from(e.target.files || []);
      const key = state.selectedId || 'NEW';
      const existing = state.tempProofs[key] || [];
      const additions = [];
      for (const f of files){
        const isExcel = (/^application\/(vnd\.openxmlformats-officedocument\.spreadsheetml\.sheet)$/.test(f.type)) || (/\.(xlsx|xlsm)$/i.test(f.name));
        const isPdf = /^application\/pdf$/.test(f.type) || /\.pdf$/i.test(f.name);
        const isImg = /^image\//.test(f.type);
        if (!(isImg || isPdf || isExcel)) { alert('Only images, PDF, or Excel (.xlsx/.xlsm) allowed'); continue; }
        if (f.size > 2 * 1024 * 1024) { alert('File too large (max 2 MB): '+f.name); continue; }
        let dataUrl;
        if (isExcel) {
          // Read as ArrayBuffer and convert to data URL with generic octet-stream type to keep size modest
          const buf = await f.arrayBuffer();
          const blob = new Blob([buf], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
          dataUrl = await new Promise((res) => { const r = new FileReader(); r.onload = () => res(r.result); r.readAsDataURL(blob); });
        } else {
          dataUrl = await new Promise(res => { const r = new FileReader(); r.onload = () => res(r.result); r.readAsDataURL(f); });
        }
        additions.push({ name: f.name, type: isExcel ? 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' : f.type, size: f.size, dataUrl });
      }
      state.tempProofs[key] = existing.concat(additions);
      renderProofsList();
      // reset input to allow re-adding same files
      e.target.value = '';
    });

    document.addEventListener('click', (e) => {
      if (!e.target.matches('#clearProofsBtn')) return;
      const key = state.selectedId || 'NEW';
      state.tempProofs[key] = [];
      renderProofsList();
    });

    // Finance payment proof upload
    document.addEventListener('change', async (e) => {
      if (!e.target.matches('#finPaymentProofInput')) return;
      const files = Array.from(e.target.files || []);
      const key = state.selectedId || 'NEW';
      let picked = null;
      for (const f of files){
        if (!/^(image\/.+|application\/pdf)$/.test(f.type)) { alert('Only images and PDF allowed'); continue; }
        if (f.size > 2 * 1024 * 1024) { alert('File too large (max 2 MB): '+f.name); continue; }
        const dataUrl = await new Promise(res => { const r = new FileReader(); r.onload = () => res(r.result); r.readAsDataURL(f); });
        picked = { name: f.name, type: f.type, size: f.size, dataUrl };
        break;
      }
      state.finPaymentProofs[key] = picked ? [picked] : [];
      renderFinPaymentProofsList();
      e.target.value = '';
    });
    document.addEventListener('click', (e) => {
      if (!e.target.matches('#finClearPaymentProofsBtn')) return;
      const key = state.selectedId || 'NEW'; state.finPaymentProofs[key] = []; renderFinPaymentProofsList();
    });

    // Final rental terms upload
    document.addEventListener('change', async (e) => {
      if (!e.target.matches('#finalRentalTermsInput')) return;
      const files = Array.from(e.target.files || []);
      const key = state.selectedId || 'NEW';
      let picked = null;
      for (const f of files){
        if (!/^(image\/.+|application\/pdf)$/.test(f.type)) { alert('Only images and PDF allowed'); continue; }
        if (f.size > 2 * 1024 * 1024) { alert('File too large (max 2 MB): '+f.name); continue; }
        const dataUrl = await new Promise(res => { const r = new FileReader(); r.onload = () => res(r.result); r.readAsDataURL(f); });
        picked = { name: f.name, type: f.type, size: f.size, dataUrl };
        break;
      }
      state.finalRentalTerms[key] = picked ? [picked] : [];
      renderFinalRentalTermsList();
      e.target.value = '';
    });
    document.addEventListener('click', (e) => {
      if (!e.target.matches('#finalClearRentalTermsBtn')) return;
      const key = state.selectedId || 'NEW'; state.finalRentalTerms[key] = []; renderFinalRentalTermsList();
    });

    // Requestor: Not Girish toggle to unlock/lock the name field
    document.addEventListener('change', (e) => {
      if (!e.target.matches('#reqNotGirish')) return;
      const cb = e.target;
      const inp = qs('#reqRequestor');
      if (!inp) return;
      if (cb.checked) {
        inp.removeAttribute('readonly'); inp.removeAttribute('title');
        if ((inp.value || '').trim() === 'Girish') inp.value = '';
        inp.focus();
      } else {
        inp.setAttribute('readonly',''); inp.setAttribute('title','Locked to Girish'); inp.value = 'Girish';
      }
    });

    function lockRequestFormFields(){
      const form = qs('#requestForm'); if (!form) return;
      qsa('input, select, textarea', form).forEach(el => {
        if (el.id === 'reqRequestor') return; // stays readonly
  // Allow Finance Head to act without global unlock
  if (['finFHApprove','finFHReject','finFHReview','finFHRemarks'].includes(el.id)) return;
        // Do not globally lock fields inside Finance area; finance gating manages them
        if (el.closest('#financeLockedArea')) return;
        // Do not globally lock fields inside Closure section; closure gating manages them
        if (el.closest('#closureSection')) return;
        if (el.hasAttribute('readonly')) return; // totals remain readonly, not disabled
        el.setAttribute('data-req-lock','1');
        el.setAttribute('disabled','');
      });
    }

    function unlockRequestFormFields(){
      const form = qs('#requestForm'); if (!form) return;
      qsa('[data-req-lock] ', form).forEach(el => {
        el.removeAttribute('disabled');
      });
      state.editPinVerified = true;
      state.pinCache.create = true;
  // Also unlock per-bed cost when global Unlock is used
  unlockCostField();
    }
    let requestLockHandlersBound = false;
    function bindLockedFieldHandlers(){
      if (requestLockHandlersBound) return;
      const form = qs('#requestForm'); if (!form) return;
      const activateControl = (el) => {
        if (!el) return;
        if (typeof el.click === 'function') {
          try { el.click(); } catch (_) { /* no-op */ }
        }
        if (typeof el.focus === 'function') {
          try { el.focus(); } catch (_) { /* no-op */ }
        }
        if (typeof el.select === 'function' && (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA')) {
          try { el.select(); } catch (_) { /* no-op */ }
        }
      };
      const maybeUnlock = async (target, evt) => {
        if (!target) return;
        const control = target.closest('[data-req-lock]');
        if (!control || !control.disabled) return;
        if (evt) { evt.preventDefault(); evt.stopPropagation(); }
        const ok = await ensureEditPin();
        if (!ok) return;
        requestAnimationFrame(() => activateControl(control));
      };
      form.addEventListener('pointerdown', async (e) => { await maybeUnlock(e.target, e); }, true);
      form.addEventListener('focusin', async (e) => { await maybeUnlock(e.target, e); }, true);
      requestLockHandlersBound = true;
    }

    async function ensureEditPin(){
      if (state.editPinVerified || state.pinCache.create) {
        state.editPinVerified = true;
        return true;
      }
      const pin = (await askPin({ title:'Enter PIN', subtitle:'Unlock request fields' })) || '';
      if (pin !== CREATE_PIN) { alert('Incorrect PIN'); return false; }
      state.pinCache.create = true;
      unlockRequestFormFields();
      bindLockedFieldHandlers();
      return true;
    }

    function unlockCostField(){
      const el = qs('#vendorPerBedCost'); if (!el) return;
      el.removeAttribute('disabled');
      if (el.dataset.savedValue) el.value = el.dataset.savedValue;
      el.style.display = '';
      state.costPinVerified = true;
    }

    async function ensureCostPin(){
      if (state.costPinVerified || state.pinCache.vendor) {
        state.costPinVerified = true;
        return true;
      }
      const pin = (await askPin({ title:'Enter PIN', subtitle:'Housing Partner PIN to view/update Per Bed Cost' })) || '';
      if (pin !== PIN_VENDOR) { alert('Incorrect PIN'); return false; }
      state.pinCache.vendor = true;
      unlockCostField();
      return true;
    }

    async function ensureVendorChecklistPin(){
      if (state.vendorChecklistPinVerified || state.pinCache.vendor) {
        state.vendorChecklistPinVerified = true;
        return true;
      }
      const pin = (await askPin({ title:'Enter PIN', subtitle:'Housing Partner PIN required to edit checklists' })) || '';
      if (pin !== PIN_VENDOR) { alert('Incorrect PIN'); return false; }
      state.pinCache.vendor = true;
      state.vendorChecklistPinVerified = true;
      return true;
    }

    function updateDrawerStatus(req){
      const progress = computeProgress(req||{});
      const st = computeStage(req||{});
      qs('#drawerStatus').textContent = `Stage: ${st.stage}${st.next? ' → '+st.next:''} | Progress ${progress}%`;
    }

    function updateStepper(req){
      const map = {
        request: !!req?.requestDate,
        bv: !!req?.approvals?.bv?.date,
        sahi: !!req?.approvals?.sahi?.date,
        vendor: !!req?.approvals?.vendor?.date,
  finance: (!!req?.finance?.confirmDate) || (!!req?.approvals?.vendor?.confirm && ((Number(req?.approvals?.vendor?.actualNewM||0) + Number(req?.approvals?.vendor?.actualNewF||0)) === 0)),
      };
      const order = ['request','bv','sahi','vendor','finance'];
      let firstPending = order.find(k => !map[k]) || null;
      qsa('.stepper .step').forEach(el => {
        const key = el.getAttribute('data-step');
        el.classList.toggle('done', !!map[key]);
        el.classList.toggle('active', key === firstPending);
      });
      qs('#s1text').textContent = map.request ? 'Saved ' + fmtDate((state.requests.find(r=>r.id===state.selectedId)||{}).requestDate) : 'Pending';
      qs('#s2text').textContent = map.bv ? 'Approved' : 'Pending';
      qs('#s3text').textContent = map.sahi ? 'Approved' : 'Pending';
      qs('#s4text').textContent = map.vendor ? 'Agreed' : 'Pending';
      qs('#s5text').textContent = map.finance ? 'Paid' : 'Pending';
    }

    // Create or update
  function collectFormData(existing) {
      const num = (id) => { const el = qs(id); return Number((el && el.value) || 0); };
      const val = (id) => { const el = qs(id); return (el && el.value) ? el.value : ''; };
      // Weekly totals drive requested counts
      const weekly = [1,2,3,4].map(i => ({ male: num('#w'+i+'Male'), female: num('#w'+i+'Female') }));
      const male = sum(weekly.map(w => w.male));
      const female = sum(weekly.map(w => w.female));
      const requestedTotal = male + female;
  // Per-gender bounds
  const boundsM = (x) => clamp(x, 0, male);
  const boundsF = (x) => clamp(x, 0, female);
  // Only persist approval counts after the corresponding approve tick (PIN) sets the date
  const bvApproved = !!(qs('#apprBVApprove')?.checked) && !!(qs('#apprBVDate')?.value);
  const sahiApproved = !!(qs('#apprSAHIApprove')?.checked) && !!(qs('#apprSAHIDate')?.value);
  const vendorApproved = !!(qs('#apprVendorDate')?.value);
  // Clamp typed values to UI-displayed per-gender limits as an extra safety net
  const bvmTyped = boundsM(num('#apprBVM')); const bvfTyped = boundsF(num('#apprBVF'));
  const sahiMaxM = Math.min(male, Number(qs('#apprBVM')?.value || 0));
  const sahiMaxF = Math.min(female, Number(qs('#apprBVF')?.value || 0));
  const sahimTyped = clamp(num('#apprSAHIM'), 0, sahiMaxM);
  const sahifTyped = clamp(num('#apprSAHIF'), 0, sahiMaxF);
  const vendMaxM = Math.min(male, Number(qs('#apprSAHIM')?.value || 0));
  const vendMaxF = Math.min(female, Number(qs('#apprSAHIF')?.value || 0));
  const vendmTyped = clamp(num('#apprVendorM'), 0, vendMaxM);
  const vendfTyped = clamp(num('#apprVendorF'), 0, vendMaxF);
  const bvm = bvApproved ? bvmTyped : (existing?.approvals?.bv?.male || 0);
  const bvf = bvApproved ? bvfTyped : (existing?.approvals?.bv?.female || 0);
  const sahim = sahiApproved ? sahimTyped : (existing?.approvals?.sahi?.male || 0);
  const sahif = sahiApproved ? sahifTyped : (existing?.approvals?.sahi?.female || 0);
  // vendor totals are ultimately derived from Actual Confirmation split (see below)
  // Tentative split (Existing/New) - only persist when vendor acknowledges; otherwise force-zero
  const tExM_t = num('#vendorTentativeExistM');
  const tExF_t = num('#vendorTentativeExistF');
  const tNewM_t = num('#vendorTentativeNewM');
  const tNewF_t = num('#vendorTentativeNewF');
  const vendAck = !!qs('#vendorAck')?.checked;
  const tExM = vendAck ? tExM_t : 0;
  const tExF = vendAck ? tExF_t : 0;
  const tNewM = vendAck ? tNewM_t : 0;
  const tNewF = vendAck ? tNewF_t : 0;
  const tentM = tExM + tNewM;
  const tentF = tExF + tNewF;
  const tentTotal = tentM + tentF;
      // Validation basics handled by weekly totals
      // No approvals can exceed requested
  const req = existing ? { ...existing } : { id: genId(), history: [] };
  // Requestor name: allow override when Not Girish is ticked
  const notG = !!qs('#reqNotGirish')?.checked;
  const typedReq = val('#reqRequestor').trim();
  req.requestorName = notG ? (typedReq || 'Girish') : 'Girish';
      req.requestDate = val('#reqDate');
      req.notes = val('#reqNotes');
      // Requestor per-bed charges
      const assocDeductionRaw = qs('#reqAssocDeduction')?.value ?? '';
      const processingFeeRaw = qs('#reqProcessingFee')?.value ?? '';
      const waterElecRaw = qs('#reqWaterElec')?.value ?? '';
      const prevCharges = existing?.associateCharges || {};
      const assocDeductionVal = assocDeductionRaw !== ''
        ? Number(assocDeductionRaw)
        : (existing ? Number(prevCharges.assocDeduction || 0) : 0);
      const processingFeeVal = processingFeeRaw !== ''
        ? Number(processingFeeRaw)
        : (existing ? Number(prevCharges.processingFee || 0) : 0);
      const waterElecVal = waterElecRaw !== ''
        ? Number(waterElecRaw)
        : (existing ? Number(prevCharges.waterElec || 0) : 0);
      req.associateCharges = {
        assocDeduction: assocDeductionVal,
        processingFee: processingFeeVal,
        waterElec: waterElecVal
      };
      req.clientName = (qs('#clientSelect')?.value === '__other__') ? val('#clientOther') : (qs('#clientSelect')?.value || '');
      // Enforce client as required (block save here by throwing; caught by onSave)
      if (!req.clientName || String(req.clientName).trim() === '') {
        throw new Error('Please select a Client or choose Other and type the client name.');
      }
  req.beds = { male, female, total: requestedTotal };
  // Persist proofs (array of {name,type,size,dataUrl})
  const proofs = state.tempProofs[state.selectedId || 'NEW'] || [];
  req.proofs = proofs.slice(0, 20); // limit to 20 items to control storage size
      req.bedsWeekly = weekly.map(w => ({ male: Number(w.male||0), female: Number(w.female||0), total: Number(w.male||0) + Number(w.female||0) }));
      // Collect Actual Confirmation (drives approvals.vendor totals)
      const aExistM = Number(qs('#vendorActualExistM')?.value||0);
      const aExistF = Number(qs('#vendorActualExistF')?.value||0);
      const aNewM = Number(qs('#vendorActualNewM')?.value||0);
      const aNewF = Number(qs('#vendorActualNewF')?.value||0);
  const actualM = clamp(aExistM + aNewM, 0, male);
  const actualF = clamp(aExistF + aNewF, 0, female);
      const vendorConfirm = !!qs('#vendorConfirm')?.checked;
      const vendorActualConfirmDate = val('#vendorActualConfirmDate');
      // Allow saving incomplete property details; treat absent values as empty or 0
      const property = {
        ownerName: val('#propOwnerName') || '',
        cluster: val('#propCluster') || '', state: val('#propState') || '', city: val('#propCity') || '',
        client: val('#propClient') || '', type: val('#propType') || '',
        houses: Number(qs('#propHouses')?.value||0), rooms: Number(qs('#propRooms')?.value||0), capacity: Number(qs('#propCapacity')?.value||0),
        securityDeposit: val('#propSecurityDeposit') ? Number(qs('#propSecurityDeposit')?.value||0) : 0,
        monthlyRent: val('#propMonthlyRent') ? Number(qs('#propMonthlyRent')?.value||0) : 0,
        electricity: val('#propElec') ? Number(qs('#propElec')?.value||0) : 0,
        water: val('#propWater') ? Number(qs('#propWater')?.value||0) : 0,
        associateDeductionPerBed: val('#propAssociateDeduction') ? Number(qs('#propAssociateDeduction')?.value||0) : 0,
        processingFeePerBed: val('#propProcessingFee') ? Number(qs('#propProcessingFee')?.value||0) : 0,
        waterElecPerBed: val('#propWaterElec') ? Number(qs('#propWaterElec')?.value||0) : 0
      };
      const checklist = {
        mustWater: !!qs('#chkMustWater')?.checked,
        mustVentilation: !!qs('#chkMustVentilation')?.checked,
        mustLighting: !!qs('#chkMustLighting')?.checked,
        mustToilets: !!qs('#chkMustToilets')?.checked,
        mustCooking: !!qs('#chkMustCooking')?.checked,
        mustDustbins: !!qs('#chkMustDustbins')?.checked,
        mustHousekeeping: !!qs('#chkMustHousekeeping')?.checked,
        mustFireExt: !!qs('#chkMustFireExt')?.checked,
        mustFirstAid: !!qs('#chkMustFirstAid')?.checked,
        mustEmergencyContacts: !!qs('#chkMustEmergencyContacts')?.checked,
        mustPowerBackup: !!qs('#chkMustPowerBackup')?.checked,
        mustCleaningRegular: !!qs('#chkMustCleaningRegular')?.checked,
        mustGarbage: !!qs('#chkMustGarbage')?.checked,
        mustPestControl: !!qs('#chkMustPestControl')?.checked,
        mustGuestRegister: !!qs('#chkMustGuestRegister')?.checked,
        mustCaretaker: !!qs('#chkMustCaretaker')?.checked,
        prefWifi: !!qs('#chkPrefWifi')?.checked,
        prefWashing: !!qs('#chkPrefWashing')?.checked,
        prefTV: !!qs('#chkPrefTV')?.checked,
        prefShelves: !!qs('#chkPrefShelves')?.checked,
        prefCharging: !!qs('#chkPrefCharging')?.checked,
        prefMess: !!qs('#chkPrefMess')?.checked,
        prefInduction: !!qs('#chkPrefInduction')?.checked,
        prefFridge: !!qs('#chkPrefFridge')?.checked,
        prefCCTV: !!qs('#chkPrefCCTV')?.checked,
        prefOnsiteCaretaker: !!qs('#chkPrefOnsiteCaretaker')?.checked,
        prefRecreation: !!qs('#chkPrefRecreation')?.checked,
        prefHealthCheckups: !!qs('#chkPrefHealthCheckups')?.checked,
        prefWarden: !!qs('#chkPrefWarden')?.checked,
        prefBeds: !!qs('#chkPrefBeds')?.checked
      };
  // Gate vendor totals persistence by vendor approval date AND vendor confirmation (PIN)
  const saveVendorTotals = vendorApproved && vendorConfirm;
  const vendm = saveVendorTotals ? actualM : (existing?.approvals?.vendor?.male || 0);
  const vendf = saveVendorTotals ? actualF : (existing?.approvals?.vendor?.female || 0);
  // Gate Actual & Property persistence behind Vendor Confirm PIN; otherwise keep existing values
  const saveActualBlock = vendorConfirm === true;
      req.approvals = {
        bv: { male: bvm, female: bvf, date: (bvApproved ? val('#apprBVDate') : (existing?.approvals?.bv?.date || '')), remarks: val('#apprBVNotes') },
        sahi: { male: sahim, female: sahif, date: (sahiApproved ? val('#apprSAHIDate') : (existing?.approvals?.sahi?.date || '')), remarks: val('#apprSAHINotes') },
        vendor: {
          male: vendm, female: vendf, date: (vendorApproved ? val('#apprVendorDate') : (existing?.approvals?.vendor?.date || '')), name: val('#vendorName'), readyDate: val('#vendorReadyDate'), newProp: val('#vendorNewProp'), identifyDate: val('#vendorIdentifyDate'), tentativeMoveIn: val('#vendorTentativeMoveIn'), notes: val('#vendorNotes'), ack: !!qs('#vendorAck')?.checked, ackDate: val('#vendorAckDate'),
          // store both split and aggregate for ease of use and backward compatibility
          tentativeExistM: tExM, tentativeExistF: tExF, tentativeNewM: tNewM, tentativeNewF: tNewF,
          tentativeM: tentM, tentativeF: tentF,
          // Only set tentative confirm date when acknowledged with non-zero; otherwise clear
          tentativeConfirmDate: (vendAck && tentTotal>0)
            ? (existing?.approvals?.vendor?.tentativeConfirmDate || nowISODateTime())
            : '',
          confirm: saveActualBlock ? true : (existing?.approvals?.vendor?.confirm || false),
          actualConfirmDate: saveActualBlock ? vendorActualConfirmDate : (existing?.approvals?.vendor?.actualConfirmDate || ''),
          actualExistM: saveActualBlock ? aExistM : (existing?.approvals?.vendor?.actualExistM || 0),
          actualExistF: saveActualBlock ? aExistF : (existing?.approvals?.vendor?.actualExistF || 0),
          actualNewM: saveActualBlock ? aNewM : (existing?.approvals?.vendor?.actualNewM || 0),
          actualNewF: saveActualBlock ? aNewF : (existing?.approvals?.vendor?.actualNewF || 0),
          // Always persist Property details so Housing Partner can draft/save without final confirmation
          property: property,
          // Always persist checklist so it stays ticked when Housing Partner section is unlocked
          checklist: checklist
        },
      };
  req.finance = {
        vendorIntimationDate: val('#vendorIntimationDate'),
        vendorIntimationBeds: num('#vendorIntimationBeds'),
        perBedCost: (() => {
          const el = qs('#vendorPerBedCost');
          const raw = val('#vendorPerBedCost');
          if (!state.costPinVerified || (el && el.hasAttribute('disabled'))) {
            return (existing && existing.finance && existing.finance.perBedCost !== undefined) ? existing.finance.perBedCost : '';
          }
          return raw ? Number(raw) : '';
        })(),
        securityDeposit: val('#vendorSecurityDeposit') ? Number(val('#vendorSecurityDeposit')) : '',
        amount: val('#finAmount') ? Number(val('#finAmount')) : '',
        terms: val('#finTerms'),
  confirmDate: val('#finConfirmDate'),
        trn: val('#finTRN'),
        head: (() => {
          const a = qs('#finFHApprove')?.checked;
          const r = qs('#finFHReject')?.checked;
          const v = qs('#finFHReview')?.checked;
          const remarks = val('#finFHRemarks');
          const date = val('#finFHDate');
          // Save whatever is already persisted unless a valid decision (with date) exists
          const prev = existing?.finance?.head || {};
          const decision = a ? 'approve' : r ? 'reject' : v ? 'review' : '';
          if (!decision) return prev; // nothing selected -> keep previous
          // Must have a date (set only after PIN) to accept; otherwise keep previous
          if (!date) return prev;
          return { decision, remarks, date };
        })()
      };
      // Persist optional payment proof (single) and closure rental terms doc (single)
      const payKey = state.selectedId || 'NEW';
      const payArr = state.finPaymentProofs[payKey] || [];
      req.finance.paymentProof = payArr[0] || null;
      const assocM = num('#finalAssocM');
      const assocF = num('#finalAssocF');
      const rtArr = (state.finalRentalTerms[payKey] || []);
      req.final = {
        vendorReadyDate: val('#finalVendorReadyDate'),
  readyAck: !!qs('#finalReadyAck')?.checked,
      // If acknowledgement is checked but date is empty (edge case), auto-stamp now
      readyAckDate: (() => { const chk = !!qs('#finalReadyAck')?.checked; const d = val('#finalReadyAckDate'); return (chk && !d) ? nowISODateTime() : d; })(),
        notes: val('#finalNotes'),
        actualMoveInDate: val('#vendorActualMoveInDate'),
        assocM: Number(assocM||0),
        assocF: Number(assocF||0),
        rentalTermsDoc: rtArr[0] || null
      };

  // Logical validations
  // If a Finance Head decision is selected but PIN/date not captured, block save
  // Enforce minimums for monetary fields
  const prevAC = existing?.associateCharges || {};
  const reqChargesChanged = (!existing) || (
    Number(prevAC.assocDeduction||0) !== Number(req.associateCharges.assocDeduction||0) ||
    Number(prevAC.processingFee||0) !== Number(req.associateCharges.processingFee||0) ||
    Number(prevAC.waterElec||0) !== Number(req.associateCharges.waterElec||0)
  );
  if ((!existing || reqChargesChanged) && Number(req?.associateCharges?.assocDeduction || 0) < 1500) {
    throw new Error('Associate Deduction (/Bed/Month) must be at least 1500 in Requestor section.');
  }
  // Only enforce Vendor Property minimum when Vendor Confirmation is set AND there is onboarding via New
  const vendorConfirmNow = !!(req?.approvals?.vendor?.confirm);
  const vendorActualNewTotal = Number(qs('#vendorActualNewM')?.value||0) + Number(qs('#vendorActualNewF')?.value||0);
  if (vendorConfirmNow && vendorActualNewTotal > 0 && Number(req?.approvals?.vendor?.property?.associateDeductionPerBed || 0) < 1500) {
    throw new Error('Associate Deduction (/Bed/Month) must be at least 1500 in Vendor Property details when onboarding NEW properties.');
  }
  // Determine if Finance is not required (existing capacity only)
  const noFinanceRequired = vendorConfirmNow && ((Number(req?.approvals?.vendor?.actualNewM||0) + Number(req?.approvals?.vendor?.actualNewF||0)) === 0);
  const fhA = !!qs('#finFHApprove')?.checked;
  const fhR = !!qs('#finFHReject')?.checked;
  const fhV = !!qs('#finFHReview')?.checked;
  const fhD = qs('#finFHDate')?.value || '';
  const failFinance = (msg) => { alert(msg); throw new Error(msg); };
  if (!noFinanceRequired && (fhA || fhR || fhV) && !fhD) { failFinance('Finance Head decision requires PIN (7281).'); }
  // Finance-specific validations with actionable popups
  const finDecision = currentFinanceDecision();
  const amountRaw = val('#finAmount');
  const amountNum = amountRaw === '' ? NaN : Number(amountRaw);
  const perBedRaw = val('#vendorPerBedCost');
  const perBedNum = perBedRaw === '' ? NaN : Number(perBedRaw);
  const secDepRaw = val('#vendorSecurityDeposit');
  const secDepNum = secDepRaw === '' ? NaN : Number(secDepRaw);
  // When Finance Head has approved, require a positive payment amount
  if (finDecision === 'approve') {
    if (!amountRaw || isNaN(amountNum) || amountNum <= 0) {
      failFinance('Finance: Payment Amount is required and must be greater than 0 after Finance Head approval.');
    }
  }
  // Basic numeric sanity (when provided)
  if (perBedRaw !== '' && (isNaN(perBedNum) || perBedNum <= 0)) {
    failFinance('Finance: Per Bed Cost must be a number greater than 0 when entered.');
  }
  if (secDepRaw !== '' && (isNaN(secDepNum) || secDepNum < 0)) {
    failFinance('Finance: Security Deposit must be a number and cannot be negative.');
  }
  // Date sanity for Finance dates relative to Request date
  const reqDateForFin = req.requestDate;
  if (req.finance.vendorIntimationDate && reqDateForFin && new Date(req.finance.vendorIntimationDate) < new Date(reqDateForFin)) {
    failFinance('Finance: Vendor Intimation date cannot be before Request date.');
  }
  // Allow same-day confirmation as Request: compare only by day (ignore time)
  const startOfDay = (s) => { const d = new Date(s); return new Date(d.getFullYear(), d.getMonth(), d.getDate()); };
  if (!noFinanceRequired && req.finance.confirmDate && reqDateForFin && startOfDay(req.finance.confirmDate) < startOfDay(reqDateForFin)) {
    failFinance('Finance: Confirmation date cannot be before Request date.');
  }
  // Closure-specific validations with actionable popups (all fields optional except PIN-backed acknowledgement)
  const readyAckChecked = !!qs('#finalReadyAck')?.checked;
  const readyAckDate = val('#finalReadyAckDate');
  if (readyAckChecked && !readyAckDate) {
    throw new Error('Closure: Ready Acknowledgement requires PIN (7280).');
  }
  const vrDate = val('#finalVendorReadyDate'); // optional (date-only)
  const amDate = val('#vendorActualMoveInDate'); // optional (datetime-local)
  if (amDate) {
    if (req.requestDate && new Date(amDate) < new Date(req.requestDate)) {
      throw new Error('Closure: Actual Move-in cannot be before Request date.');
    }
    if (vrDate && new Date(amDate) < new Date(vrDate)) {
      throw new Error('Closure: Actual Move-in cannot be before Vendor Move-in Ready date.');
    }
  }
  const assocMRaw = val('#finalAssocM');
  const assocFRaw = val('#finalAssocF');
  if (assocMRaw !== '' && (isNaN(Number(assocMRaw)) || Number(assocMRaw) < 0)) {
    throw new Error('Closure: Associate Move-in (M) must be a non-negative number.');
  }
  if (assocFRaw !== '' && (isNaN(Number(assocFRaw)) || Number(assocFRaw) < 0)) {
    throw new Error('Closure: Associate Move-in (F) must be a non-negative number.');
  }
      // Finance fields are UI-locked until Finance Head approves. Once unlocked, saving them is allowed with either Finance Head PIN or Housing Partner PIN (enforced below in ensurePinsForChanges).
      // Note: validateDates is invoked by onSave conditionally (to allow Closure-only ack saves).
      return req;
    }

    function validateDates(req){
      const fail = (msg) => { throw new Error(msg); };
      // Approvals not before request
      const after = (a,b,label) => { if (a && b && new Date(a) < new Date(b)) fail(label + ' cannot be before ' + b + ''); };
      after(req.requestDate, req.requestDate, ''); // no-op to keep identical pattern
      const r = req.requestDate;
      const a = req.approvals;
      if (a.bv.date && new Date(a.bv.date) < new Date(r)) fail('BV Head approval cannot be before Request date');
      if (a.sahi.date && new Date(a.sahi.date) < new Date(r)) fail('SAHI Head approval cannot be before Request date');
      if (a.vendor.date && new Date(a.vendor.date) < new Date(r)) fail('Vendor agreement cannot be before Request date');
      // Stage order: cannot approve later stages before earlier ones
      if (a.sahi.date && !a.bv.date) fail('SAHI Head approval cannot be recorded before BV Head approval');
      if (a.vendor.date && !a.sahi.date) fail('Vendor agreement cannot be recorded before SAHI Head approval');
    const noFinanceRequired = !!a.vendor?.confirm && ((Number(a.vendor.actualNewM||0)+Number(a.vendor.actualNewF||0))===0);
    if (req.finance.vendorIntimationDate && new Date(req.finance.vendorIntimationDate) < new Date(r)) fail('Vendor intimation cannot be before Request date');
  // Allow same-day finance confirmation: compare at day granularity
  const sod = (s) => { const d = new Date(s); return new Date(d.getFullYear(), d.getMonth(), d.getDate()); };
  if (!noFinanceRequired && req.finance.confirmDate && sod(req.finance.confirmDate) < sod(r)) fail('Finance confirmation cannot be before Request date');
  // Payment Date removed from UI; legacy validations skipped
      if (req.final.vendorReadyDate && new Date(req.final.vendorReadyDate) < new Date(r)) fail('Vendor ready date cannot be before Request date');
      // Per-gender and stage-cascade constraints
      const reqM = Number(req?.beds?.male||0);
      const reqF = Number(req?.beds?.female||0);
      const reqTotal = reqM + reqF;
      ['bv','sahi','vendor'].forEach(k=>{
        const m=(req.approvals[k].male||0), f=(req.approvals[k].female||0);
        if (m<0||f<0) fail('Approved beds cannot be negative');
        if (m > reqM) fail('Approved male beds cannot exceed requested male beds');
        if (f > reqF) fail('Approved female beds cannot exceed requested female beds');
        if (m+f > reqTotal) fail('Approved beds cannot exceed requested total');
      });
      // Cascade: SAHI <= BV, Vendor <= SAHI (per gender)
      if ((a.sahi.male||0) > (a.bv.male||0)) fail('SAHI male approvals cannot exceed BV male approvals');
      if ((a.sahi.female||0) > (a.bv.female||0)) fail('SAHI female approvals cannot exceed BV female approvals');
      if ((a.vendor.male||0) > (a.sahi.male||0)) fail('Vendor male approvals cannot exceed SAHI male approvals');
      if ((a.vendor.female||0) > (a.sahi.female||0)) fail('Vendor female approvals cannot exceed SAHI female approvals');
      // Vendor timeline consistency for NEW onboarding is enforced only after Vendor confirms actuals
      if (a.vendor.confirm && a.vendor.newProp === 'yes') {
        if (!a.vendor.identifyDate) fail('Tentative identify date required when new property is needed');
        if (!a.vendor.tentativeMoveIn) fail('Tentative move-in date required when new property is needed');
      }
      // If Actual Confirmation present, enforce Actual per-gender ≤ SAHI; also capacity sanity for NEW onboarding only
      if (a.vendor?.confirm) {
        const am = Number(a.vendor.actualExistM||0) + Number(a.vendor.actualNewM||0);
        const af = Number(a.vendor.actualExistF||0) + Number(a.vendor.actualNewF||0);
        if (am > (a.sahi.male||0)) fail('Actual male beds cannot exceed SAHI male approvals');
        if (af > (a.sahi.female||0)) fail('Actual female beds cannot exceed SAHI female approvals');
        const cap = Number(a.vendor?.property?.capacity||0);
        const newTot = Number(a.vendor.actualNewM||0) + Number(a.vendor.actualNewF||0);
        // Capacity refers to NEW onboarding accommodation; it must be at least Actual via New total
        if (newTot > 0 && cap > 0 && cap < newTot) fail('Accommodation Capacity (Beds) must be >= Actual via New (M+F)');
      }
    }

    // Compile friendly validation errors for the "Housing Partner - Actual Confirmation & Property Details" section.
    // This runs before we collect and persist data so users see exactly what's missing/incorrect.
  function compileVendorSectionIssues(existing){
      const issues = [];
      const val = (id) => { const el = qs(id); return el ? (el.value ?? '') : ''; };
      const num = (id) => { const el = qs(id); return Number(el && el.value ? el.value : 0); };
      const has = (id) => { const v = val(id); return v !== null && v !== undefined && String(v).trim() !== ''; };
      const checked = (id) => !!qs(id)?.checked;

      // Only validate if this section has been explicitly interacted with to avoid noise
      // Do NOT treat autopopulated property fields as "touched".
      const vendorTouched = (
        checked('#vendorConfirm') || checked('#vendorAck') ||
        num('#vendorActualExistM')>0 || num('#vendorActualExistF')>0 || num('#vendorActualNewM')>0 || num('#vendorActualNewF')>0
      );
      if (!vendorTouched) return issues;

      // If SAHI not approved yet, skip vendor validation entirely (user hasn't reached this section legitimately)
      const sahiApproved = !!(qs('#apprSAHIDate')?.value || (existing?.approvals?.sahi?.date || ''));
      if (!sahiApproved) return issues;

      // Actuals vs SAHI constraints
      const aExM = num('#vendorActualExistM');
      const aExF = num('#vendorActualExistF');
      const aNewM = num('#vendorActualNewM');
      const aNewF = num('#vendorActualNewF');
      const actM = aExM + aNewM;
      const actF = aExF + aNewF;
      const sahiM = Number(qs('#apprSAHIM')?.value || existing?.approvals?.sahi?.male || 0);
      const sahiF = Number(qs('#apprSAHIF')?.value || existing?.approvals?.sahi?.female || 0);
      if (actM < 0 || actF < 0) issues.push('Actual counts cannot be negative.');
      if (actM > sahiM) issues.push(`Actual male beds cannot exceed SAHI approved male beds (${sahiM}).`);
      if (actF > sahiF) issues.push(`Actual female beds cannot exceed SAHI approved female beds (${sahiF}).`);

      // If confirming actuals AND onboarding via NEW, require property details and monetary constraints
      const vendorConfirm = checked('#vendorConfirm');
      const totalNew = aNewM + aNewF;
      if (vendorConfirm && totalNew > 0) {
        const confirmDate = val('#vendorActualConfirmDate');
        if (!confirmDate) issues.push('Complete the Housing Partner PIN to confirm actuals (use the Tick to confirm checkbox).');

        const owner = val('#propOwnerName').trim();
        const state = val('#propState').trim();
        const city = val('#propCity').trim();
        const type = val('#propType').trim();
        const capacity = num('#propCapacity');
        const monthlyRent = num('#propMonthlyRent');
        const assocDeduction = num('#propAssociateDeduction');
        const newProp = (val('#vendorNewProp') || '').toLowerCase();
        const identifyDate = val('#vendorIdentifyDate');
        const tentativeMoveIn = val('#vendorTentativeMoveIn');

        if (!owner) issues.push('Property Owner Name is required on confirmation.');
        if (!state) issues.push('Property State is required on confirmation.');
        if (!city) issues.push('Property City is required on confirmation.');
        if (!type) issues.push('Property Type is required on confirmation.');
  if (!(capacity > 0)) issues.push('Property Capacity must be greater than 0 when onboarding NEW properties.');
  if (!(monthlyRent > 0)) issues.push('Monthly Rent must be greater than 0 when onboarding NEW properties.');
  if (assocDeduction < 1500) issues.push('Associate Deduction (/Bed/Month) must be at least 1500 when onboarding NEW properties.');
        if (newProp === 'yes') {
          if (!identifyDate) issues.push('For New Property = Yes, Identification Date is required.');
          if (!tentativeMoveIn) issues.push('For New Property = Yes, Tentative Move-in is required.');
        }

        const cap = capacity;
        const totalNew = aNewM + aNewF;
        if (totalNew > 0 && cap > 0 && cap < totalNew) issues.push('Accommodation Capacity (Beds) must be >= Actual via New (M+F).');
      }

      return issues;
    }

    function genId() { const n = Math.max(1000, ...state.requests.map(r => Number(r.id?.split('-')[1]||1000))) + 1; return 'REQ-' + n; }

    // Finance Head decision handling: mutually exclusive checkboxes with PIN gating
    function setupFinanceHeadHandlers(){
      const a = qs('#finFHApprove');
      const r = qs('#finFHReject');
      const v = qs('#finFHReview');
      const dateEl = qs('#finFHDate');
      if (!a || !r || !v) return;
      if (a.dataset.fhBound === '1') return; // already bound
      const group = [a,r,v];
      const setExclusive = (sel) => {
        group.forEach(el => { if (el !== sel) el.checked = false; });
      };
      const onPick = async (el) => {
        if (!el.checked) return; // only react on checking
        // Ask PIN
        const pin = await askPin({ title: 'Enter PIN', subtitle: 'Finance Head authorization required', label: 'PIN' });
        if (pin !== PIN_FIN_HEAD) { alert('Incorrect PIN'); el.checked = false; return; }
        state.pinCache.finHead = true;
        setExclusive(el);
        if (dateEl) dateEl.value = nowLocalDatetimeValue();
        // Reflect lock state whenever a decision is made
        applyFinanceGate();
      };
      group.forEach(el => {
        el.addEventListener('change', () => onPick(el));
      });
      // mark bound
      a.dataset.fhBound = r.dataset.fhBound = v.dataset.fhBound = '1';
    }

  // Determine Finance Head decision from UI
  function currentFinanceDecision(){
    const a = !!qs('#finFHApprove')?.checked;
    const r = !!qs('#finFHReject')?.checked;
    const v = !!qs('#finFHReview')?.checked;
    return a ? 'approve' : r ? 'reject' : v ? 'review' : '';
  }

  // Apply lock/unlock to the finance and closure sections
  function setSectionLocked(sectionId, locked){
    const sec = qs('#'+sectionId); if (!sec) return;
    sec.classList.toggle('locked', !!locked);
    if (locked) sec.setAttribute('aria-disabled','true'); else sec.removeAttribute('aria-disabled');
    // Disable/enable inputs while preserving pre-existing disabled state
    qsa('input, select, textarea, button', sec).forEach(el => {
      // Always keep Finance Head decision controls interactive
      const id = el.id || '';
      const isFHCtrl = ['finFHApprove','finFHReject','finFHReview','finFHRemarks','finFHDate'].includes(id);
      if (isFHCtrl) return;
      if (locked) {
        el.dataset.prevDisabled = el.disabled ? '1' : (el.dataset.prevDisabled || '0');
        el.disabled = true;
      } else {
        // For Finance area specifically, force-enable inputs when unlocking
        if (sectionId === 'financeLockedArea' || sectionId === 'closureSection') {
          el.disabled = false;
        } else {
          // Only re-enable if we disabled it (prevDisabled === '0')
          if (el.dataset.prevDisabled === '0') el.disabled = false;
        }
        delete el.dataset.prevDisabled;
      }
    });
  }

  function applyFinanceGate(){
    const banner = qs('#financeInfoBanner');
    const fhControls = qs('#financeHeadControls');
    const finArea = qs('#financeLockedArea');
    const vendConfirmed = !!qs('#vendorConfirm')?.checked;
    const readyAcked = !!qs('#finalReadyAck')?.checked;

    // Default: hide banner
    if (banner) { banner.classList.remove('show'); banner.style.display = 'none'; }

    // If Housing Partner hasn't confirmed yet, do not unlock Finance Head controls
    if (!vendConfirmed) {
      if (fhControls) fhControls.style.display = 'none';
      if (finArea) finArea.style.display = '';
      setSectionLocked('financeLockedArea', true);
      // Even if vendor hasn't confirmed, if closure ack is already provided (editing existing), allow closure section
      setSectionLocked('closureSection', !readyAcked);
      return;
    }

    // Vendor confirmed. Determine if finance is not required (existing capacity only)
    const isNoNewOnboarding = isFinanceNotRequired();
    if (isNoNewOnboarding) {
      if (banner) { banner.classList.add('show'); banner.style.display = ''; }
      if (fhControls) fhControls.style.display = 'none';
      if (finArea) finArea.style.display = 'none';
      setSectionLocked('closureSection', false);
      return;
    }

    // Finance is required for new onboarding: show Finance Head controls and keep finance/closure locked until approved
    if (fhControls) fhControls.style.display = '';
    if (finArea) finArea.style.display = '';
    const dec = currentFinanceDecision();
    const unlock = (dec === 'approve');
    setSectionLocked('financeLockedArea', !unlock);
    // If Ready Acknowledgement is already ticked, always unlock closure to allow Save & Close
    setSectionLocked('closureSection', !(unlock || readyAcked));
  }

  // Finance not required helper
  function isFinanceNotRequired(){
    // Condition: Vendor Actual Confirmation is set, and actual via New is zero for both genders
    const vendConfirm = !!qs('#vendorConfirm')?.checked;
    const aNewM = Number(qs('#vendorActualNewM')?.value||0);
    const aNewF = Number(qs('#vendorActualNewF')?.value||0);
    if (!vendConfirm) return false;
    return (aNewM + aNewF) === 0;
  }

  // BV gate: unlock SAHI and Vendor sections only after BV approves
  function applyBVGates(){
    const bvApproved = !!qs('#apprBVDate')?.value;
    const sahiApproved = !!qs('#apprSAHIDate')?.value;
    // SAHI unlocks after BV; Vendor unlocks after SAHI
    setSectionLocked('sahiSection', !bvApproved);
    setSectionLocked('vendorSection', !sahiApproved);
    // If vendor section is unlocked, explicitly enable vendor checklists regardless of totals
    if (sahiApproved) {
      const sec = qs('#vendorSection');
      if (sec) {
        sec.querySelectorAll('input[type="checkbox"][id^="chkMust"], input[type="checkbox"][id^="chkPref"]').forEach(el => {
          el.removeAttribute('disabled');
        });
      }
    }
  }

    // Ensure Tentative fields are zeroed in UI when not acknowledged
    function resetTentativesIfNotAck(){
      const ack = qs('#vendorAck');
      if (!ack || !ack.checked) {
        ['#vendorTentativeExistM','#vendorTentativeExistF','#vendorTentativeNewM','#vendorTentativeNewF'].forEach(sel=>{ const el = qs(sel); if (el) el.value = '0'; });
        // Update totals display
        const exTot = qs('#vendorTentativeExistTotal'); if (exTot) exTot.value = '0';
        const tTot = qs('#vendorTentativeTotal'); if (tTot) tTot.value = '0';
      }
    }

    // Event handlers
    async function onSave(closeAfter=false){
      try {
        const existing = state.requests.find(r => r.id === state.selectedId);
        const data = collectFormData(existing);
        // Run Vendor section validation only if vendor-related fields actually changed
        const hasVendorEdits = (() => {
          if (!existing) return false;
          const jstr = (x) => JSON.stringify(x ?? null);
          const objChanged = (a,b, keys) => keys.some(k => jstr(a?.[k]) !== jstr(b?.[k]));
          const sahiApproved = !!data?.approvals?.sahi?.date;
          if (!sahiApproved) return false;
          const tentKeys = ['tentativeExistM','tentativeExistF','tentativeNewM','tentativeNewF','tentativeM','tentativeF'];
          const vendKeys = ['male','female','date','name','readyDate','newProp','identifyDate','tentativeMoveIn','notes','ack','ackDate','confirm','actualConfirmDate','actualExistM','actualExistF','actualNewM','actualNewF'];
          const baseChanged = objChanged(existing?.approvals?.vendor, data?.approvals?.vendor, vendKeys);
          const tentChanged = (!!data?.approvals?.vendor?.ack) && objChanged(existing?.approvals?.vendor, data?.approvals?.vendor, tentKeys);
          const pa = existing?.approvals?.vendor?.property || {}; const pb = data?.approvals?.vendor?.property || {};
          const propKeys = ['ownerName','cluster','state','city','type','houses','rooms','capacity','securityDeposit','monthlyRent','electricity','water','associateDeductionPerBed','processingFeePerBed','waterElecPerBed'];
          // Normalize ''/undefined/null to the same sentinel so blanks don't trigger false change detection
          const norm = (v) => (v === '' || v === undefined || v === null) ? null : v;
          const propChanged = propKeys.some(k => norm(pa[k]) !== norm(pb[k]));
          // Only consider property edits for vendor validation if Vendor Confirm is true (we enforce property only on confirmation)
          const considerProp = data?.approvals?.vendor?.confirm === true;
          return baseChanged || tentChanged || (considerProp && propChanged);
        })();
        if (hasVendorEdits) {
          const vIssues = compileVendorSectionIssues(existing);
          if (vIssues.length) {
            const msg = 'Cannot save Housing Partner - Actual Confirmation & Property Details:\n\n- ' + vIssues.join('\n- ');
            alert(msg);
            throw new Error(msg);
          }
        }
        // For existing records, require relevant PINs for sections edited since last save
        await ensurePinsForChanges(existing, data);
        // Conditionally run cross-section date validations: skip when only closure ack-related fields changed
        if (existing) {
          const jstr = (x) => JSON.stringify(x ?? null);
          const closureKeys = ['vendorReadyDate','readyAck','readyAckDate'];
          const closureChangedOnly = (() => {
            // Determine what changed overall at a high level
            const finalChangedKeys = Object.keys({
              vendorReadyDate: true, readyAck: true, readyAckDate: true,
              notes: true, assocM: true, assocF: true, actualMoveInDate: true, rentalTermsDoc: true
            }).filter(k => jstr(existing?.final?.[k]) !== jstr(data?.final?.[k]));
            // If there were any non-final changes, we should still validate
            const nonFinalChanged = jstr({a: existing?.approvals, f: existing?.finance, r: existing?.requestDate}) !== jstr({a: data?.approvals, f: data?.finance, r: data?.requestDate});
            if (nonFinalChanged) return false;
            // Only the trio of ack-related fields changed?
            return finalChangedKeys.length > 0 && finalChangedKeys.every(k => closureKeys.includes(k));
          })();
          if (!closureChangedOnly) validateDates(data);
        } else {
          // New draft: run standard validations
          validateDates(data);
        }
        if (existing) {
          const idx = state.requests.findIndex(r => r.id === existing.id);
          state.requests[idx] = data;
        } else {
          state.requests.push(data);
          state.selectedId = data.id;
        }
        save();
  // After saving, if not acknowledged, show zeros in the UI so it matches persisted state
  resetTentativesIfNotAck();
  render();
        showToast('Saved successfully');
        updateStepper(data); updateDrawerStatus(data);
        if (closeAfter) closeDrawer();
      } catch(err) {
        showError(err.message || String(err));
      }
    }

    // Compare and enforce role PINs before saving edits to an existing record
    async function ensurePinsForChanges(existing, next){
      if (!existing) return; // new draft
      const need = new Set();
      const trim = (v) => String(v ?? '').trim();
      const num = (v) => {
        const n = Number(v ?? 0);
        return Number.isFinite(n) ? n : 0;
      };
      const sameStr = (a, b) => trim(a) === trim(b);
      const sameNum = (a, b) => num(a) === num(b);
      const sameDateTime = (a, b) => {
        if (!a && !b) return true;
        const ta = Date.parse(a);
        const tb = Date.parse(b);
        if (!Number.isNaN(ta) && !Number.isNaN(tb)) {
          if (Math.abs(ta - tb) < 60000) return true; // tolerate minute-level rounding from UI inputs
          return ta === tb;
        }
        return sameStr(a, b);
      };
      const normalizeWeekly = (arr = []) => {
        const out = [];
        for (let i = 0; i < 4; i++) {
          const row = arr[i] || {};
          out.push({ male: num(row.male), female: num(row.female) });
        }
        return out;
      };
      const jstr = (x) => JSON.stringify(x ?? null);
      const normalizeField = (v) => {
        if (v === undefined || v === null) return null;
        if (typeof v === 'string') {
          const trimmed = v.trim();
          return trimmed === '' ? null : trimmed;
        }
        if (typeof v === 'number') return Number.isFinite(v) ? v : null;
        return v;
      };
      const sameField = (a, b) => {
        const na = normalizeField(a);
        const nb = normalizeField(b);
        if (na === nb) return true;
        const numA = Number(na);
        const numB = Number(nb);
        if ((!Number.isNaN(numA) || !Number.isNaN(numB)) && numA === numB) return true;
        return false;
      };
      const isDateKey = (k) => /date$/i.test(k);
      const compareField = (k, aVal, bVal) => {
        if (isDateKey(k)) return sameDateTime(aVal, bVal);
        return sameField(aVal, bVal);
      };
      const objChanged = (a,b, keys) => keys.some(k => !compareField(k, a?.[k], b?.[k]));
      const vendorPropChanged = () => {
        const pa = existing?.approvals?.vendor?.property || {};
        const pb = next?.approvals?.vendor?.property || {};
        const keys = [
          // Note: 'client' is derived from Request client → do not gate Vendor PIN on this mirror field
          'ownerName','cluster','state','city','type','houses','rooms','capacity','securityDeposit','monthlyRent','electricity','water',
          // include per-bed monetary fields in change detection
          'associateDeductionPerBed','processingFeePerBed','waterElecPerBed'
        ];
        return objChanged(pa,pb,keys);
      };
      const sahiApproved = !!next?.approvals?.sahi?.date;
      // Request-level changes => Creator PIN
      const requestSectionTouched = !!(state.pinCache?.create || state.editPinVerified);
      const requestFieldsChanged = requestSectionTouched && (() => {
        if (!sameDateTime(existing?.requestDate, next?.requestDate)) return true;
        if (!sameStr(existing?.notes, next?.notes)) return true;
        if (!sameStr(existing?.clientName, next?.clientName)) return true;
        if (!sameStr(existing?.requestorName, next?.requestorName)) return true;
        if (JSON.stringify(normalizeWeekly(existing?.bedsWeekly)) !== JSON.stringify(normalizeWeekly(next?.bedsWeekly))) return true;
        return false;
      })();
      if (requestFieldsChanged) need.add('create');
      // Requestor per-bed charges change => Creator PIN
      const chargesChanged = requestSectionTouched && ['assocDeduction','processingFee','waterElec'].some(k => !sameNum(existing?.associateCharges?.[k], next?.associateCharges?.[k]));
      if (chargesChanged) need.add('create');
      // BV section
      if (objChanged(existing?.approvals?.bv, next?.approvals?.bv, ['male','female','date','remarks'])) need.add('bv');
      // SAHI section
      if (objChanged(existing?.approvals?.sahi, next?.approvals?.sahi, ['male','female','date','remarks'])) need.add('sahi');
      // Vendor section (agreement + ack/tentative + actual/property) – only consider after SAHI approval to avoid false positives
      if (sahiApproved) {
        // Ignore tentative counts until vendor has actually acknowledged
        const tentKeys = ['tentativeExistM','tentativeExistF','tentativeNewM','tentativeNewF','tentativeM','tentativeF'];
        const vendKeys = ['male','female','date','name','readyDate','newProp','identifyDate','tentativeMoveIn','notes','ack','ackDate','confirm','actualConfirmDate','actualExistM','actualExistF','actualNewM','actualNewF'];
        const baseChanged = objChanged(existing?.approvals?.vendor, next?.approvals?.vendor, vendKeys);
        const tentChanged = (!!next?.approvals?.vendor?.ack) && objChanged(existing?.approvals?.vendor, next?.approvals?.vendor, tentKeys);
        if (baseChanged || tentChanged || vendorPropChanged()) need.add('vendor');
      }
  // Finance Head decision requires Finance Head PIN
    if (objChanged(existing?.finance?.head, next?.finance?.head, ['decision','remarks','date'])) need.add('finhead');
    // Finance fields (non-head): allow either Finance Head PIN or Vendor PIN
    // Normalize values so ''/undefined/null are treated as same, and numeric fields compare numerically
    const finKeys = ['confirmDate','amount','terms','trn','securityDeposit','vendorIntimationDate','vendorIntimationBeds'];
    const normFin = (k, v) => {
      if (v === '' || v === undefined || v === null) return null;
      if (k === 'amount' || k === 'vendorIntimationBeds' || k === 'securityDeposit') {
        const n = Number(v); return isNaN(n) ? null : n;
      }
      return String(v);
    };
    const finChanged = finKeys.some(k => normFin(k, existing?.finance?.[k]) !== normFin(k, next?.finance?.[k]));
    if (finChanged) need.add('finOrVendor');
  if (existing?.finance?.perBedCost !== next?.finance?.perBedCost) need.add('vendor');
  // Payment proof change => allow either PIN
  const payProofChanged = jstr(existing?.finance?.paymentProof) !== jstr(next?.finance?.paymentProof);
  if (payProofChanged) need.add('finOrVendor');

  // Closure section changes: require Vendor PIN for substantive edits.
  // If only acknowledgement fields changed (ack/ackDate/vendorReadyDate auto-fill), skip redundant PIN prompt (already PIN-gated on tick).
  const closureKeys = ['vendorReadyDate','readyAck','readyAckDate','notes','assocM','assocF','actualMoveInDate','rentalTermsDoc'];
  const closureChangedKeys = closureKeys.filter(k => jstr(existing?.final?.[k]) !== jstr(next?.final?.[k]));
  if (closureChangedKeys.length) {
    const onlyAckRelated = closureChangedKeys.every(k => (k === 'readyAck' || k === 'readyAckDate' || k === 'vendorReadyDate'));
    if (!onlyAckRelated) need.add('vendor');
  }

      // Prompt per role (once each)
      for (const role of need) {
        if (role === 'create') {
          if (!state.pinCache.create) {
            const pin = (await askPin({ title:'Enter PIN', subtitle:'Edit previously saved Request fields' })) || '';
            if (pin !== CREATE_PIN) throw new Error('Incorrect PIN for Request edits.');
            state.pinCache.create = true;
          }
          continue;
        }
        if (role === 'bv') {
          if (!state.pinCache.bv) {
            const pin = (await askPin({ title:'Enter PIN', subtitle:'BV Head edits require BV PIN' })) || '';
            if (pin !== PIN_BV) throw new Error('Incorrect PIN for BV section edits.');
            state.pinCache.bv = true;
          }
          continue;
        }
        if (role === 'sahi') {
          if (!state.pinCache.sahi) {
            const pin = (await askPin({ title:'Enter PIN', subtitle:'SAHI Head edits require SAHI PIN' })) || '';
            if (pin !== PIN_SAHI) throw new Error('Incorrect PIN for SAHI section edits.');
            state.pinCache.sahi = true;
          }
          continue;
        }
        if (role === 'vendor') {
          if (!state.pinCache.vendor) {
            const pin = (await askPin({ title:'Enter PIN', subtitle:'Housing Partner edits require Vendor PIN' })) || '';
            if (pin !== PIN_VENDOR) throw new Error('Incorrect PIN for Vendor section edits.');
            state.pinCache.vendor = true;
          }
          continue;
        }
        if (role === 'finhead') {
          if (!state.pinCache.finHead) {
            const pin = (await askPin({ title:'Enter PIN', subtitle:'Finance Head edits require Finance Head PIN' })) || '';
            if (pin !== PIN_FIN_HEAD) throw new Error('Incorrect PIN for Finance Head decision edits.');
            state.pinCache.finHead = true;
          }
          continue;
        }
        if (role === 'finOrVendor') {
          if (!state.pinCache.finHead && !state.pinCache.vendor) {
            const pin = (await askPin({ title:'Enter PIN', subtitle:'Finance fields can be saved with Finance Head or Housing Partner PIN' })) || '';
            if (pin === PIN_FIN_HEAD) {
              state.pinCache.finHead = true;
            } else if (pin === PIN_VENDOR) {
              state.pinCache.vendor = true;
            } else {
              throw new Error('Incorrect PIN (need Finance Head 7281 or Housing Partner 7280).');
            }
          }
        }
      }
    }

  async function onAdvance(id) {
      const r = state.requests.find(x => x.id === id); if (!r) return;
      const st = computeStage(r);
      if (st.stage === 'Approvals') {
        // Warn user and show which counts will be approved if they proceed directly
        let label = '';
        let srcM = 0, srcF = 0;
        if (!r.approvals?.bv?.date) { label = 'BV Head'; srcM = Number(r?.beds?.male||0); srcF = Number(r?.beds?.female||0); }
        else if (!r.approvals?.sahi?.date) { label = 'SAHI Head'; srcM = Number(r?.approvals?.bv?.male||0); srcF = Number(r?.approvals?.bv?.female||0); }
        else if (!r.approvals?.vendor?.date) { label = 'Housing Partner'; srcM = Number(r?.approvals?.sahi?.male||0); srcF = Number(r?.approvals?.sahi?.female||0); }
        const total = srcM + srcF;
        if (label) {
          const ok = confirm(
            `Heads-up: Use Open to review and enter the exact approval counts.\n\n` +
            `If you continue, approval for ${label} will be recorded now using these counts:\n` +
            `  M: ${srcM}   F: ${srcF}   Total: ${total}\n\n` +
            `You'll be asked for the ${label} PIN. Continue?`
          );
          if (!ok) return;
        }
        // advance the next approval by setting date to today (PIN-gated)
  const now = nowISODateTime();
        if (!r.approvals?.bv) r.approvals.bv = { male: 0, female: 0, date: '', remarks: '' };
        if (!r.approvals?.sahi) r.approvals.sahi = { male: 0, female: 0, date: '', remarks: '' };
        if (!r.approvals?.vendor) r.approvals.vendor = { male: 0, female: 0, date: '', name: '', readyDate: '', newProp: 'no', identifyDate: '', tentativeMoveIn: '', notes: '' };
        if (!r.approvals.bv.date) {
            if (!state.pinCache.bv) {
              const pin = (await askPin({ title:'Enter PIN', subtitle:'BV Head Approval' })) || '';
              if (pin !== PIN_BV) { alert('Incorrect PIN'); return; }
              state.pinCache.bv = true;
            }
          // mirror requested beds into BV approval
          const bm = Number(r?.beds?.male||0), bf = Number(r?.beds?.female||0);
          r.approvals.bv.male = bm; r.approvals.bv.female = bf;
          r.approvals.bv.date = now;
        } else if (!r.approvals.sahi.date) {
          if (!state.pinCache.sahi) {
            const pin = (await askPin({ title:'Enter PIN', subtitle:'SAHI Head Approval' })) || '';
            if (pin !== PIN_SAHI) { alert('Incorrect PIN'); return; }
            state.pinCache.sahi = true;
          }
          // mirror BV approval into SAHI approval
          const bm = Number(r?.approvals?.bv?.male||0), bf = Number(r?.approvals?.bv?.female||0);
          r.approvals.sahi.male = bm; r.approvals.sahi.female = bf;
          r.approvals.sahi.date = now;
        } else if (!r.approvals.vendor.date) {
          if (!state.pinCache.vendor) {
            const pin = (await askPin({ title:'Enter PIN', subtitle:'Housing Partner Approval' })) || '';
            if (pin !== PIN_VENDOR) { alert('Incorrect PIN'); return; }
            state.pinCache.vendor = true;
          }
          // mirror SAHI approval into Vendor approval
          const sm = Number(r?.approvals?.sahi?.male||0), sf = Number(r?.approvals?.sahi?.female||0);
          r.approvals.vendor.male = sm; r.approvals.vendor.female = sf;
          r.approvals.vendor.date = now;
        }
      } else if (st.stage === 'Finance Pending') {
        // Finance stage is controlled via Finance Head decision + confirm date; no auto-set of payment timestamp
        if (!state.pinCache.finHead) {
          const pin = (await askPin({ title:'Enter PIN', subtitle:'Finance Head authorization' })) || '';
          if (pin !== PIN_FIN_HEAD) { alert('Incorrect PIN'); return; }
          state.pinCache.finHead = true;
        }
  r.finance.confirmDate = r.finance.confirmDate || todayISO();
      } else if (st.stage === 'Closure Pending') {
        // Require Vendor PIN to mark vendor ready
        if (!state.pinCache.vendor) {
          const pin = (await askPin({ title:'Enter PIN', subtitle:'Housing Partner confirmation' })) || '';
          if (pin !== PIN_VENDOR) { alert('Incorrect PIN'); return; }
          state.pinCache.vendor = true;
        }
        // Persist as date-only to align with UI (no time). Vendor ready date optional for closure.
        r.final.vendorReadyDate = r.final.vendorReadyDate || r.approvals.vendor.readyDate || todayISO();
        r.final.readyAck = true;
        r.final.readyAckDate = nowISODateTime();
      }
      save(); render(); showToast('Advanced: ' + id);
    }

    function onOpen(id) {
      const existing = state.requests.find(r => r.id === id);
      state.selectedId = id;
      populateDrawer(existing);
    }

    function onDelete() {
      if (!state.selectedId) return; const id = state.selectedId;
      if (!confirm('Delete ' + id + ' permanently?')) return;
      state.requests = state.requests.filter(r => r.id !== id);
      save(); render(); closeDrawer(); showToast('Deleted ' + id);
    }

    // Filters and sorting
    function hookTableSorting(){
      qsa('thead th[data-sort]').forEach(th => {
        th.addEventListener('click', () => {
          const k = th.getAttribute('data-sort');
          if (state.sort.key === k) state.sort.dir = state.sort.dir === 'asc' ? 'desc' : 'asc'; else { state.sort.key = k; state.sort.dir = 'asc'; }
          render();
        });
      });
    }

    function hookFilters(){
      qs('#searchInput').addEventListener('input', e => { state.filters.search = e.target.value; render(); });
      qs('#statusFilter').addEventListener('change', e => { state.filters.status = e.target.value; e.target.value = state.filters.status; render(); });
      // dynamic option builders
      const buildClientOptions = () => {
        const sel = qs('#clientFilter'); if (!sel) return;
        const prev = state.filters.client || 'all';
        const set = new Set();
        state.requests.forEach(r => { if (r.clientName) set.add(r.clientName); });
        const list = Array.from(set).sort();
        const keep = new Set(list);
        sel.innerHTML = '<option value="all">All clients</option>' + list.map(c => `<option>${escapeHtml(c)}</option>`).join('');
        state.filters.client = keep.has(prev) ? prev : 'all';
        sel.value = state.filters.client;
      };
      const buildYearOptions = () => {
        const sel = qs('#yearFilter'); if (!sel) return;
        const prev = state.filters.year || '';
        const set = new Set();
        state.requests.forEach(r => { if (r.requestDate) { const y = new Date(r.requestDate).getFullYear(); if (!isNaN(y)) set.add(y); } });
        const list = Array.from(set).sort((a,b)=>a-b);
        const keep = new Set(list.map(String));
        sel.innerHTML = '<option value="">All years</option>' + list.map(y => `<option value="${y}">${y}</option>`).join('');
        state.filters.year = keep.has(String(prev)) ? String(prev) : '';
        sel.value = state.filters.year;
      };
      // initial build
      buildClientOptions();
      buildYearOptions();
      // listeners
      qs('#clientFilter').addEventListener('change', e => { state.filters.client = e.target.value; render(); });
      qs('#monthFilter').addEventListener('change', e => { state.filters.month = e.target.value; render(); });
      qs('#yearFilter').addEventListener('change', e => { state.filters.year = e.target.value; render(); });
      qs('#fromDate').addEventListener('change', e => { state.filters.from = e.target.value; render(); });
      qs('#toDate').addEventListener('change', e => { state.filters.to = e.target.value; render(); });
      qs('#clearFiltersBtn').addEventListener('click', () => {
        state.filters = { status:'all', search:'', client:'all', month:'', year:'', from:'', to:'' };
        qs('#searchInput').value=''; qs('#statusFilter').value='all'; qs('#clientFilter').value='all'; qs('#monthFilter').value=''; qs('#yearFilter').value=''; qs('#fromDate').value=''; qs('#toDate').value='';
        render();
      });
      const syncChips = () => { qs('#chipOverdue').classList.toggle('active', state.filters.quick==='overdue'); qs('#chipSoon').classList.toggle('active', state.filters.quick==='soon'); };
      qs('#chipOverdue').addEventListener('click', () => { state.filters.quick = (state.filters.quick==='overdue'?undefined:'overdue'); syncChips(); render(); });
      qs('#chipSoon').addEventListener('click', () => { state.filters.quick = (state.filters.quick==='soon'?undefined:'soon'); syncChips(); render(); });
      syncChips();
    }

    function hookToolbar(){
      qs('#newRequestBtn').addEventListener('click', async () => {
        const pin = (await askPin({ title:'Enter PIN', subtitle:'Create new request' })) || '';
        if (pin !== CREATE_PIN) { alert('Incorrect PIN'); return; }
        // Seed new request with IST now for requestDate so it’s captured automatically
        try {
          state.selectedId = null;
          const draft = { requestDate: nowISODateTime(), beds:{male:0,female:0,total:0}, approvals:{ bv:{}, sahi:{}, vendor:{} }, finance:{}, final:{} };
          populateDrawer(draft);
        } catch(err){
          console.error('New Request failed:', err);
          alert('Could not start a new request: ' + (err?.message || err));
          // Ensure the drawer at least opens so user isn’t stuck
          try { const d = document.getElementById('drawer'); if (d) { d.classList.add('open'); d.setAttribute('aria-hidden','false'); } } catch(_){}
        }
      });
      qs('#closeDrawerBtn').addEventListener('click', closeDrawer);
  qs('#saveBtn').addEventListener('click', async () => { await onSave(false); });
  qs('#saveCloseBtn').addEventListener('click', async () => { await onSave(true); });
  qs('#deleteBtn').addEventListener('click', onDelete);
      qs('#duplicateBtn').addEventListener('click', async () => {
        const pin = (await askPin({ title:'Enter PIN', subtitle:'Duplicate request' })) || '';
        if (pin !== CREATE_PIN) { alert('Incorrect PIN'); return; }
        if (!state.selectedId) return; const r = structuredClone(state.requests.find(x=>x.id===state.selectedId)); r.id = genId(); r.history = []; state.requests.push(r); save(); render(); showToast('Duplicated to ' + r.id);
      });
  // Common confirm before emailing: ask user to save or continue
  function confirmSaveBeforeEmail(){
    return confirm('Heads-up: Please save to persist latest changes before emailing.\n\nClick OK to continue to email anyway, or Cancel to go back and Save.');
  }
  const emailBVInlineBtn = qs('#emailBVInlineBtn');
      if (emailBVInlineBtn) emailBVInlineBtn.addEventListener('click', () => {
        if (!confirmSaveBeforeEmail()) return;
        // Build a soft model to include unsaved changes
        let req; try { req = state.requests.find(r=>r.id===state.selectedId) || collectSoft(); } catch { req = { id: state.selectedId || 'Draft' }; }
        const to = 'suhail.aboli@sahi.ai';
        const cc = 'benefits@sahi.ai,oliv.sil@sahi.ai';
        const id = req.id || 'Draft';
        const client = req.clientName || '(Client not set)';
        const beds = `${req?.beds?.male||0}/${req?.beds?.female||0}/${req?.beds?.total||0}`;
        const st = computeStage(req);
        // Subject includes request id and stage target so recipients see required action; keeps core id stable for threading
        const subject = id && id !== 'Draft'
          ? `Request ${id}-BV Approval Needed`
          : `New Housing Request-BV Approval Needed`;
        const lines = [
          '[Housing Request Summary]',
          'Stage: BV Approval Needed',
          `Request ID: ${id}`,
          `Client: ${client}`,
          `Current Stage Flow: ${st.stage}${st.next? ' -> '+st.next:''}`,
          '----------------------------------------',
          'Beds:',
          `  Requested (M/F/T): ${beds}`,
          '----------------------------------------',
          'Action Needed:',
          '  Please review and provide BV approval (tick in system) or reply with any queries.'
        ];
        const body = encodeURIComponent(lines.join('\n'));
        const mailto = `mailto:${encodeURIComponent(to)}?cc=${encodeURIComponent(cc)}&subject=${encodeURIComponent(subject)}&body=${body}`;
  window.location.href = mailto;
      });
      const emailSAHIFromBVBtn = qs('#emailSAHIFromBVBtn');
      if (emailSAHIFromBVBtn) emailSAHIFromBVBtn.addEventListener('click', () => {
        if (!confirmSaveBeforeEmail()) return;
        let req; try { req = state.requests.find(r=>r.id===state.selectedId) || collectSoft(); } catch { req = { id: state.selectedId || 'Draft' }; }
        const to = 'ashish.jhunjunwala@sahi.ai';
        const ccList = ['benefits@sahi.ai','girish.s@sahi.ai','oliv.sil@sahi.ai'];
        const id = req.id || 'Draft';
        const client = req.clientName || '(Client not set)';
        const beds = `${req?.beds?.male||0}/${req?.beds?.female||0}/${req?.beds?.total||0}`;
        const st = computeStage(req);
  // Pull BV approved numbers (soft model uses male/female and derive total)
  const bvM = (req?.approvals?.bv?.male ?? req?.approvals?.bv?.maleApproved ?? Number(qs('#apprBVM')?.value||0)) || 0;
  const bvF = (req?.approvals?.bv?.female ?? req?.approvals?.bv?.femaleApproved ?? Number(qs('#apprBVF')?.value||0)) || 0;
  const bvTot = (req?.approvals?.bv?.total ?? req?.approvals?.bv?.totalApproved ?? Number(qs('#apprBVTotal')?.value|| (bvM + bvF))) || (bvM + bvF);
  const bvDate = req?.approvals?.bv?.date || qs('#apprBVDate')?.value || '';
  const bvNotes = req?.approvals?.bv?.notes || qs('#apprBVNotes')?.value || '';
        // Subject includes request id and stage target so recipients see required action; keeps core id stable for threading
        const subject = id && id !== 'Draft'
          ? `Request ${id}-SAHI Head Approval Needed`
          : `New Housing Request-SAHI Head Approval Needed`;
        const lines = [
          '[Housing Request Summary]',
          'Stage: SAHI Head Approval Needed',
          `Request ID: ${id}`,
          `Client: ${client}`,
          `Current Stage Flow: ${st.stage}${st.next? ' -> '+st.next:''}`,
          '----------------------------------------',
          'Beds:',
          `  Requested (M/F/T): ${beds}`,
          '----------------------------------------',
          'BV Approval Summary:',
          `  Approved (M/F/T): ${bvM}/${bvF}/${bvTot}`,
          `  Approval Time: ${bvDate || '-'}`,
          `  Remarks: ${bvNotes || '-'}`,
          '----------------------------------------',
          'Action Needed:',
          '  Please review and provide SAHI Head approval (tick in system) or reply if clarification needed.'
        ];
        const body = encodeURIComponent(lines.join('\n'));
        const mailto = `mailto:${encodeURIComponent(to)}?cc=${encodeURIComponent(ccList.join(','))}&subject=${encodeURIComponent(subject)}&body=${body}`;
        window.location.href = mailto;
      });
      // New: Email Housing Partner from SAHI section
      const emailVendorFromSAHIBtn = qs('#emailVendorFromSAHIBtn');
      if (emailVendorFromSAHIBtn) emailVendorFromSAHIBtn.addEventListener('click', () => {
        if (!confirmSaveBeforeEmail()) return;
        let req; try { req = state.requests.find(r=>r.id===state.selectedId) || collectSoft(); } catch { req = { id: state.selectedId || 'Draft' }; }
        const to = 'kumar.ashwin@sambhavfoundation.org';
        // CC all prior parties: BV Head, SAHI Head, Benefits, Girish, and requestor if available
        const reqor = (req?.requestorName || qs('#reqRequestor')?.value || '').trim();
        const ccList = [
          'suhail.aboli@sahi.ai',
          'ashish.jhunjunwala@sahi.ai',
          'benefits@sahi.ai',
          'girish.s@sahi.ai',
          'oliv.sil@sahi.ai',
        ];
        if (reqor && !/girish/i.test(reqor)) ccList.push(reqor);
        const id = req.id || 'Draft';
        const client = req.clientName || '(Client not set)';
        const beds = `${req?.beds?.male||0}/${req?.beds?.female||0}/${req?.beds?.total||0}`;
        const st = computeStage(req);
        const subject = id && id !== 'Draft'
          ? `Request ${id}-Housing Partner Engagement`
          : `New Housing Request-Housing Partner Engagement`;
        const lines = [
          '[Housing Request Summary]',
          'Stage: Housing Partner Engagement',
          `Request ID: ${id}`,
          `Client: ${client}`,
          `Current Stage Flow: ${st.stage}${st.next? ' -> '+st.next:''}`,
          '----------------------------------------',
          'Beds:',
          `  Requested (M/F/T): ${beds}`,
          '----------------------------------------',
          'SAHI Approval Summary:',
          `  Approved (M/F/T): ${(req?.approvals?.sahi?.male||0)}/${(req?.approvals?.sahi?.female||0)}/${((req?.approvals?.sahi?.male||0)+(req?.approvals?.sahi?.female||0))}`,
          `  Approval Time: ${req?.approvals?.sahi?.date || '-'}`,
          '----------------------------------------',
          'Action:',
          '  Please acknowledge and share tentative plan in the system.'
        ];
        const body = encodeURIComponent(lines.join('\n'));
        const mailto = `mailto:${encodeURIComponent(to)}?cc=${encodeURIComponent(ccList.join(','))}&subject=${encodeURIComponent(subject)}&body=${body}`;
        window.location.href = mailto;
      });
      // New: Email Finance Head from Housing Partner Actual/Property section
      const emailFinanceHeadBtn = qs('#emailFinanceHeadBtn');
      if (emailFinanceHeadBtn) emailFinanceHeadBtn.addEventListener('click', () => {
        if (!confirmSaveBeforeEmail()) return;
        let req; try { req = state.requests.find(r=>r.id===state.selectedId) || collectSoft(); } catch { req = { id: state.selectedId || 'Draft' }; }
        const to = 'mukesh.goel@labournet.in';
        // CC all previously involved: BV Head, SAHI Head, Benefits, Girish, Housing Partner contact (if captured), Requestor
        const reqor = (req?.requestorName || qs('#reqRequestor')?.value || '').trim();
        const vendorName = (req?.approvals?.vendor?.name || qs('#vendorName')?.value || '').trim();
        const ccList = [
          'suhail.aboli@sahi.ai',
          'ashish.jhunjunwala@sahi.ai',
          'benefits@sahi.ai',
          'girish.s@sahi.ai',
          'oliv.sil@sahi.ai',
          'kumar.ashwin@sambhavfoundation.org'
        ];
        if (reqor && !/girish/i.test(reqor)) ccList.push(reqor);
        // Compose email
        const id = req.id || 'Draft';
        const client = req.clientName || '(Client not set)';
        const st = computeStage(req);
        const totalNew = (Number(req?.approvals?.vendor?.actualNewM||0) + Number(req?.approvals?.vendor?.actualNewF||0));
        const financeReq = totalNew > 0 ? 'Yes (NEW onboarding present)' : 'No (existing capacity only)';
        const subject = id && id !== 'Draft'
          ? `Request ${id}-Finance Review`
          : `New Housing Request-Finance Review`;
        const lines = [
          '[Housing Request Summary]',
          'Stage: Finance Review',
          `Request ID: ${id}`,
          `Client: ${client}`,
          `Current Stage Flow: ${st.stage}${st.next? ' -> '+st.next:''}`,
          '----------------------------------------',
          'Housing Partner Actuals:',
          `  Existing (M/F): ${(req?.approvals?.vendor?.actualExistM||0)}/${(req?.approvals?.vendor?.actualExistF||0)}`,
          `  New (M/F): ${(req?.approvals?.vendor?.actualNewM||0)}/${(req?.approvals?.vendor?.actualNewF||0)}`,
          `  Confirmed On: ${req?.approvals?.vendor?.actualConfirmDate || '-'}`,
          'Property:',
          `  Owner: ${(req?.approvals?.vendor?.property?.ownerName||'-')}`,
          `  City: ${(req?.approvals?.vendor?.property?.city||'-')}`,
          `  Capacity: ${(req?.approvals?.vendor?.property?.capacity||0)}`,
          `  Monthly Rent: ${(req?.approvals?.vendor?.property?.monthlyRent||0)}`,
          '----------------------------------------',
          `Finance Required: ${financeReq}`,
          'Action:',
          '  Please review and confirm finance details in the system.'
        ];
        const body = encodeURIComponent(lines.join('\n'));
        const mailto = `mailto:${encodeURIComponent(to)}?cc=${encodeURIComponent(ccList.join(','))}&subject=${encodeURIComponent(subject)}&body=${body}`;
        window.location.href = mailto;
      });
      qs('#demoDataBtn').addEventListener('click', async () => {
  if (!confirm('Replace current data with demo dataset?')) return;
  const pwd = (await askPin({ title:'Enter Password', subtitle:'Authorize loading demo data', label:'Password' })) || '';
  if (pwd !== RESET_PASSWORD) { alert('Incorrect password. Demo load cancelled.'); return; }
        try {
          const res = await fetch('sample_data.json?ts='+Date.now(), { cache: 'no-store' });
          if (!res.ok) throw new Error('network');
          const data = await res.json();
          state.requests = Array.isArray(data) ? data : makeDemoData();
        } catch {
          state.requests = makeDemoData();
        }
  // reset filters to show all
  state.filters = { status: 'all', search: '', client: 'all', month: '', year: '', from: '', to: '' };
  qs('#searchInput').value=''; qs('#statusFilter').value='all';
  const cf = qs('#clientFilter'); if (cf) cf.value='all';
  const mf = qs('#monthFilter'); if (mf) mf.value='';
  const yf = qs('#yearFilter'); if (yf) yf.value='';
  qs('#fromDate').value=''; qs('#toDate').value='';
        save(); render(); showToast('Demo data loaded');
      });
      qs('#exportBtn').addEventListener('click', () => {
        const blob = new Blob([JSON.stringify(state.requests, null, 2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'housing_onboarding_export_'+Date.now()+'.json'; a.click(); URL.revokeObjectURL(url);
      });
      qs('#exportCsvBtn').addEventListener('click', () => exportCsv());
  const finBtn = qs('#exportFinanceExcelBtn'); if (finBtn) finBtn.addEventListener('click', exportFinanceExcel);
      // Import: pre-gate with password
      let _importAuthorizedOnce = false;
      const importBtn = qs('#importBtn');
      if (importBtn) importBtn.addEventListener('click', async () => {
        const pwd = (await askPin({ title:'Enter Password', subtitle:'Authorize import of data', label:'Password' })) || '';
        if (pwd !== RESET_PASSWORD) { alert('Incorrect password.'); return; }
        _importAuthorizedOnce = true;
        const input = qs('#importFile'); if (input) input.click();
      });
      qs('#importFile').addEventListener('change', async (e) => {
        const file = e.target.files?.[0]; if (!file) return;
        // If not pre-authorized by clicking Import, prompt here (direct file input change)
        if (!_importAuthorizedOnce) {
          const pwd = (await askPin({ title:'Enter Password', subtitle:'Authorize import of data', label:'Password' })) || '';
          if (pwd !== RESET_PASSWORD) { alert('Incorrect password. Import cancelled.'); e.target.value = ''; return; }
        }
        _importAuthorizedOnce = false;

        try {
          const ext = (file.name.split('.').pop() || '').toLowerCase();
          if (ext === 'json') {
            const text = await file.text();
            const data = JSON.parse(text);
            if (!Array.isArray(data)) throw new Error('Invalid JSON format: expected an array of requests');
            state.requests = data;
            await save();
            render();
            showToast(`Imported ${data.length} records from JSON`);
          } else if (ext === 'xlsx' || ext === 'xlsm') {
            if (!window.ExcelJS) throw new Error('ExcelJS not loaded');
            const wb = new ExcelJS.Workbook();
            const arrayBuf = await file.arrayBuffer();
            await wb.xlsx.load(arrayBuf);
            const ws = wb.worksheets[0];
            if (!ws) throw new Error('No worksheet found in Excel file');
            const imported = parseExcelToRequests(ws);
            if (!Array.isArray(imported)) throw new Error('Parsed Excel data is invalid');
            state.requests = imported;
            await save();
            render();
            showToast(`Imported ${imported.length} records from Excel`);
          } else {
            throw new Error('Unsupported file type. Please select JSON or Excel (.xlsx/.xlsm).');
          }
        } catch (err) {
          console.error('Import failed', err);
          alert('Import failed: ' + (err?.message || err));
        } finally {
          // Clear the input so the same file can be selected again if needed
          e.target.value = '';
        }
      });
      qs('#resetBtn').addEventListener('click', async () => {
        if (!confirm('This will clear all saved data. Proceed?')) return;
        const pwd = (await askPin({ title:'Enter Password', subtitle:'Confirm data reset', label:'Password' })) || '';
        if (pwd !== RESET_PASSWORD) { alert('Incorrect password. Reset cancelled.'); return; }
  await LocalStore.clear(); state.requests = []; render(); showToast('All data cleared');
      });

      // Settings modal
      const settingsModal = qs('#settingsModal');
      const openSettings = async () => {
        const pwd = (await askPin({ title:'Enter Password', subtitle:'Authorize access to Settings', label:'Password' })) || '';
        if (pwd !== RESET_PASSWORD) { alert('Incorrect password.'); return; }
        qs('#slaApprovals').value = settings.slaApprovals; qs('#slaPayment').value = settings.slaPayment; qs('#slaReady').value = settings.slaReady;
        settingsModal.classList.add('open'); settingsModal.setAttribute('aria-hidden','false');
      };
      const closeSettings = () => { settingsModal.classList.remove('open'); settingsModal.setAttribute('aria-hidden','true'); };
      qs('#settingsBtn').addEventListener('click', openSettings);
      qs('#closeSettingsBtn').addEventListener('click', closeSettings);
      qs('#saveSettingsBtn').addEventListener('click', () => { settings.slaApprovals = Number(qs('#slaApprovals').value||5); settings.slaPayment = Number(qs('#slaPayment').value||3); settings.slaReady = Number(qs('#slaReady').value||7); saveSettings(); closeSettings(); showToast('Settings saved'); render(); });

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.key === '/') { e.preventDefault(); qs('#searchInput').focus(); }
        if (e.key === 'Escape' && drawer.classList.contains('open')) { closeDrawer(); }
      });
    }

    // Table actions delegation
    function hookTableActions(){
      qs('#tableBody').addEventListener('click', (e) => {
        const link = e.target.closest('.link-id');
        if (link) { const id = link.getAttribute('data-id'); const r = state.requests.find(x=>x.id===id); if (r) openTimeline(r); return; }
        const btn = e.target.closest('button'); if (!btn) return; const id = btn.getAttribute('data-id'); const act = btn.getAttribute('data-act');
        if (act === 'view') onOpen(id);
        else if (act === 'advance') onAdvance(id);
      });
    }

    // Reactive helpers
  [
    // Approval counts
    '#apprBVM','#apprBVF','#apprSAHIM','#apprSAHIF','#apprVendorM','#apprVendorF',
    // Vendor tentative split
    '#vendorTentativeExistM','#vendorTentativeExistF','#vendorTentativeNewM','#vendorTentativeNewF',
    // Finance/Vendor numbers
    '#vendorIntimationBeds','#vendorPerBedCost','#vendorSecurityDeposit',
  // Requestor/Vendor per-bed charges
  '#reqAssocDeduction','#propAssociateDeduction',
    // Request totals (computed from weekly)
    '#bedsMale','#bedsFemale',
    // Weekly inputs
    '#w1Male','#w1Female','#w2Male','#w2Female','#w3Male','#w3Female','#w4Male','#w4Female',
    // Dates
  '#finConfirmDate','#vendorIntimationDate','#finalVendorReadyDate',
  '#apprBVDate','#apprSAHIDate','#apprVendorDate','#vendorTentativeMoveIn','#vendorReadyDate','#reqDate','#vendorIdentifyDate','#vendorNewProp',
    // Checkboxes
  '#vendorAck','#vendorConfirm','#apprBVApprove','#apprSAHIApprove','#finalReadyAck',
    // Notes and misc
    '#apprBVNotes','#apprSAHINotes','#finTRN','#finalAssocM','#finalAssocF',
    // Vendor Actual Confirmation split
    '#vendorActualExistM','#vendorActualExistF','#vendorActualNewM','#vendorActualNewF',
    // Property cost drivers
  '#propSecurityDeposit','#propMonthlyRent','#propElec','#propWater','#propCapacity',
  // Checklists
  '#chkMustWater','#chkMustVentilation','#chkMustLighting','#chkMustToilets','#chkMustCooking','#chkMustDustbins','#chkMustHousekeeping',
  '#chkMustFireExt','#chkMustFirstAid','#chkMustEmergencyContacts','#chkMustPowerBackup','#chkMustCleaningRegular','#chkMustGarbage','#chkMustPestControl',
  '#chkMustGuestRegister','#chkMustCaretaker',
  '#chkPrefWifi','#chkPrefWashing','#chkPrefTV','#chkPrefShelves','#chkPrefCharging','#chkPrefMess','#chkPrefInduction','#chkPrefFridge','#chkPrefCCTV',
  '#chkPrefOnsiteCaretaker','#chkPrefRecreation','#chkPrefHealthCheckups','#chkPrefWarden','#chkPrefBeds'
  ].forEach(sel => {
      document.addEventListener('input', async (e) => {
        if (!e.target.matches(sel)) return;
        // Back-date protection for all date fields
  if (e.target.type === 'date' || e.target.type === 'datetime-local') { if (!await enforceNoBackdate(e.target)) return; }
        // Enforce edit PINs
        const inRequestForm = !!e.target.closest('#requestForm');
        const inClosureSection = !!e.target.closest('#closureSection');
        const isChecklist = e.target.matches('[id^="chkMust"], [id^="chkPref"]');
        if (e.isTrusted) {
          if (isChecklist) {
            const ok = await ensureVendorChecklistPin();
            if (!ok) {
              // Revert checkbox state on failed PIN
              if (typeof e.target.checked === 'boolean') e.target.checked = !e.target.checked;
              e.preventDefault(); e.stopPropagation(); return;
            }
          } else if (inRequestForm && !inClosureSection && !(await ensureEditPin())) {
            e.preventDefault(); e.stopPropagation(); return;
          }
        }
        // Allow free typing; enforce 1500 minimum on save (and optionally on blur if needed)
        if (['#bedsMale','#bedsFemale','#w1Male','#w1Female','#w2Male','#w2Female','#w3Male','#w3Female','#w4Male','#w4Female'].includes(sel)) {
          updateComputedTotal(); updateApprovalBounds(); prefillApprovalBeds(); prefillVendorTentatives(); updateVendorEnablers();
          // If requested total is zero, ensure approval fields remain 0
          const total = Number(qs('#bedsTotal')?.value||0);
          if (total === 0) {
            ['#apprBVM','#apprBVF','#apprSAHIM','#apprSAHIF','#apprVendorM','#apprVendorF'].forEach(id => { const el = qs(id); if (el) el.value='0'; });
          }
        }
        if (['#apprVendorM','#apprVendorF'].includes(sel)) {
          const total = Number(qs('#bedsTotal')?.value||0);
          if (total === 0) { const el = e.target; if (el) el.value = '0'; }
          updateApprovalBounds(); prefillVendorTentatives();
        }
        if (['#apprBVM','#apprBVF','#apprSAHIM','#apprSAHIF'].includes(sel)) {
          // Enable/disable approve based on sums
          const bvSum = Number(qs('#apprBVM')?.value||0) + Number(qs('#apprBVF')?.value||0);
          const sahiSum = Number(qs('#apprSAHIM')?.value||0) + Number(qs('#apprSAHIF')?.value||0);
          const bvApprove = qs('#apprBVApprove'); if (bvApprove) bvApprove.disabled = !(bvSum > 0);
          const sahiApprove = qs('#apprSAHIApprove'); if (sahiApprove) sahiApprove.disabled = !(sahiSum > 0);
          // Recompute Vendor Tentative bounds when approvals change
          updateVendorTentativeBounds();
        }
        if (['#vendorTentativeExistM','#vendorTentativeExistF','#vendorTentativeNewM','#vendorTentativeNewF'].includes(sel)) {
          updateVendorTentativeBounds();
        }
        // Keep Property Client synced with Request client selection
        if (sel === '#clientSelect' || sel === '#clientOther') {
          const client = (qs('#clientSelect')?.value === '__other__') ? (qs('#clientOther')?.value || '') : (qs('#clientSelect')?.value || '');
          const propClient = qs('#propClient'); if (propClient) propClient.value = client;
        }
        // Actual confirmation totals and cost computations
        if (['#vendorActualExistM','#vendorActualExistF','#vendorActualNewM','#vendorActualNewF'].includes(sel)) {
          updateVendorActualTotals();
          try { applyFinanceGate(); } catch(_) {}
        }
        if (['#propSecurityDeposit','#propMonthlyRent','#propElec','#propWater','#propCapacity','#propWaterElec'].includes(sel)) {
          computeCostFields();
        }
  if (sel === '#vendorAck') {
          const el = qs('#vendorAck'); const dt = qs('#vendorAckDate');
          if (el?.checked) {
            const pin = (await askPin({ title:'Enter PIN', subtitle:'Housing Partner Acknowledge' })) || '';
            if (pin !== PIN_VENDOR) { alert('Incorrect PIN'); el.checked = false; return; }
            state.pinCache.vendor = true;
            if (dt && !dt.value) dt.value = nowLocalDatetimeValue();
          } else { if (dt) dt.value = ''; }
        }
  if (sel === '#vendorConfirm') {
          const el = qs('#vendorConfirm'); const dt = qs('#vendorActualConfirmDate');
          if (el?.checked) {
            const pin = (await askPin({ title:'Enter PIN', subtitle:'Housing Partner Confirmation' })) || '';
            if (pin !== PIN_VENDOR) { alert('Incorrect PIN'); el.checked = false; return; }
            state.pinCache.vendor = true;
            if (dt && !dt.value) dt.value = nowLocalDatetimeValue();
            // Show Finance Head controls only after confirmed
            const fh = qs('#financeHeadControls'); if (fh) fh.style.display = '';
            // Ensure capacity is at least the NEW total when onboarding NEW
            const nM = Number(qs('#vendorActualNewM')?.value||0);
            const nF = Number(qs('#vendorActualNewF')?.value||0);
            const newTotal = nM + nF;
            if (newTotal > 0) {
              const capEl = qs('#propCapacity');
              const currCap = Number(capEl?.value || 0);
              if (capEl && (!(currCap > 0) || currCap < newTotal)) { capEl.value = String(newTotal); computeCostFields(); }
            }
            // Persist immediately so the confirmation isn't lost if user navigates
            try { await onSave(false); } catch(_) {}
          } else {
            if (dt) dt.value = '';
            // Hide Finance Head controls and re-lock finance/closure when unchecking
            const fh = qs('#financeHeadControls'); if (fh) fh.style.display = 'none';
          }
          try { applyFinanceGate(); } catch(_) {}
        }
        
  if (sel === '#apprBVApprove') {
          const el = qs('#apprBVApprove'); const dt = qs('#apprBVDate');
          if (el?.checked) {
            const pin = (await askPin({ title:'Enter PIN', subtitle:'BV Head Approval' })) || '';
            if (pin !== PIN_BV) { alert('Incorrect PIN'); el.checked = false; return; }
            state.pinCache.bv = true;
            if (dt && !dt.value) dt.value = nowLocalDatetimeValue();
            // lock BV inputs after approval
            qs('#apprBVM')?.setAttribute('disabled','');
            qs('#apprBVF')?.setAttribute('disabled','');
          } else {
            if (dt) dt.value = '';
            // re-enable BV inputs if unapproved
            qs('#apprBVM')?.removeAttribute('disabled');
            qs('#apprBVF')?.removeAttribute('disabled');
            state.pinCache.bv = false;
          }
          autoFillBedsOnApprovalDate();
          // Apply BV gates whenever BV approval toggles
          try { applyBVGates(); } catch(_) {}
        }
  if (sel === '#apprSAHIApprove') {
          const el = qs('#apprSAHIApprove'); const dt = qs('#apprSAHIDate');
          if (el?.checked) {
            const pin = (await askPin({ title:'Enter PIN', subtitle:'SAHI Head Approval' })) || '';
            if (pin !== PIN_SAHI) { alert('Incorrect PIN'); el.checked = false; return; }
            state.pinCache.sahi = true;
            if (dt && !dt.value) dt.value = nowLocalDatetimeValue();
            // lock SAHI inputs after approval
            qs('#apprSAHIM')?.setAttribute('disabled','');
            qs('#apprSAHIF')?.setAttribute('disabled','');
          } else {
            if (dt) dt.value = '';
            // re-enable SAHI inputs if unapproved
            qs('#apprSAHIM')?.removeAttribute('disabled');
            qs('#apprSAHIF')?.removeAttribute('disabled');
          }
          autoFillBedsOnApprovalDate();
          try { applyBVGates(); } catch(_) {}
        }
  if (sel === '#finalReadyAck') {
          const el = qs('#finalReadyAck'); const dt = qs('#finalReadyAckDate');
          if (el?.checked) {
            const pin = (await askPin({ title:'Enter PIN', subtitle:'Housing Partner confirmation' })) || '';
            if (pin !== PIN_VENDOR) { alert('Incorrect PIN'); el.checked = false; return; }
            state.pinCache.vendor = true;
            if (dt && !dt.value) dt.value = nowLocalDatetimeValue();
            const vrd = qs('#finalVendorReadyDate'); if (vrd && !vrd.value) vrd.value = nowLocalDateValue();
            // Ensure closure unlocks immediately after acknowledgement
            try { applyFinanceGate(); } catch(_) {}
          } else {
            if (dt) dt.value = '';
          }
        }
  // Approval date is readonly and set by PIN-guarded approve tick
        if (sel === '#vendorNewProp') toggleVendorNewPropFields();
  
        if (sel === '#apprBVDate' || sel === '#apprSAHIDate' || sel === '#apprFinHeadDate' || sel === '#apprVendorDate') autoFillBedsOnApprovalDate();
  if (sel === '#vendorTentativeMoveIn' || sel === '#vendorReadyDate') autoSyncVendorReady();
  if (sel === '#finalAssocM' || sel === '#finalAssocF') { const m = Number(qs('#finalAssocM')?.value||0); const f = Number(qs('#finalAssocF')?.value||0); const t = qs('#finalAssocTotal'); if (t) t.value = String(m+f); }
        const existing = state.requests.find(r => r.id === state.selectedId) || collectSoft();
        safeUpdateSoft(existing);
        autoSaveIfExistingDebounced();
      }, true);
      // On blur, normalize Associate Deduction to 1500 minimum (still allows typing before blur)
      document.addEventListener('change', (e) => {
        if (!e.target.matches(sel)) return;
        if (sel === '#reqAssocDeduction' || sel === '#propAssociateDeduction') {
          const v = Number(e.target.value || 0);
          if (e.target.value !== '' && Number.isFinite(v) && v < 1500) {
            e.target.value = '1500';
          }
        }
      }, true);
    });

  function collectSoft(){
      // A permissive collector that doesn't throw; used to update stepper while typing
      const get = id => (qs(id)?.value || ''); const num = id => Number(get(id) || 0);
      const wM = [1,2,3,4].reduce((acc,i)=>acc+num('#w'+i+'Male'),0);
      const wF = [1,2,3,4].reduce((acc,i)=>acc+num('#w'+i+'Female'),0);
  const req = { id: state.selectedId || 'NEW', requestDate: get('#reqDate') || '', approvals:{}, finance:{}, final:{}, beds:{ male: wM, female: wF, total: wM + wF } };
      req.associateCharges = {
        assocDeduction: Number(get('#reqAssocDeduction')||0),
        processingFee: Number(get('#reqProcessingFee')||0),
        waterElec: Number(get('#reqWaterElec')||0)
      };
      req.approvals.bv = { male: num('#apprBVM'), female: num('#apprBVF'), date: get('#apprBVDate') };
      req.approvals.sahi = { male: num('#apprSAHIM'), female: num('#apprSAHIF'), date: get('#apprSAHIDate') };
      const tExM_s = num('#vendorTentativeExistM');
      const tExF_s = num('#vendorTentativeExistF');
      const tNewM_s = num('#vendorTentativeNewM');
      const tNewF_s = num('#vendorTentativeNewF');
      const tM_s = tExM_s + tNewM_s;
      const tF_s = tExF_s + tNewF_s;
      req.approvals.vendor = {
        male: num('#apprVendorM'), female: num('#apprVendorF'), date: get('#apprVendorDate'), ack: !!qs('#vendorAck')?.checked, ackDate: get('#vendorAckDate'),
        tentativeExistM: tExM_s, tentativeExistF: tExF_s, tentativeNewM: tNewM_s, tentativeNewF: tNewF_s,
        tentativeM: tM_s, tentativeF: tF_s,
        actualConfirmDate: get('#vendorActualConfirmDate')
      };
      req.finance.vendorIntimationDate = get('#vendorIntimationDate');
      req.finance.vendorIntimationBeds = num('#vendorIntimationBeds') || '';
      req.finance.perBedCost = Number(get('#vendorPerBedCost')||0) || '';
      req.finance.securityDeposit = Number(get('#vendorSecurityDeposit')||0) || '';
      req.finance.confirmDate = get('#finConfirmDate');
  // Finance payment date removed from UI; keep out of soft model
  req.finance.trn = get('#finTRN');
  req.final.vendorReadyDate = get('#finalVendorReadyDate');
  req.final.readyAck = !!qs('#finalReadyAck')?.checked;
  req.final.readyAckDate = get('#finalReadyAckDate');
  // Carry current proofs into soft model for stepper/status updates
  req.proofs = (state.tempProofs[state.selectedId || 'NEW'] || []).slice();
      req.final.actualMoveInDate = get('#vendorActualMoveInDate');
  req.final.assocM = num('#finalAssocM');
  req.final.assocF = num('#finalAssocF');
      return req;
    }

  function safeUpdateSoft(req){ updateStepper(req); updateDrawerStatus(req); renderApprovalTatBadges(req); }

    // Automation helpers
    function updateComputedTotal(){
      const idsM = ['#w1Male','#w2Male','#w3Male','#w4Male'];
      const idsF = ['#w1Female','#w2Female','#w3Female','#w4Female'];
      const male = idsM.reduce((acc,id)=>acc + Number(qs(id)?.value || 0), 0);
      const female = idsF.reduce((acc,id)=>acc + Number(qs(id)?.value || 0), 0);
      if (qs('#bedsMale')) qs('#bedsMale').value = male;
      if (qs('#bedsFemale')) qs('#bedsFemale').value = female;
      if (qs('#bedsTotal')) qs('#bedsTotal').value = male + female;
    }

    // Back-date enforcement helper
    async function enforceNoBackdate(inputEl){
      const val = (inputEl && inputEl.value) || '';
      if (!val) return true;
      // For datetime-local inputs, compare full timestamps; for date, fallback to date-only
      const isDateOnly = (inputEl.type === 'date');
      if (!isDateOnly) {
        const now = new Date(istNowMs());
        const inp = new Date(val);
        if (inp >= now) return true;
      } else {
        const today = todayISO();
        if (val >= today) return true;
      }
  const pwd = (await askPin({ title:'Enter PIN', subtitle:'Backdated entry requires authorization', label:'PIN' })) || '';
      if (pwd !== BACKDATE_PIN) {
        inputEl.value = isDateOnly ? todayISO() : nowLocalDatetimeValue();
        showError('Backdated date blocked');
        return false;
      }
      return true;
    }

    function previousApprovedMax(){
  const total = Number(qs('#bedsTotal')?.value || 0);
  const bvt = clamp((Number(qs('#apprBVM')?.value||0) + Number(qs('#apprBVF')?.value||0)), 0, total);
  const sahit = clamp((Number(qs('#apprSAHIM')?.value||0) + Number(qs('#apprSAHIF')?.value||0)), 0, Math.min(total, bvt || total));
      return { total, bvt, sahit };
    }

    function updateApprovalBounds(){
      const total = Number(qs('#bedsTotal')?.value || 0);
      const reqM = Number(qs('#bedsMale')?.value || 0);
      const reqF = Number(qs('#bedsFemale')?.value || 0);
      const clampInput = (sel, max) => { const el = qs(sel); if (!el) return; const val = Number(el.value || 0); if (val > max) el.value = String(max); if (val < 0) el.value = '0'; el.setAttribute('max', String(Math.max(0,max))); if (max===0) el.setAttribute('disabled',''); else el.removeAttribute('disabled'); };
      // If no requested beds at all, zero and disable everything (already per earlier rule)
      if (total === 0) {
        ['#apprBVM','#apprBVF','#apprSAHIM','#apprSAHIF','#apprVendorM','#apprVendorF'].forEach(sel => { const el = qs(sel); if (el){ el.value='0'; el.setAttribute('disabled',''); el.setAttribute('max','0'); } });
        if (qs('#apprBVTotal')) qs('#apprBVTotal').value = '0';
        if (qs('#apprSAHITotal')) qs('#apprSAHITotal').value = '0';
        if (qs('#apprVendorTotal')) qs('#apprVendorTotal').value = '0';
        return;
      }
      // BV: per-gender max is requested per gender
      clampInput('#apprBVM', reqM);
      clampInput('#apprBVF', reqF);
      const bvM = Number(qs('#apprBVM')?.value || 0);
      const bvF = Number(qs('#apprBVF')?.value || 0);
      if (qs('#apprBVTotal')) qs('#apprBVTotal').value = String(bvM + bvF);
      // SAHI: per-gender max is BV per gender
      clampInput('#apprSAHIM', bvM);
      clampInput('#apprSAHIF', bvF);
      const sahiM = Number(qs('#apprSAHIM')?.value || 0);
      const sahiF = Number(qs('#apprSAHIF')?.value || 0);
      if (qs('#apprSAHITotal')) qs('#apprSAHITotal').value = String(sahiM + sahiF);
      // Vendor: per-gender max is SAHI per gender
      clampInput('#apprVendorM', sahiM);
      clampInput('#apprVendorF', sahiF);
      const vendM = Number(qs('#apprVendorM')?.value || 0);
      const vendF = Number(qs('#apprVendorF')?.value || 0);
      if (qs('#apprVendorTotal')) qs('#apprVendorTotal').value = String(vendM + vendF);
      // After approvals are clamped, ensure Vendor Tentative stays within prior approvals
      updateVendorTentativeBounds();
    }

    // Determine caps for Vendor Tentative strictly based on SAHI approvals.
    function vendorTentativeCaps(){
      const sahiM = Number(qs('#apprSAHIM')?.value || 0);
      const sahiF = Number(qs('#apprSAHIF')?.value || 0);
      // Only count SAHI after approval date is set; otherwise cap is 0
      const hasSAHI = !!qs('#apprSAHIDate')?.value;
      const maxM = hasSAHI ? sahiM : 0;
      const maxF = hasSAHI ? sahiF : 0;
      return { maxM, maxF, maxT: Math.max(0, maxM + maxF) };
    }

    function computeVendorTentativeTotals(){
      const exM = Number(qs('#vendorTentativeExistM')?.value||0);
      const exF = Number(qs('#vendorTentativeExistF')?.value||0);
      const nwM = Number(qs('#vendorTentativeNewM')?.value||0);
      const nwF = Number(qs('#vendorTentativeNewF')?.value||0);
      const totExist = exM + exF;
      const totNew = nwM + nwF;
      if (qs('#vendorTentativeExistTotal')) qs('#vendorTentativeExistTotal').value = String(totExist);
      if (qs('#vendorTentativeTotal')) qs('#vendorTentativeTotal').value = String(totNew);
    }

    function updateVendorTentativeBounds(){
      const { maxM, maxF } = vendorTentativeCaps();
      const setMax = (sel, max) => { const el = qs(sel); if (!el) return; el.setAttribute('max', String(Math.max(0,max))); if (max===0) el.setAttribute('disabled',''); else el.removeAttribute('disabled'); };
      setMax('#vendorTentativeExistM', maxM);
      setMax('#vendorTentativeNewM', maxM);
      setMax('#vendorTentativeExistF', maxF);
      setMax('#vendorTentativeNewF', maxF);
      // Clamp so Existing+New per gender never exceeds caps
      const exMEl = qs('#vendorTentativeExistM'); const newMEl = qs('#vendorTentativeNewM');
      const exFEl = qs('#vendorTentativeExistF'); const newFEl = qs('#vendorTentativeNewF');
  // Clamp individual fields to their per-gender caps first
  if (exMEl) { const v = Number(exMEl.value||0); if (v > maxM) exMEl.value = String(maxM); if (v < 0) exMEl.value = '0'; }
  if (newMEl) { const v = Number(newMEl.value||0); if (v > maxM) newMEl.value = String(maxM); if (v < 0) newMEl.value = '0'; }
  if (exFEl) { const v = Number(exFEl.value||0); if (v > maxF) exFEl.value = String(maxF); if (v < 0) exFEl.value = '0'; }
  if (newFEl) { const v = Number(newFEl.value||0); if (v > maxF) newFEl.value = String(maxF); if (v < 0) newFEl.value = '0'; }
      const clampPair = (aEl, bEl, cap) => {
        if (!aEl || !bEl) return; const a = Number(aEl.value||0); const b = Number(bEl.value||0); const sum = a + b; if (sum > cap) {
          // Prefer to reduce the field that changed last: as a heuristic, reduce b first
          const allowedB = Math.max(0, cap - a);
          bEl.value = String(allowedB);
        }
        if (Number(aEl.value)<0) aEl.value='0'; if (Number(bEl.value)<0) bEl.value='0';
      };
      clampPair(exMEl, newMEl, maxM);
      clampPair(exFEl, newFEl, maxF);
      // If Existing already fulfills the requirement per gender, lock New to 0 and disable
      const exMVal = Number(exMEl?.value||0);
      const exFVal = Number(exFEl?.value||0);
      if (newMEl) {
        if (exMVal >= maxM) { newMEl.value = '0'; newMEl.setAttribute('disabled',''); }
        else { newMEl.removeAttribute('disabled'); }
      }
      if (newFEl) {
        if (exFVal >= maxF) { newFEl.value = '0'; newFEl.setAttribute('disabled',''); }
        else { newFEl.removeAttribute('disabled'); }
      }
      // If Existing across genders already matches SAHI caps (e.g., exM==maxM and exF==maxF), lock all other fields
      const existingMeetsCaps = (exMVal >= maxM) && (exFVal >= maxF);
      if (existingMeetsCaps) {
        if (newMEl) { newMEl.value = '0'; newMEl.setAttribute('disabled',''); }
        if (newFEl) { newFEl.value = '0'; newFEl.setAttribute('disabled',''); }
        if (exFEl) { exFEl.value = String(Math.min(exFVal, maxF)); exFEl.setAttribute('disabled',''); }
        // Keep exM editable but within max
        if (exMEl) { exMEl.setAttribute('max', String(Math.max(0, maxM))); }
      } else {
        // Re-enable Existing F if cap allows
        if (exFEl && maxF > 0) exFEl.removeAttribute('disabled');
      }
      computeVendorTentativeTotals();
      // Update ack enablement now that totals may have changed
      updateVendorEnablers();
    }

    function prefillVendorTentatives(){
  const { maxM, maxF } = vendorTentativeCaps();
      const exMEl = qs('#vendorTentativeExistM'); const newMEl = qs('#vendorTentativeNewM');
      const exFEl = qs('#vendorTentativeExistF'); const newFEl = qs('#vendorTentativeNewF');
      if (!exMEl||!newMEl||!exFEl||!newFEl) return;
      const curM = Number(exMEl.value||0) + Number(newMEl.value||0);
      const curF = Number(exFEl.value||0) + Number(newFEl.value||0);
      // Only prefill if both genders currently sum to 0 (user hasn't typed yet)
  if (curM === 0) { exMEl.value = String(maxM); newMEl.value = '0'; }
  if (curF === 0) { exFEl.value = String(maxF); newFEl.value = '0'; }
  // If SAHI not approved (caps 0), keep New disabled
  if (maxM === 0 && newMEl) newMEl.setAttribute('disabled','');
  if (maxF === 0 && newFEl) newFEl.setAttribute('disabled','');
      updateVendorTentativeBounds();
    }

    function prefillApprovalBeds(){
  const total = Number(qs('#bedsTotal')?.value || 0);
  const setIfZero = (sel, val) => { const el = qs(sel); if (!el) return; if (Number(el.value || 0) === 0) el.value = String(val); };
      // Fill totals inputs, not nonexistent ids
      setIfZero('#apprBVTotal', total);
      setIfZero('#apprSAHITotal', Math.min(total, Number(qs('#apprBVTotal')?.value || total)));
      setIfZero('#apprVendorTotal', Math.min(total, Number(qs('#apprSAHITotal')?.value || Number(qs('#apprBVTotal')?.value || total))));
    }

    function updateVendorEnablers(){
      const total = Number(qs('#bedsTotal')?.value||0);
      const disable = (sel, keepValue) => { const el = qs(sel); if (!el) return; if (total===0) { el.setAttribute('disabled',''); if (keepValue===0) el.value = (el.type==='checkbox') ? '' : '0'; } else { el.removeAttribute('disabled'); } };
      // Vendor fields to control (leave vendorAck enabled even when zero to allow flow via PIN only if split totals >0; otherwise disable)
      const lockWhenZero = [
        '#vendorTentativeExistM','#vendorTentativeExistF','#vendorTentativeNewM','#vendorTentativeNewF',
        '#vendorIntimationDate','#vendorIntimationBeds','#vendorPerBedCost','#vendorSecurityDeposit',
    '#apprVendorM','#apprVendorF','#apprVendorDate','#vendorReadyDate','#vendorActualMoveInDate',
        '#vendorTentativeMoveIn','#vendorIdentifyDate','#vendorNewProp',
    '#vendorNotes','#finalVendorReadyDate','#vendorName',
    // New Actual Confirmation & Property fields
    '#vendorConfirm','#vendorActualConfirmDate',
    '#vendorActualExistM','#vendorActualExistF','#vendorActualNewM','#vendorActualNewF',
    '#propOwnerName','#propCluster','#propState','#propCity','#propClient','#propType',
    '#propHouses','#propRooms','#propCapacity',
    '#propSecurityDeposit','#propMonthlyRent','#propElec','#propWater',
    '#propTotalMonthlyRent','#propSecurityInterestMonthly','#propLandingCostMonthly',
    '#propCostPerBedNoInt','#propCostPerBedWithInt','#propAssociateDeduction','#propProcessingFee','#propWaterElec'
      ];
      lockWhenZero.forEach(sel => disable(sel, 0));
      const unlockBtn = qs('#unlockPerBedBtn'); if (unlockBtn) { if (total===0) unlockBtn.setAttribute('disabled',''); else unlockBtn.removeAttribute('disabled'); }
      // Ack checkbox special rule: enabled only if there is some tentative total > 0 and request total > 0
      const ack = qs('#vendorAck');
      if (ack) {
        if (total===0) { ack.checked = false; ack.setAttribute('disabled',''); const dt=qs('#vendorAckDate'); if (dt) dt.value=''; }
        else { ack.removeAttribute('disabled'); }
      }
      // Totals update
      const exTot = qs('#vendorTentativeExistTotal'); if (exTot) exTot.value = (Number(qs('#vendorTentativeExistM')?.value||0) + Number(qs('#vendorTentativeExistF')?.value||0));
  const tTot = qs('#vendorTentativeTotal'); if (tTot) tTot.value = (Number(qs('#vendorTentativeNewM')?.value||0) + Number(qs('#vendorTentativeNewF')?.value||0));
    }

    function updateVendorActualTotals(){
      const eM = Number(qs('#vendorActualExistM')?.value||0);
      const eF = Number(qs('#vendorActualExistF')?.value||0);
      const nM = Number(qs('#vendorActualNewM')?.value||0);
      const nF = Number(qs('#vendorActualNewF')?.value||0);
  // Per-group auto totals
  const existTotal = eM + eF;
  const newTotal = nM + nF;
  const exTotEl = qs('#vendorActualExistTotal'); if (exTotEl) { exTotEl.value = String(existTotal); exTotEl.setAttribute('value', String(existTotal)); }
      try { applyFinanceGate(); } catch(_) {}
  const newTotEl = qs('#vendorActualNewTotal'); if (newTotEl) { newTotEl.value = String(newTotal); newTotEl.setAttribute('value', String(newTotal)); }
      const totalM = eM + nM;
      const totalF = eF + nF;
      const gt = qs('#vendorActualTotal'); if (gt) { const v = `${totalM} / ${totalF}`; gt.value = v; gt.setAttribute('value', v); }
      // mirror into hidden approval counts to maintain downstream logic
      const vm = qs('#apprVendorM'); if (vm) vm.value = String(totalM);
      const vf = qs('#apprVendorF'); if (vf) vf.value = String(totalF);
      const vt = qs('#apprVendorTotal'); if (vt) vt.value = String(totalM + totalF);
      // Auto-populate Accommodation Capacity (Beds) to be at least Actual via New (M+F)
      const capEl = qs('#propCapacity');
      const newTotalCap = nM + nF;
      if (capEl && newTotalCap > 0) {
        const currCap = Number(capEl.value || 0);
        if (!(currCap > 0) || currCap < newTotalCap) { capEl.value = String(newTotalCap); computeCostFields(); }
      }
    }

    // Also recalc Actual totals on change, for browsers that don't emit input continuously for number fields
    ['#vendorActualExistM','#vendorActualExistF','#vendorActualNewM','#vendorActualNewF'].forEach(sel => {
      document.addEventListener('change', (e) => { if (e.target && e.target.matches(sel)) updateVendorActualTotals(); });
    });

    function computeCostFields(){
      const rent = Number(qs('#propMonthlyRent')?.value||0);
      const elec = Number(qs('#propElec')?.value||0);
      const water = Number(qs('#propWater')?.value||0);
      const dep = Number(qs('#propSecurityDeposit')?.value||0);
      const capRaw = Number(qs('#propCapacity')?.value||0);
      const cap = Number.isFinite(capRaw) ? capRaw : 0;
      const wePerBed = Number(qs('#propWaterElec')?.value||0);
      // If capacity is not set (>0), avoid dividing by 0 and show zeros
      const setNum = (id, v) => { const el = qs(id); if (el) el.value = Number.isFinite(v) ? v.toFixed(2) : '0.00'; };
      const setText = (id, v) => { const el = qs(id); if (el) el.textContent = Number.isFinite(v) ? v.toFixed(2) : '0.00'; };
      if (!(cap > 0)) {
        const interest0 = dep * 0.015; // still show monthly interest component
        setNum('#propTotalMonthlyRent', rent + elec + water);
        setNum('#propSecurityInterestMonthly', interest0);
        setNum('#propLandingCostMonthly', (rent + elec + water) + interest0);
        setNum('#propCostPerBedNoInt', 0);
        setNum('#propCostPerBedWithInt', 0);
        setText('#propCostPerBedNoInt80', 0);
        setText('#propCostPerBedWithInt80', 0);
        return;
      }
  // COSTS vs REVENUE clarification:
  // - Costs: Monthly Rent, Monthly Electricity, Monthly Water (use these for cost calculations)
  // - Revenue: Associate Deduction / Bed / Month, Processing Fee / Bed, Water + Electricity / Bed / Month
  //   The per-bed Water+Electricity is a revenue item and must NOT be used in cost computations.
  // Display Total Monthly Rent (auto) as simple sum of monthly rent + monthly electricity + monthly water
  const totalMonthlyAuto = rent + elec + water;
  // For all cost computations, always use the monthly electricity + water as COSTS (ignore per-bed revenue field)
  const utilMonthlyForCosts = (elec + water);
  const totalMonthlyForCosts = rent + utilMonthlyForCosts;
  const interest = dep * 0.015; // 1.5% per month
  const landing = totalMonthlyForCosts + interest;
  const perBedNoInt = totalMonthlyForCosts / cap;
  const perBedWithInt = landing / cap;
  setNum('#propTotalMonthlyRent', totalMonthlyAuto);
      setNum('#propSecurityInterestMonthly', interest);
  setNum('#propLandingCostMonthly', landing);
      setNum('#propCostPerBedNoInt', perBedNoInt);
      setNum('#propCostPerBedWithInt', perBedWithInt);
      // At 80% occupancy: per-bed effective cost increases by 1/0.8x
      const factor = 0.8;
  const perBedNoInt80 = totalMonthlyForCosts / (cap * factor);
  const perBedWithInt80 = landing / (cap * factor);
      setText('#propCostPerBedNoInt80', perBedNoInt80);
      setText('#propCostPerBedWithInt80', perBedWithInt80);
    }

    function autoFillBedsOnApprovalDate(){
      const order = ['#apprBVTotal','#apprSAHITotal','#apprVendorTotal'];
      const dateIds = ['#apprBVDate','#apprSAHIDate','#apprVendorDate'];
      for (let i=0;i<order.length;i++){
        const bedsEl = qs(order[i]); const dateEl = qs(dateIds[i]); if (!bedsEl || !dateEl) continue;
        if (dateEl.value && Number(bedsEl.value||0) === 0){
          const prevVal = i>0 ? Number(qs(order[i-1])?.value || 0) : Number(qs('#bedsTotal')?.value || 0);
          bedsEl.value = String(prevVal);
        }
      }
      updateApprovalBounds();
    }

    function toggleVendorNewPropFields(){
      const vEl = qs('#vendorNewProp');
      const idEl = qs('#vendorIdentifyDate');
      const mvEl = qs('#vendorTentativeMoveIn');
      if (!vEl || !idEl || !mvEl) return; // fields not present in current layout
      const v = vEl.value;
      if (v === 'yes') { idEl.removeAttribute('disabled'); mvEl.removeAttribute('disabled'); }
      else { idEl.value = ''; mvEl.value=''; idEl.setAttribute('disabled',''); mvEl.setAttribute('disabled',''); }
    }

    function autoSetNotifyDate(){
      // Notify Parties field removed; keep function as no-op for backward compatibility
    }

    function autoSyncVendorReady(){
      const tentEl = qs('#vendorTentativeMoveIn');
      const ready = qs('#vendorReadyDate');
      if (!ready) return;
      const tent = tentEl ? tentEl.value : '';
      if (tent && !ready.value) ready.value = tent;
    }

    // Autosave for existing records
    let autosaveTimer = null;
    function autoSaveIfExistingDebounced(){
      if (!state.selectedId) return; // new draft not autosaved
      clearTimeout(autosaveTimer); autosaveTimer = setTimeout(() => {
  // Do not persist edits automatically for existing records to honor PIN gating.
  // Instead, update stepper/status softly from current form inputs.
  try { const soft = collectSoft(); safeUpdateSoft(soft); } catch { /* ignore */ }
      }, 600);
    }

    // Init
    function init(){
  // sync IST clock from the web (falls back to system time if offline)
  syncISTTime();
  // refresh IST offset hourly to minimize drift in long-running sessions
  try { setInterval(syncISTTime, 60 * 60 * 1000); } catch(_){}
      // Defer rendering until Firebase connects; settings are loaded later by fb loader if needed
      // ensure dropdown reflects current state
      qs('#statusFilter').value = state.filters.status;
      hookTableSorting();
      hookFilters();
      hookToolbar();
      hookTableActions();
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
        });
      }
      // Initialize Firebase and bind sync button
      fb.initAndAutoLoad();
      const bSync = qs('#fbSyncBtn'); if (bSync) bSync.addEventListener('click', () => fb.save());
    }
    // Error banner helper
    function showError(msg){
      let banner = document.getElementById('drawerError');
      if (!banner) {
        banner = document.createElement('div');
        banner.id = 'drawerError'; banner.className = 'error-banner';
        const main = document.querySelector('.drawer main');
        if (main) main.prepend(banner); else document.body.appendChild(banner);
      }
      const text = String(msg ?? '');
      banner.textContent = text; banner.classList.add('show');
      if (text.trim()) {
        try { alert(text); } catch (_){ /* ignore alert errors */ }
      }
      setTimeout(()=> banner.classList.remove('show'), 4500);
    }

    // CSV export of current filtered + sorted rows
    function exportCsv(){
      const filtered = applyFilters([...state.requests]);
      const sorted = applySort(filtered);
  const headers = [
  'ID','Requestor','Client','Request Date','Beds Male','Beds Female','Beds Total','BV M','BV F','BV Total','BV Date','SAHI M','SAHI F','SAHI Total','SAHI Date','Vendor M','Vendor F','Vendor Total','Vendor Date','Vendor Ack','Vendor Ack Date','Vendor Actual Confirm','Vendor Actual Confirm Date','Vendor Name','Vendor Ready','New Prop','Identify Date','Tentative MoveIn','Tentative M','Tentative F','Actual Exist M','Actual Exist F','Actual New M','Actual New F','Property Owner','Cluster','State','City','Property Type','Houses','Rooms','Capacity','Vendor Intimation Date','Vendor Intimation Beds','Per Bed Cost','Security Deposit','Finance Amount','Finance Terms','Finance Confirmation Date','Payment TRN','Final Ready','Final Assoc M','Final Assoc F','Final Assoc Total','Stage','Status','TAT to Next','Age Days','Progress %','Proofs Count','Payment Proof','Rental Terms Doc'
    ];
  const rows = sorted.map(r => {
        const st = computeStage(r); const chip = computeStatusChip(r);
        const bvT = (r.approvals?.bv ? (r.approvals.bv.male||0)+(r.approvals.bv.female||0) : '');
        const sahiT = (r.approvals?.sahi ? (r.approvals.sahi.male||0)+(r.approvals.sahi.female||0) : '');
        const finhT = '';
        const vendT = (r.approvals?.vendor ? (r.approvals.vendor.male||0)+(r.approvals.vendor.female||0) : '');
        const proofsCount = Array.isArray(r.proofs) ? r.proofs.length : 0;
        const finalAssocM = Number(r.final?.assocM||0);
        const finalAssocF = Number(r.final?.assocF||0);
        const finalAssocT = finalAssocM + finalAssocF;
        const payProof = r.finance?.paymentProof ? 'Yes' : 'No';
        const rentDoc = r.final?.rentalTermsDoc ? 'Yes' : 'No';
        return [
          r.id, r.requestorName, r.clientName||'', r.requestDate,
          r.beds.male, r.beds.female, r.beds.total,
          r.approvals?.bv?.male||'', r.approvals?.bv?.female||'', bvT, r.approvals?.bv?.date||'',
          r.approvals?.sahi?.male||'', r.approvals?.sahi?.female||'', sahiT, r.approvals?.sahi?.date||'',
          r.approvals?.vendor?.male||'', r.approvals?.vendor?.female||'', vendT, r.approvals?.vendor?.date||'',
          r.approvals?.vendor?.ack ? 'Yes' : 'No', r.approvals?.vendor?.ackDate||'',
          r.approvals?.vendor?.confirm ? 'Yes' : 'No', r.approvals?.vendor?.actualConfirmDate||'',
          r.approvals?.vendor?.name||'', r.approvals?.vendor?.readyDate||'', r.approvals?.vendor?.newProp||'', r.approvals?.vendor?.identifyDate||'', r.approvals?.vendor?.tentativeMoveIn||'',
          r.approvals?.vendor?.tentativeM||'', r.approvals?.vendor?.tentativeF||'',
          r.approvals?.vendor?.actualExistM||'', r.approvals?.vendor?.actualExistF||'', r.approvals?.vendor?.actualNewM||'', r.approvals?.vendor?.actualNewF||'',
          r.approvals?.vendor?.property?.ownerName||'', r.approvals?.vendor?.property?.cluster||'', r.approvals?.vendor?.property?.state||'', r.approvals?.vendor?.property?.city||'', r.approvals?.vendor?.property?.type||'', r.approvals?.vendor?.property?.houses||'', r.approvals?.vendor?.property?.rooms||'', r.approvals?.vendor?.property?.capacity||'',
          r.finance?.vendorIntimationDate||'', r.finance?.vendorIntimationBeds||'', r.finance?.perBedCost||'', r.finance?.securityDeposit||'',
          r.finance?.amount||'', r.finance?.terms||'', r.finance?.confirmDate||'', r.finance?.trn||'', r.final?.vendorReadyDate||'',
          finalAssocM, finalAssocF, finalAssocT,
          st.stage, chip.text, tatToNext(r), daysBetween(r.requestDate, todayISO())||'', computeProgress(r), proofsCount, payProof, rentDoc
        ];
      });
      const csv = [headers, ...rows].map(row => row.map(csvEscape).join(',')).join('\r\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'housing_onboarding_export_'+Date.now()+'.csv'; a.click(); URL.revokeObjectURL(url);
    }
    function csvEscape(v){
      if (v === null || v === undefined) return '';
      const s = String(v);
      if (/[",\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
      return s;
    }

    // Excel import: parse the first worksheet into our internal requests[] shape
    // Accepts headers similar to our CSV export. Skips empty rows.
    function parseExcelToRequests(ws){
      // Helper: normalize header names
      const norm = (s) => String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'');
      const isDateKey = (k) => /date|movein|ready|ackdate|confirmdate|identify/.test(k);
      const toNumber = (v) => {
        if (v === null || v === undefined || v === '') return 0;
        if (typeof v === 'number') return Number.isFinite(v) ? v : 0;
        if (typeof v === 'boolean') return v ? 1 : 0;
        const s = String(v).replace(/[, ]/g,'');
        const n = Number(s);
        return Number.isNaN(n) ? 0 : n;
      };
      const excelSerialToDate = (n) => {
        // Excel serial to JS Date: days since 1899-12-30
        const ms = Math.round((Number(n) - 25569) * 86400 * 1000);
        return new Date(ms);
      };
      const toISO = (v) => {
        if (v === null || v === undefined || v === '') return '';
        if (v instanceof Date) return v.toISOString();
        if (typeof v === 'number') {
          // Heuristic: treat large numbers as Excel serial dates
          if (v > 25000 && v < 60000) { try { return excelSerialToDate(v).toISOString(); } catch(_) { /* ignore */ } }
          return '';
        }
        // Strings: try Date parsing
        const d = new Date(v);
        return isNaN(d.getTime()) ? String(v) : d.toISOString();
      };
      const toBool = (v) => {
        if (typeof v === 'boolean') return v;
        if (typeof v === 'number') return v !== 0;
        const s = String(v||'').trim().toLowerCase();
        return s === 'yes' || s === 'true' || s === 'y' || s === '1';
      };
      const setPath = (obj, path, value) => {
        if (value === undefined) return;
        const parts = path.split('.');
        let cur = obj;
        for (let i=0;i<parts.length-1;i++){
          const p = parts[i]; if (!cur[p] || typeof cur[p] !== 'object') cur[p] = {};
          cur = cur[p];
        }
        cur[parts[parts.length-1]] = value;
      };

      // Build header map (colIdx -> path)
      const headerRow = ws.getRow(1);
      const maxC = Math.max(ws.actualColumnCount || 0, ws.columnCount || 0, headerRow.cellCount || 0, (headerRow.values?.length||1)-1);
      const map = {};
      const dict = {
        // top-level
        id: 'id',
        requestor: 'requestorName', requestorname: 'requestorName', requester: 'requestorName',
        client: 'clientName', clientname: 'clientName',
        requestdate: 'requestDate', reqdate: 'requestDate',
        // requested beds
        bedsmale: 'beds.male', malebeds: 'beds.male', male: 'beds.male',
        bedsfemale: 'beds.female', femalebeds: 'beds.female', female: 'beds.female',
        bedstotal: 'beds.total', totalbeds: 'beds.total',
        // BV
        bvm: 'approvals.bv.male', bvf: 'approvals.bv.female', bvtotal: 'approvals.bv.total', bvdate: 'approvals.bv.date',
        // SAHI
        sahim: 'approvals.sahi.male', sahif: 'approvals.sahi.female', sahitotal: 'approvals.sahi.total', sahidate: 'approvals.sahi.date',
        // Vendor totals and flags
        vendorm: 'approvals.vendor.male', vendorf: 'approvals.vendor.female', vendortotal: 'approvals.vendor.total', vendordate: 'approvals.vendor.date',
        vendorack: 'approvals.vendor.ack', vendorackdate: 'approvals.vendor.ackDate',
        vendoractualconfirm: 'approvals.vendor.confirm', vendoractualconfirmdate: 'approvals.vendor.actualConfirmDate',
        vendorname: 'approvals.vendor.name', vendorready: 'approvals.vendor.readyDate',
        newprop: 'approvals.vendor.newProp', newproperty: 'approvals.vendor.newProp',
        identifydate: 'approvals.vendor.identifyDate',
        tentativemovein: 'approvals.vendor.tentativeMoveIn',
        tentativemale: 'approvals.vendor.tentativeM', tentativem: 'approvals.vendor.tentativeM',
        tentativefemale: 'approvals.vendor.tentativeF', tentativef: 'approvals.vendor.tentativeF',
        actualexistm: 'approvals.vendor.actualExistM', actualexistf: 'approvals.vendor.actualExistF',
        actualnewm: 'approvals.vendor.actualNewM', actualnewf: 'approvals.vendor.actualNewF',
        // Property
        propertyowner: 'approvals.vendor.property.ownerName', owner: 'approvals.vendor.property.ownerName', ownername: 'approvals.vendor.property.ownerName',
        cluster: 'approvals.vendor.property.cluster', state: 'approvals.vendor.property.state', city: 'approvals.vendor.property.city', district: 'approvals.vendor.property.city',
        propertytype: 'approvals.vendor.property.type', type: 'approvals.vendor.property.type', accommodationtype: 'approvals.vendor.property.type',
        houses: 'approvals.vendor.property.houses', rooms: 'approvals.vendor.property.rooms', capacity: 'approvals.vendor.property.capacity', accommodationcapacity: 'approvals.vendor.property.capacity',
        securitydeposit: 'finance.securityDeposit',
        monthlyrent: 'approvals.vendor.property.monthlyRent', electricity: 'approvals.vendor.property.electricity', water: 'approvals.vendor.property.water',
        // Finance
        vendorintimationdate: 'finance.vendorIntimationDate', vendorintimationbeds: 'finance.vendorIntimationBeds',
        perbedcost: 'finance.perBedCost', financeamount: 'finance.amount', amount: 'finance.amount', financeterms: 'finance.terms', financeconfirmationdate: 'finance.confirmDate', paymenttrn: 'finance.trn', trn: 'finance.trn',
        // Final
        finalready: 'final.vendorReadyDate', vendorreadydate: 'final.vendorReadyDate',
        finalassocm: 'final.assocM', finalassocf: 'final.assocF', finalnotes: 'final.notes'
      };
      for (let c=1;c<=maxC;c++){
        const cell = headerRow.getCell(c);
        const name = cell && (cell.text ?? cell.value);
        const n = norm(name);
        if (!n) continue;
        if (dict[n]) { map[c] = dict[n]; continue; }
        // Some composite headers from our CSV export
        if (n === 'id') { map[c] = 'id'; continue; }
        if (n === 'requestor' || n === 'requestorname') { map[c] = 'requestorName'; continue; }
        if (n === 'client' || n === 'clientname') { map[c] = 'clientName'; continue; }
        if (n === 'requestdate') { map[c] = 'requestDate'; continue; }
        // Fallback: ignore unknown headers
      }

      const maxR = ws.actualRowCount || ws.rowCount || 0;
      const out = [];
      // Find current max numeric ID to assign new ones
      const parseIdNum = (id) => { const m = String(id||'').match(/REQ-(\d+)/i); return m ? Number(m[1]) : null; };
      let currentMax = Math.max(1000, ...state.requests.map(r => parseIdNum(r.id) || 1000));

      for (let r = 2; r <= maxR; r++){
        const row = ws.getRow(r);
        // Detect empty row
        let any = false;
        for (let c=1;c<=maxC;c++){ const v = row.getCell(c).value; if (v !== null && v !== undefined && String(v).trim?.() !== '') { any = true; break; } }
        if (!any) continue;

        const req = {
          id: '',
          requestorName: 'Girish',
          clientName: '',
          requestDate: '',
          notes: '',
          beds: { male:0, female:0, total:0 },
          approvals: { bv:{}, sahi:{}, vendor:{ property:{}, checklist:{} } },
          finance: {},
          final: {},
          proofs: [],
          history: []
        };

        for (let c=1;c<=maxC;c++){
          const path = map[c]; if (!path) continue;
          const cell = row.getCell(c);
          let v = cell && (cell.value instanceof Date ? cell.value : (cell.text ?? cell.value));
          const key = norm(ws.getRow(1).getCell(c)?.text ?? ws.getRow(1).getCell(c)?.value);
          if (isDateKey(key)) {
            setPath(req, path, toISO(v));
          } else if (/ack$|confirm$/.test(path.split('.').pop()||'')) {
            setPath(req, path, toBool(v));
          } else if (/male$|female$|total$|beds$|houses$|rooms$|capacity$|amount$|deposit$|rent$|electricity$|water$|perbedcost|vendorintimationbeds/.test(path)) {
            setPath(req, path, toNumber(v));
          } else if (path === 'id') {
            setPath(req, path, String(v||'').trim());
          } else {
            setPath(req, path, String(v ?? ''));
          }
        }
        // Compute derived totals if missing
        if (!req.beds.total) req.beds.total = Number(req.beds.male||0) + Number(req.beds.female||0);
        // If Actual split present, prefer it for vendor totals
        const v = req.approvals.vendor || {};
        const actM = Number(v.actualExistM||0) + Number(v.actualNewM||0);
        const actF = Number(v.actualExistF||0) + Number(v.actualNewF||0);
        if (actM + actF > 0) {
          req.approvals.vendor.male = actM;
          req.approvals.vendor.female = actF;
        }
        // Assign ID if missing
        if (!req.id) { currentMax += 1; req.id = 'REQ-' + currentMax; }
        out.push(req);
      }
      return out;
    }

    // Finance-ready Excel export for the "Actual Confirmation & Property" section (current request in drawer)
    async function exportFinanceExcel(){
      try {
        if (!window.ExcelJS) { alert('Excel export not available (library not loaded).'); return; }
        // Determine the working request: take current drawer values (unsaved) merged onto existing
        const existing = state.requests.find(r => r.id === state.selectedId) || null;
        const req = collectFormData(existing || undefined); // may throw on invalid ordering; that's fine to block export
        if (!req?.approvals?.vendor?.confirm) {
          alert('Export blocked: Vendor Actual Confirmation is required (use the PIN checkbox in Housing Partner section).');
          return;
        }
        const id = req.id || 'DRAFT';
        const wb = new ExcelJS.Workbook();
        wb.creator = 'LabourNet'; wb.created = new Date();
        const ws = wb.addWorksheet('Finance');
        // Column widths
        ws.columns = [
          { header:'Field', key:'field', width: 28 },
          { header:'Value', key:'value', width: 40 },
          { header:'', key:'spacer', width: 4 },
          { header:'Field', key:'field2', width: 28 },
          { header:'Value', key:'value2', width: 40 }
        ];

        // Title row
        ws.mergeCells('A1:E1');
        const title = ws.getCell('A1');
        title.value = 'LabourNet Housing – Vendor Actual Confirmation (Finance Sheet)';
        title.font = { bold: true, size: 14, color: { argb: 'FFFFFFFF' } };
        title.alignment = { vertical: 'middle', horizontal: 'center' };
        ws.getRow(1).height = 22;
        ws.getCell('A1').fill = { type:'pattern', pattern:'solid', fgColor:{ argb:'FFE56344' } };
        for (let c of ['B1','C1','D1','E1']) ws.getCell(c).fill = { type:'pattern', pattern:'solid', fgColor:{ argb:'FFE56344' } };

        // Helper to add a section header
        function addHeader(rowIdx, label){
          ws.mergeCells(rowIdx, 1, rowIdx, 5);
          const cell = ws.getCell(rowIdx, 1);
          cell.value = label;
          cell.font = { bold:true, color:{argb:'FFCBD6E2'} };
          cell.fill = { type:'pattern', pattern:'solid', fgColor:{argb:'FF1F2430'} };
          cell.alignment = { vertical:'middle', horizontal:'left' };
        }

        // Helper to add two-column row
        function addRow(r, l1, v1, l2, v2){
          const row = ws.addRow({ field: l1, value: v1, spacer: '', field2: l2 || '', value2: v2 || '' });
          row.getCell('field').font = { bold:true };
          row.getCell('field2').font = { bold:true };
          // Borders
          row.eachCell((cell, col) => {
            cell.border = { top:{style:'thin', color:{argb:'FF2B2F3B'}}, bottom:{style:'thin', color:{argb:'FF2B2F3B'}} };
          });
          return row;
        }

        let r = 2;
        addHeader(r++, 'Request Summary');
        addRow(null, 'Request ID', id, 'Client', req.clientName||'');
        addRow(null, 'Requestor', req.requestorName||'', 'Request Date', req.requestDate ? new Date(req.requestDate).toLocaleString('en-IN') : '');
        addRow(null, 'BV Approved On', req.approvals?.bv?.date ? new Date(req.approvals.bv.date).toLocaleString('en-IN') : '', 'SAHI Approved On', req.approvals?.sahi?.date ? new Date(req.approvals.sahi.date).toLocaleString('en-IN') : '');
        addRow(null, 'Vendor Agreement Date', req.approvals?.vendor?.date ? new Date(req.approvals.vendor.date).toLocaleString('en-IN') : '', 'Vendor Actual Confirm Date', req.approvals?.vendor?.actualConfirmDate ? new Date(req.approvals.vendor.actualConfirmDate).toLocaleString('en-IN') : '');

        r = ws.lastRow.number + 1; addHeader(r++, 'Actual Split (Beds)');
        const aExM = Number(req.approvals?.vendor?.actualExistM||0);
        const aExF = Number(req.approvals?.vendor?.actualExistF||0);
        const aNwM = Number(req.approvals?.vendor?.actualNewM||0);
        const aNwF = Number(req.approvals?.vendor?.actualNewF||0);
        const aTotM = Number(req.approvals?.vendor?.male||0);
        const aTotF = Number(req.approvals?.vendor?.female||0);
        addRow(null, 'Existing (M)', aExM, 'Existing (F)', aExF);
        addRow(null, 'New (M)', aNwM, 'New (F)', aNwF);
        addRow(null, 'Grand Total (M)', aTotM, 'Grand Total (F)', aTotF);

        r = ws.lastRow.number + 1; addHeader(r++, 'Property Details');
        const p = req.approvals?.vendor?.property || {};
        addRow(null, 'Owner/Property Name', p.ownerName||'', 'Cluster', p.cluster||'');
        addRow(null, 'State', p.state||'', 'City/District', p.city||'');
        addRow(null, 'Type of Accommodation', p.type||'', 'Client (readonly)', p.client||'');
        addRow(null, 'No. of Houses', Number(p.houses||0), 'No. of Rooms', Number(p.rooms||0));
        addRow(null, 'Accommodation Capacity (Beds)', Number(p.capacity||0), '', '');

        r = ws.lastRow.number + 1; addHeader(r++, 'Financials');
        const dep = Number(p.securityDeposit||0);
        const rent = Number(p.monthlyRent||0);
        const elec = Number(p.electricity||0);
        const water = Number(p.water||0);
        const cap = Math.max(0, Number(p.capacity||0));
        const totalMonthly = rent + elec + water;
        const interest = dep * 0.015;
        const landing = totalMonthly + interest;
        const perBedNoInt = cap ? (totalMonthly / cap) : 0;
        const perBedWithInt = cap ? (landing / cap) : 0;
        const nf = '#,##0.00';
        const row1 = addRow(null, 'Security Deposit', dep, 'Monthly Rent', rent); row1.getCell('value').numFmt = nf; row1.getCell('value2').numFmt = nf;
        const row2 = addRow(null, 'Monthly Electricity', elec, 'Monthly Water', water); row2.getCell('value').numFmt = nf; row2.getCell('value2').numFmt = nf;
        const row3 = addRow(null, 'Total Monthly (Rent+Elec+Water)', totalMonthly, '1.5% p.m. on Security', interest); row3.getCell('value').numFmt = nf; row3.getCell('value2').numFmt = nf;
        const row4 = addRow(null, 'Total Landing Cost (per month)', landing, '', ''); row4.getCell('value').numFmt = nf;
  const row5 = addRow(null, 'Cost/Bed (w/o Interest)', perBedNoInt, 'Cost/Bed (with Interest)', perBedWithInt); row5.getCell('value').numFmt = nf; row5.getCell('value2').numFmt = nf;

  // Finance extras
  r = ws.lastRow.number + 1; addHeader(r++, 'Finance Coordination');
  addRow(null, 'Payment Confirmed On', req.finance?.confirmDate ? new Date(req.finance.confirmDate).toLocaleString('en-IN') : '', '', '');
  addRow(null, 'Payment Amount', Number(req.finance?.amount||0), 'Payment TRN', req.finance?.trn || '');
  addRow(null, 'Details Shared with Finance On', req.finance?.vendorIntimationDate ? new Date(req.finance.vendorIntimationDate).toLocaleString('en-IN') : '', 'Finance Terms', req.finance?.terms || '');
  const hasPayProof = req.finance?.paymentProof ? 'Yes' : 'No';
  const hasRentDoc = req.final?.rentalTermsDoc ? 'Yes' : 'No';
  addRow(null, 'Payment Proof Attached', hasPayProof, 'Rental Terms Doc Attached', hasRentDoc);

        // Footer note
        const foot = ws.addRow(['Note: Computations use current values from the drawer. Ensure they are correct before sharing with Finance.']);
        ws.mergeCells(foot.number, 1, foot.number, 5);
        foot.font = { italic:true, color:{argb:'FF9AA6B2'} };

        // Thin outline around data area
        const lastRow = ws.lastRow.number;
        for (let ri = 2; ri <= lastRow; ri++){
          for (let ci = 1; ci <= 5; ci++){
            const cell = ws.getCell(ri, ci);
            cell.border = cell.border || {};
            cell.border.left = cell.border.left || { style:'thin', color:{argb:'FF2B2F3B'} };
            cell.border.right = cell.border.right || { style:'thin', color:{argb:'FF2B2F3B'} };
          }
        }

        // Lock the sheet so editing requires a password
        await ws.protect('Shubham11', {
          selectLockedCells: true,
          selectUnlockedCells: true,
          formatCells: false,
          formatColumns: false,
          formatRows: false,
          insertRows: false,
          insertColumns: false,
          deleteRows: false,
          deleteColumns: false,
          sort: false,
          autoFilter: false,
          pivotTables: false
        });

        // Download
        const y = new Date(istNowMs());
        const ymd = `${y.getFullYear()}${String(y.getMonth()+1).padStart(2,'0')}${String(y.getDate()).padStart(2,'0')}`;
  let buf;
  try { buf = await wb.xlsx.writeBuffer(); }
  catch(err){ console.error('ExcelJS writeBuffer failed', err); throw err; }
  const blob = new Blob([buf], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `Finance_Onboarding_${id}_${ymd}.xlsx`;
  // Append to DOM to improve click reliability in some browsers
  document.body.appendChild(a); a.click(); setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); }, 0);
        showToast('Finance Excel downloaded');
      } catch(err){
        console.error('Export Finance Excel failed:', err);
        alert('Cannot export Excel: ' + (err?.message || err));
      }
    }

    // Timeline modal
    const timelineModal = qs('#timelineModal');
    function openTimeline(r){
      state.timelineForId = r.id;
      const items = buildTimelineItems(r);
      const list = qs('#timelineList'); list.innerHTML = '';
      items.forEach(it => {
        const div = document.createElement('div');
        div.className = 'v-item ' + (it.status || '');
  const dateHtml = it.date ? `<span class="date">${fmtDateTime(it.date)}</span>` : `<span class="date">—</span>`;
        const durPrev = it.dur ? `<span class="dur">+${it.dur}</span>` : '';
        const toNext = it.toNext ? `<span class="to-next">→ ${it.toNext}</span>` : '';
        const link = `<span class="step-link" data-step="${it.stepKey}">Open step</span>`;
        const beds = it.count ? `<span class=\"pill count\">${it.count.m}/${it.count.f}/${it.count.t}</span>` : '';
        div.innerHTML = `<div class="row"><span class="label">${it.label}</span>${dateHtml}${beds}${durPrev}${toNext} • ${link}</div>`;
        list.appendChild(div);
      });
      const totalTat = (r.final?.vendorReadyDate && r.requestDate) ? (daysBetween(r.requestDate, r.final.vendorReadyDate) + ' days') : '—';
      qs('#timelineSummary').innerHTML = `${r.id} • ${escapeHtml(r.requestorName)} • Requested ${fmtDate(r.requestDate)}<br/>Stage: ${computeStage(r).stage}`;
      const appr = computeApprovedTotals(r);
      const fin = computeFinalizedTotals(r);
      qs('#timelineTotals').innerHTML = `Total TAT: <b>${totalTat}</b><br/>Requested: ${r.beds.male}/${r.beds.female}/${r.beds.total}<br/>Approved ${appr.label}: ${appr.male}/${appr.female}/${appr.total}<br/>Finalized: ${fin.total>0 ? `${fin.male}/${fin.female}/${fin.total}` : '—'}`;
      qs('#timelineTitle').textContent = 'Timeline • ' + r.id;
      timelineModal.classList.add('open'); timelineModal.setAttribute('aria-hidden','false');
    }
    function closeTimeline(){ timelineModal.classList.remove('open'); timelineModal.setAttribute('aria-hidden','true'); }
    qs('#closeTimelineBtn').addEventListener('click', closeTimeline);
    qs('#printTimelineBtn').addEventListener('click', () => { window.print(); });
    timelineModal.addEventListener('click', (e) => { if (e.target === timelineModal) closeTimeline(); });

    function buildTimelineItems(r){
      const segs = [];
      const steps = [
        { key:'request', label:'Request Received', date: r.requestDate },
        { key:'bv', label:'BV Head (Suhail)', date: r.approvals?.bv?.date },
        { key:'sahi', label:'SAHI Head (Ashish)', date: r.approvals?.sahi?.date },
        { key:'vendorAck', label:'Vendor Acknowledgement', date: r.approvals?.vendor?.ackDate },
        { key:'vendor', label:'Housing Partner Agreement', date: r.approvals?.vendor?.date },
        { key:'vendorActualConfirm', label:'Vendor Actual Confirmation', date: r.approvals?.vendor?.actualConfirmDate },
        { key:'vendorIntimation', label:'Partner Intimation to Finance', date: r.finance?.vendorIntimationDate },
        { key:'finConfirm', label:'Finance Confirmation', date: r.finance?.confirmDate },
  { key:'payment', label:'Finance Confirmation', date: r.finance?.confirmDate },
        { key:'ready', label:'Move-in Ready', date: r.final?.vendorReadyDate }
      ];
      // build items with duration from previous
      let prevDate = null;
      for (let i=0;i<steps.length;i++){
        const s = steps[i];
        const dur = s.date && prevDate ? (daysBetween(prevDate, s.date)+'d') : null;
        const count = stageCountsFor(r, s.key);
        segs.push({ label: s.label, stepKey: s.key, date: s.date||'', dur, status: s.date ? 'done' : 'pending', count });
        if (s.date) prevDate = s.date;
      }
      // compute TAT to next
      for (let i=0;i<segs.length;i++){
        const thisDate = segs[i].date || null;
        const nextDate = (i < segs.length-1) ? (segs[i+1].date || null) : null;
        if (thisDate) {
          segs[i].toNext = nextDate ? (daysBetween(thisDate, nextDate)+'d') : (daysBetween(thisDate, todayISO())+'d');
        } else {
          segs[i].toNext = null;
        }
      }
      return segs;
    }

    function stageCountsFor(r, stepKey){
      // Requested at request; show approved at each approval; payment/ready keep vendor totals
      switch(stepKey){
        case 'request': return { m: Number(r.beds?.male||0), f: Number(r.beds?.female||0), t: Number(r.beds?.total||0) };
        case 'bv': {
          const a = r.approvals?.bv; return a ? { m:Number(a.male||0), f:Number(a.female||0), t:Number(a.male||0)+Number(a.female||0) } : null;
        }
        case 'sahi': {
          const a = r.approvals?.sahi; return a ? { m:Number(a.male||0), f:Number(a.female||0), t:Number(a.male||0)+Number(a.female||0) } : null;
        }
        case 'vendorAck': {
          const v = r.approvals?.vendor; if (!v) return null;
          const m = Number(v.tentativeM||0), f = Number(v.tentativeF||0); return (m+f>0) ? { m, f, t: m+f } : null;
        }
        case 'vendor': {
          const a = r.approvals?.vendor; return a ? { m:Number(a.male||0), f:Number(a.female||0), t:Number(a.male||0)+Number(a.female||0) } : null;
        }
        case 'vendorActualConfirm': {
          const a = r.approvals?.vendor; return a ? { m:Number(a.male||0), f:Number(a.female||0), t:Number(a.male||0)+Number(a.female||0) } : null;
        }
        case 'vendorIntimation': {
          const a = r.approvals?.vendor; return a ? { m:Number(a.male||0), f:Number(a.female||0), t:Number(a.male||0)+Number(a.female||0) } : null;
        }
        case 'finConfirm': {
          const a = r.approvals?.vendor; return a ? { m:Number(a.male||0), f:Number(a.female||0), t:Number(a.male||0)+Number(a.female||0) } : null;
        }
        case 'payment': {
          const a = r.approvals?.vendor; return a ? { m:Number(a.male||0), f:Number(a.female||0), t:Number(a.male||0)+Number(a.female||0) } : null;
        }
        case 'ready': {
          // finalized counts: bounded by requested
          const vm = Number(r.approvals?.vendor?.male||0), vf = Number(r.approvals?.vendor?.female||0);
          const tm = Math.min(vm, Number(r.beds?.male||0));
          const tf = Math.min(vf, Number(r.beds?.female||0));
          return { m: tm, f: tf, t: tm+tf };
        }
        default: return null;
      }
    }

    function computeApprovedTotals(r){
      // Use the latest approval stage that exists to summarize approved M/F/Total and stage label
      const order = [
        { key: 'vendor', label: 'by Housing Partner' },
        { key: 'sahi', label: 'by SAHI Head (Ashish)' },
        { key: 'bv', label: 'by BV Head (Suhail)' },
      ];
      for (const s of order){
        const a = r.approvals?.[s.key];
        if (a && a.date) {
          const male = Number(a.male||0); const female = Number(a.female||0); const total = male+female;
          return { male, female, total, label: s.label };
        }
      }
      return { male: 0, female: 0, total: 0, label: '—' };
    }

    function computeFinalizedTotals(r){
      // After payment or ready, treat vendor approved totals as finalized (bounded by requested)
      const stage = computeStage(r).stage;
      if (stage === 'Approvals') return { male:0, female:0, total:0 };
      const vm = Number(r.approvals?.vendor?.male||0), vf = Number(r.approvals?.vendor?.female||0);
      const tm = Math.min(vm, Number(r.beds?.male||0));
      const tf = Math.min(vf, Number(r.beds?.female||0));
      return { male: tm, female: tf, total: tm+tf };
    }

    // timeline interactions -> open corresponding step in drawer
    timelineModal.addEventListener('click', (e) => {
      const link = e.target.closest('.step-link');
      if (!link) return;
      const key = link.getAttribute('data-step');
      const r = state.requests.find(x => x.id === state.timelineForId);
      if (!r) return;
      closeTimeline();
      state.selectedId = r.id;
      populateDrawer(r);
      const selector = stepKeyToSelector(key);
      if (selector) setTimeout(() => { const el = qs(selector); if (el) { el.scrollIntoView({behavior:'smooth', block:'center'}); el.focus({preventScroll:true}); } }, 120);
    });

    function stepKeyToSelector(key){
      switch(key){
        case 'request': return '#reqDate';
        case 'bv': return '#apprBVDate';
        case 'sahi': return '#apprSAHIDate';
        // removed finhead
        case 'vendor': return '#apprVendorDate';
        case 'vendorIntimation': return '#vendorIntimationDate';
        case 'finConfirm': return '#finConfirmDate';
  case 'payment': return '#finConfirmDate';
        case 'ready': return '#finalVendorReadyDate';
        default: return null;
      }
    }

    // Safeguard for date input enhancements (placeholder)
    function enhanceDateInputs() {}

    // Ensure initialization runs after DOM is fully parsed
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>


